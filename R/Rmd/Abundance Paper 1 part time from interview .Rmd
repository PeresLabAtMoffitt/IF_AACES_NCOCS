---
title: "Immune marker time to interview"
author: "Christelle Colin-Leitzinger"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: cerulean #darkly
    highlight: pygments
    df_print: paged
editor_options: 
  chunk_output_type: console
---

<style type="text/css">
h1.title {
  font-size: 25px;
}
.figure {
   margin-top: 25px;
   <!-- margin-bottom: 100px; -->
}

table {
    margin-top: 25px;
    <!-- margin-bottom: 100px !important; -->
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      # fig.width = 7, fig.height = 5, 
                      fig.align='center'#, fig.show='hold'
                      )
options(gtsummary.print_engine = "gt")
options(gtsummary.as_gt.addl_cmds = "gt::tab_options(table.font.size = 14, data_row.padding = gt::px(1))")
```

<style>
div.blue { background-color:#0099CC; border-radius: 5px; padding: 20px; font-size: 38px}
</style>
<div class = "blue">

<span style="color: white;">Manuscript draft</span>

</div>
<br>

```{r library, include=FALSE}
# library(drake)
library(tidyverse)
library(data.table)
# library(VennDiagram)
library(gtsummary)
library(survival)
library(survminer)
library(psych)
# library(corrplot)
# library(ggcorrplot)
library(mclust)
library(sensemakr)
library(gplots)
library(ggridges)
library(ComplexHeatmap)
```

```{r load}
# loadd(clinical_data, ROI_tumor ,ROI_stroma ,ROI_total,
#       cases_match)

# Remove these IDs from whole data because 2 are NAs in BMI and 2 are there matched
# remove_id_bmi <- paste0(c("45142", "45809", "181810", "42204"), collapse = "|")

ROI_global <- readRDS("/Users/colinccm/Documents/GitHub/Peres/IF_AACES_NCOCS/ROI_global.rds")
clinical_data <- readRDS("/Users/colinccm/Documents/GitHub/Peres/IF_AACES_NCOCS/clinical_data.rds")

# Rewove patients not matched or lost match
ROI_global <- left_join(ROI_global, clinical_data, by="suid") %>%
  filter(!image_tag %in% c("Peres_P1_150163  3D_[44113,18531].tif", 
                           "Peres_P1_43004 A2_[45654,5840].tif",
                           "Peres_P1_43773 D2_[60849,15244].tif", 
                         "Peres_P1_AACES 130033_[37754,17929].tif",
                         "Peres_P1_AACES 130033_[38351,13944].tif"
                           )) %>% 
  select(suid, pair_id, everything()) %>% 
  drop_na(pair_id) %>% 
  group_by(pair_id) %>% 
  mutate(have_a_match = dense_rank(interaction(suid, pair_id))) %>% 
  group_by(pair_id) %>% 
  mutate(is_paired = max(have_a_match)) %>% 
  filter(is_paired == 2) %>% 
  select(pair_id, everything(), -c(is_paired, have_a_match)) %>% 
  ungroup()

# markers_match <- readRDS("/Users/colinccm/Documents/GitHub/Peres/IF_AACES_NCOCS/markers_match.rds")
path <- fs::path("","Volumes","Peres_Research","Christelle Colin-Leitzinger", "IF_AACES_NCOCS", "Disparities manuscript", "Figures")

# Remove these IDs from peripheral ROI because 2 are NAs and 2 are there matched
remove_id <- paste0(c("110318", "43220", "42774", "46619"), collapse = "|")
```
<br>
<br>

***

# Supp. ICC

```{r}
new_icc <- function(ROI_global) {
  icc_overall <- ROI_global %>%
    select(suid, image_tag,
           contains("percent"))
  class(icc_overall) <- "data.frame"
  
  icc_intrat <- ROI_global %>%
    filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>%
    select(suid, image_tag,
           contains("percent"))
  class(icc_intrat) <- "data.frame"
  
  icc_periph <- ROI_global %>%
    filter(intratumoral_i_vs_peripheral_p_ == "Peripheral") %>%
    select(suid, image_tag,
           contains("percent"))
  class(icc_periph) <- "data.frame"
  
  fct_icc <- function(data) {
    ICC_data <- data.frame(matrix(nrow = 1, ncol = 0))
    lb_data <- data.frame(matrix(nrow = 1, ncol = 0))
    up_data <- data.frame(matrix(nrow = 1, ncol = 0))
    for (i in 1:length(colnames(data))) {
      rad <- data %>% select(suid)
      
      if (class(data[, i]) == "numeric" |
          class(data[, i]) == "integer") {
        ICC_df <- cbind(rad, value = data[, i])
        ICC_df <- ICC_df %>%
          mutate(Slide = "Slide0") %>%
          group_by(suid) %>%
          mutate(n = row_number(suid)) %>%
          ungroup() %>%
          unite(slide_id, Slide:n, sep = "", remove = TRUE, na.rm = TRUE) %>%
          pivot_wider(names_from = slide_id, values_from = value) %>%
          select(c(starts_with("slide")))
        
        ICC <- ICC(ICC_df)$results[4, 2]
        ICC_data <- cbind(ICC_data, ICC)
        ICC <- ICC(ICC_df)$results[4, 7]
        lb_data <- cbind(lb_data, ICC)
        ICC <- ICC(ICC_df)$results[4, 8]
        up_data <- cbind(up_data, ICC)
        
      }
      
    }
    ICCC_data <- bind_rows(ICC_data, lb_data, up_data)
    colnames(ICCC_data) <- colnames(data)[3:ncol(data)]
    ICCC_data <- as.data.frame(t(ICCC_data)) %>%
      mutate(ICC_lb_up = paste(round(V1, 2), " (", round(V2, 2), ", ", round(V3, 2), ")", sep = "")) %>%
      select(ICC_lb_up)
  }
  
  icc_overall <-
    fct_icc(icc_overall) %>% rename(Overall = "ICC_lb_up")
  icc_intrat <-
    fct_icc(icc_intrat) %>% rename(Intratumoral = "ICC_lb_up")
  icc_periph <-
    fct_icc(icc_periph) %>% rename(Peripheral = "ICC_lb_up")
  
  icc_data <- cbind(icc_intrat, icc_periph)
  
}

b <- new_icc(ROI_global)
b
```
<br>
<br>

***

# Table 1.   Patient characteristics overall and by race/ethnicity

**Leave in the 4 patients no BMI for whole html**  
**All model are NOT adjusted for bmi, smoker and diab**

```{r}
tbl <- ROI_global %>% 
  distinct(suid, .keep_all = TRUE) %>% 
  select(refage, refage_cat, stage, BMI_recent, BMI_recent_grp,
        smoker, diab,
         dblkstat_CA125, adj,
        eur_prop, afr_prop, asian_prop,
        eurpc1, eurpc2, pc1, pc2,
         race) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
              label = list(refage ~ "Age at diagnosis", refage_cat ~ "Age at diagnosis category",
                           dblkstat_CA125 ~ "Debulking Status", adj ~ "Adjuvant chemotherapy",
                           smoker ~ "Smoking status"),
              type = list(diab ~ "categorical"),
              digits = list(all_continuous() ~ 1)) %>%
      modify_header(list(label ~ "**Patient characteristics**", all_stat_cols() ~ "**{level}**, N = {n}")) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% as_gt()
tbl
# gt::gtsave(tbl, paste0(path, "/Table 1 Patient characteristics overall and by race_ethnicity.pdf"))

ROI_i <- ROI_global %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral")
ROI_p <- ROI_global %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Peripheral")
```
<br>

# Ancestry

```{r}
ROI_global %>% 
  distinct(suid, .keep_all = TRUE) %>% 
  pivot_longer(cols = c(ends_with("_prop")), values_to = "ancestry_prop", names_to = "ancestry_group") %>% 
  ggplot(aes(x= race, y = ancestry_prop)) +
  geom_boxplot() +
  theme_classic() +
  facet_wrap(.~ ancestry_group)

ROI_global %>% 
  distinct(suid, .keep_all = TRUE) %>% 
  pivot_longer(cols = c(ends_with("_prop")), values_to = "ancestry_prop", names_to = "ancestry_group") %>% 
  # filter(!is.na(ancestry_prop)) %>% 
  ggplot(aes(x= suid, y = ancestry_prop, fill = ancestry_group)) +
  geom_col(position = "stack")

ROI_global %>% 
  distinct(suid, .keep_all = TRUE) %>% 
  pivot_longer(cols = c(ends_with("_prop")), values_to = "ancestry_prop", names_to = "ancestry_group") %>% 
  ggplot(aes(x= suid, y = ancestry_prop, fill = ancestry_group)) +
  geom_col(position = "stack") +
  facet_grid(.~ race, switch = "x", scales = "free", space = "free")+
  theme_classic()+
  theme(
    # panel.spacing.x = unit(0.1, "lines"),
    axis.text.x = element_blank(),
    panel.grid = element_blank()
  )

ROI_global %>% 
  distinct(suid, .keep_all = TRUE) %>% 
  pivot_longer(cols = c(ends_with("_prop")), values_to = "ancestry_prop", names_to = "ancestry_group") %>% 
  # filter(!is.na(ancestry_prop)) %>% 
  ggplot(aes(x= suid, y = ancestry_prop, fill = ancestry_group)) +
  geom_col(position = "stack") +
  # facet_grid(.~ race)+
  theme_void()+
  scale_y_continuous(#limits =c(1400, 2000),
                     breaks = c(0.25, 0.5, 0.75,1),
                     # labels = c(0, seq(1600, 2000, by = 200)),
                     expand = c(1, 0, 0, 0))+
  coord_polar("x", start=0, direction=-1)
 

ROI_global %>% 
  distinct(suid, .keep_all = TRUE) %>% 
  ggplot(aes(x = eurpc1, y = eurpc2, color = race))+
  geom_point() +
  theme_classic()

```
<br>


***

# Figure 1

<!-- **Leave 4 patients no BMI**   -->

Here each slide is represented (feed 3 values for intratumoral ROI and 3 values for peripheral ROI per patient)  
The average % tumor in the intratumoral ROIs is `r round(mean(ROI_i$percent_tumor),2)`% and `r round(mean(ROI_i$percent_stroma),2)`% stroma, while for the peripheral ROIs, the average% tumor is `r round(mean(ROI_p$percent_tumor),2)`% and `r round(mean(ROI_p$percent_stroma),2)`% for stroma** 

```{r}
p1 <- ROI_global %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  mutate(Tumor = "Tumor") %>% 
  mutate(Stroma = "Stroma") %>% 
  ggplot()+
  geom_violin(aes(x=Tumor, y=percent_tumor), scale = "count")+
  geom_boxplot(aes(x=Tumor, y=percent_tumor), width=.1) +
  geom_violin(aes(x=Stroma, y=percent_stroma), scale = "count") +
  geom_boxplot(aes(x=Stroma, y=percent_stroma), width=.1) +
  theme_classic2()+
  labs(x="Cell type", y=NULL, title="Intratumoral \nROIs")
p2 <- ROI_global %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Peripheral") %>% 
  mutate(Tumor = "Tumor") %>% 
  mutate(Stroma = "Stroma") %>% 
  ggplot()+
  geom_violin(aes(x=Tumor, y=percent_tumor), scale = "count")+
  geom_boxplot(aes(x=Tumor, y=percent_tumor), width=.1) +
  geom_violin(aes(x=Stroma, y=percent_stroma), scale = "count") +
  geom_boxplot(aes(x=Stroma, y=percent_stroma), width=.1) +
  theme_classic2()+
  labs(x="Cell type", y=NULL, title="Peripheral \nROIs")

# tiff(paste0(path, "/violin plot distribution tumor and stroma cells in ROIs intra-periph.tiff"))
gridExtra::grid.arrange(p1, p2, ncol = 2, 
                        top = "% of Cells Present in", left = "% Cells per samples", 
                        bottom = "Data on Race-Matched Patients")
# dev.off()
```
<br>

***
<br>

# Table 2. Distribution of immune cell abundance, immune signatures, and the immunoscore by race/ethnicity

Here I used the mean per patients

```{r summarize mean}
markers_ROIi <- ROI_global %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  group_by(suid) %>% 
  summarize(
    mean_tumor = mean(percent_tumor),
    mean_stroma = mean(percent_stroma),
    mean_total = mean(percent_total),
    # variance_tumor = var(percent_tumor),
    # variance_stroma = var(percent_stroma),
    percent_CD3_tumor = mean(tumor_percent_cd3_opal_650_positive_cells),
    percent_CD8_tumor = mean(tumor_percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_tumor = mean(tumor_percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_tumor = mean(tumor_percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_tumor = mean(tumor_percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_tumor = mean(tumor_percent_cd11b_opal_620_positive_cells),
    percent_CD15_tumor = mean(tumor_percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_tumor = mean(tumor_percent_cd11bplus_cd15plus_positive_cells),
    percent_CD3_stroma = mean(stroma_percent_cd3_opal_650_positive_cells),
    percent_CD8_stroma = mean(stroma_percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_stroma = mean(stroma_percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_stroma = mean(stroma_percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_stroma = mean(stroma_percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_stroma = mean(stroma_percent_cd11b_opal_620_positive_cells),
    percent_CD15_stroma = mean(stroma_percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_stroma = mean(stroma_percent_cd11bplus_cd15plus_positive_cells),
    
    percent_CD3_total = mean(percent_cd3_opal_650_positive_cells),
    percent_CD8_total = mean(percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_total = mean(percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_total = mean(percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_total = mean(percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_total = mean(percent_cd11b_opal_620_positive_cells),
    percent_CD15_total = mean(percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_total = mean(percent_cd11bplus_cd15plus_positive_cells)
  )
markers_ROIi$tumor_variation <- markers_ROIi$mean_tumor - mean(ROI_global$percent_tumor)
markers_ROIi$stroma_variation <- markers_ROIi$mean_stroma - mean(ROI_global$percent_stroma)
markers_ROIi$total_variation <- markers_ROIi$mean_stroma - mean(ROI_global$percent_stroma)
#
markers_ROIp <- ROI_global %>% 
  filter(!str_detect(suid, paste0(remove_id, collapse = "|")), 
         intratumoral_i_vs_peripheral_p_ == "Peripheral") %>% 
  group_by(suid) %>% 
  summarize(
    mean_tumor = mean(percent_tumor),
    mean_stroma = mean(percent_stroma),
    mean_total = mean(percent_total),
    # variance_tumor = var(percent_tumor),
    # variance_stroma = var(percent_stroma),
    percent_CD3_tumor = mean(tumor_percent_cd3_opal_650_positive_cells),
    percent_CD8_tumor = mean(tumor_percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_tumor = mean(tumor_percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_tumor = mean(tumor_percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_tumor = mean(tumor_percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_tumor = mean(tumor_percent_cd11b_opal_620_positive_cells),
    percent_CD15_tumor = mean(tumor_percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_tumor = mean(tumor_percent_cd11bplus_cd15plus_positive_cells),
    percent_CD3_stroma = mean(stroma_percent_cd3_opal_650_positive_cells),
    percent_CD8_stroma = mean(stroma_percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_stroma = mean(stroma_percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_stroma = mean(stroma_percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_stroma = mean(stroma_percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_stroma = mean(stroma_percent_cd11b_opal_620_positive_cells),
    percent_CD15_stroma = mean(stroma_percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_stroma = mean(stroma_percent_cd11bplus_cd15plus_positive_cells),
    percent_CD3_total = mean(percent_cd3_opal_650_positive_cells),
    percent_CD8_total = mean(percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_total = mean(percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_total = mean(percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_total = mean(percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_total = mean(percent_cd11b_opal_620_positive_cells),
    percent_CD15_total = mean(percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_total = mean(percent_cd11bplus_cd15plus_positive_cells)
  )
markers_ROIp$tumor_variation <- markers_ROIp$mean_tumor - mean(ROI_global$percent_tumor)
markers_ROIp$stroma_variation <- markers_ROIp$mean_stroma - mean(ROI_global$percent_stroma)
markers_ROIp$total_variation <- markers_ROIp$mean_total - mean(ROI_global$percent_total)

# Join Intratumoral and Peropheral ROI
markers_ROI <- full_join(markers_ROIi, markers_ROIp,
                         by= "suid", suffix= c(".i", ".p"))
markers_ROI <- left_join(markers_ROI, clinical_data, by="suid")
# clust_markers <- markers_ROI
```

The count of cells double stained (for example CD3+CD8+) are **NOT** subtracted from the single stain count (CD3 alone and CD8 alone).  
<!-- **Leave 4 patients no BMI**   -->
```{r Table tumor cells in ROIs}
# reset_gtsummary_theme()
# theme_gtsummary_journal(journal = "jama")
tbl1 <-
  markers_ROI %>% 
  select(percent_CD3_tumor.i, percent_CD3_CD8_tumor.i, percent_CD3_FoxP3_tumor.i, 
              percent_CD11b_tumor.i, percent_CD11b_CD15_tumor.i,
         race) %>% 
  rename(percent_CD3_tumor = percent_CD3_tumor.i, percent_CD3_CD8_tumor = percent_CD3_CD8_tumor.i,
         percent_CD3_FoxP3_tumor = percent_CD3_FoxP3_tumor.i, 
         percent_CD11b_tumor = percent_CD11b_tumor.i, percent_CD11b_CD15_tumor = percent_CD11b_CD15_tumor.i) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
              label = list(percent_CD3_tumor ~ "percent CD3+", percent_CD3_CD8_tumor ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_tumor ~ "percent CD3+/FoxP3+",
                           percent_CD11b_tumor ~ "percent CD11b+", percent_CD11b_CD15_tumor ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl2 <-
  markers_ROI %>% 
  select(percent_CD3_stroma.i, percent_CD3_CD8_stroma.i, percent_CD3_FoxP3_stroma.i, 
              percent_CD11b_stroma.i, percent_CD11b_CD15_stroma.i,
         race) %>% 
  rename(percent_CD3_stroma = percent_CD3_stroma.i, percent_CD3_CD8_stroma = percent_CD3_CD8_stroma.i,
         percent_CD3_FoxP3_stroma = percent_CD3_FoxP3_stroma.i, 
         percent_CD11b_stroma = percent_CD11b_stroma.i, percent_CD11b_CD15_stroma = percent_CD11b_CD15_stroma.i) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                           label = list(percent_CD3_stroma ~ "percent CD3+", percent_CD3_CD8_stroma ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_stroma ~ "percent CD3+/FoxP3+",
                           percent_CD11b_stroma ~ "percent CD11b+", percent_CD11b_CD15_stroma ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 
tbl3 <-
  markers_ROI %>% 
  select(percent_CD3_total.i, percent_CD3_CD8_total.i, percent_CD3_FoxP3_total.i, 
              percent_CD11b_total.i, percent_CD11b_CD15_total.i,
         race) %>% 
  rename(percent_CD3_total = percent_CD3_total.i, percent_CD3_CD8_total = percent_CD3_CD8_total.i,
         percent_CD3_FoxP3_total = percent_CD3_FoxP3_total.i, 
         percent_CD11b_total = percent_CD11b_total.i, percent_CD11b_CD15_total = percent_CD11b_CD15_total.i) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                           label = list(percent_CD3_total ~ "percent CD3+", percent_CD3_CD8_total ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_total ~ "percent CD3+/FoxP3+",
                           percent_CD11b_total ~ "percent CD11b+", percent_CD11b_CD15_total ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 


tbl5 <-
  markers_ROI %>% 
  select(percent_CD3_tumor.p, percent_CD3_CD8_tumor.p, percent_CD3_FoxP3_tumor.p, 
              percent_CD11b_tumor.p, percent_CD11b_CD15_tumor.p,
         race) %>% 
  rename(percent_CD3_tumor = percent_CD3_tumor.p, percent_CD3_CD8_tumor = percent_CD3_CD8_tumor.p,
         percent_CD3_FoxP3_tumor = percent_CD3_FoxP3_tumor.p, 
         percent_CD11b_tumor = percent_CD11b_tumor.p, percent_CD11b_CD15_tumor = percent_CD11b_CD15_tumor.p) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(percent_CD3_tumor ~ "percent CD3+", percent_CD3_CD8_tumor ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_tumor ~ "percent CD3+/FoxP3+",
                           percent_CD11b_tumor ~ "percent CD11b+", percent_CD11b_CD15_tumor ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl6 <-
  markers_ROI %>% 
  select(percent_CD3_stroma.p, percent_CD3_CD8_stroma.p, percent_CD3_FoxP3_stroma.p, 
              percent_CD11b_stroma.p, percent_CD11b_CD15_stroma.p,
         race) %>% 
  rename(percent_CD3_stroma = percent_CD3_stroma.p, percent_CD3_CD8_stroma = percent_CD3_CD8_stroma.p,
         percent_CD3_FoxP3_stroma = percent_CD3_FoxP3_stroma.p, 
         percent_CD11b_stroma = percent_CD11b_stroma.p, percent_CD11b_CD15_stroma = percent_CD11b_CD15_stroma.p) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(percent_CD3_stroma ~ "percent CD3+", percent_CD3_CD8_stroma ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_stroma ~ "percent CD3+/FoxP3+",
                           percent_CD11b_stroma ~ "percent CD11b+", percent_CD11b_CD15_stroma ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl7 <-
  markers_ROI %>% 
  select(percent_CD3_total.p, percent_CD3_CD8_total.p, percent_CD3_FoxP3_total.p, 
              percent_CD11b_total.p, percent_CD11b_CD15_total.p,
         race) %>% 
  rename(percent_CD3_total = percent_CD3_total.p, percent_CD3_CD8_total = percent_CD3_CD8_total.p,
         percent_CD3_FoxP3_total = percent_CD3_FoxP3_total.p, 
         percent_CD11b_total = percent_CD11b_total.p, percent_CD11b_CD15_total = percent_CD11b_CD15_total.p) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(percent_CD3_total ~ "percent CD3+", percent_CD3_CD8_total ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_total ~ "percent CD3+/FoxP3+",
                           percent_CD11b_total ~ "percent CD11b+", percent_CD11b_CD15_total ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 

tbl4 <- tbl_merge(list(tbl1, tbl5), tab_spanner = c("**Intratumoral**", "**Peripheral**"))
tbl8 <- tbl_merge(list(tbl2, tbl6), tab_spanner = c("**Intratumoral**", "**Peripheral**"))
tbl9 <- tbl_merge(list(tbl3, tbl7), tab_spanner = c("**Intratumoral**", "**Peripheral**"))


tbl10 <- tbl_stack(list(tbl4, tbl8, tbl9), group_header = c("Tumor", "Stroma", "Overall")) %>% as_gt()
tbl10

# gt::gtsave(tbl10, paste0(path, "/Table 2a Distribution of immune cell abundance in ROIs.pdf"))

# tbl8 <- tbl_stack(list(tbl5, tbl6, tbl7), group_header = c("Tumor", "Stroma", "Overall"))
# tbl8
# 
# tbl <- tbl_merge(list(tbl4, tbl8), tab_spanner = c("**Intratumoral**", "**Peripheral**"))# %>%
#   # modify_spanning_header(everything() ~ "Overall (tmor+stroma) ROIs") %>% as_gt()
# tbl
```
<br>

```{r}
# pdf(paste0(path, "/Boxplot stroma CD3CD8 peripheral.pdf"))
markers_ROI %>% 
  # select(percent_CD3_CD8_stroma.p, race) %>% 
  ggplot(aes(x= race, y = percent_CD3_CD8_stroma.p)) + 
  geom_boxplot(fill = "grey") +
  labs(x = "Race", y = "Percent Positivity") +
  theme_classic()
# dev.off()
```


## 2.Category with absent cells

Again, that is done without removing double stained from single.

```{r new median}
markers_ROI <- markers_ROI %>% 
  
  mutate(CD3_tumor.i = case_when(
    
    percent_CD3_tumor.i <= 1      ~ "low",
    percent_CD3_tumor.i > 1       ~ "high"
  ), CD3_tumor.i = factor(CD3_tumor.i, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_tumor.i = case_when(
    percent_CD3_CD8_tumor.i <= 1      ~ "low",
    percent_CD3_CD8_tumor.i > 1       ~ "high"
  ), CD3_CD8_tumor.i = factor(CD3_CD8_tumor.i, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_tumor.i = case_when(
    percent_CD3_FoxP3_tumor.i <= 1      ~ "low",
    percent_CD3_FoxP3_tumor.i > 1       ~ "high"
  ), CD3_FoxP3_tumor.i = factor(CD3_FoxP3_tumor.i, levels = c("low","high"))) %>% 
  mutate(CD11b_tumor.i = case_when(
    percent_CD11b_tumor.i == 0      ~ "Absence",
    percent_CD11b_tumor.i > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_tumor.i = case_when(
    percent_CD11b_CD15_tumor.i == 0      ~ "Absence",
    percent_CD11b_CD15_tumor.i > 0       ~ "Presence"
  )) %>% 
  
  mutate(CD3_stroma.i = case_when(
    percent_CD3_stroma.i <= 1      ~ "low",
    percent_CD3_stroma.i > 1       ~ "high"
  ), CD3_stroma.i = factor(CD3_stroma.i, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_stroma.i = case_when(
    percent_CD3_CD8_stroma.i <= 1      ~ "low",
    percent_CD3_CD8_stroma.i > 1       ~ "high"
  ), CD3_CD8_stroma.i = factor(CD3_CD8_stroma.i, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_stroma.i = case_when(
    percent_CD3_FoxP3_stroma.i <= 1      ~ "low",
    percent_CD3_FoxP3_stroma.i > 1       ~ "high"
  ), CD3_FoxP3_stroma.i = factor(CD3_FoxP3_stroma.i, levels = c("low","high"))) %>% 
  mutate(CD11b_stroma.i = case_when(
    percent_CD11b_stroma.i == 0      ~ "Absence",
    percent_CD11b_stroma.i > 0       ~ "Presence"
  )) %>%
  mutate(CD11b_CD15_stroma.i = case_when(
    percent_CD11b_CD15_stroma.i == 0      ~ "Absence",
    percent_CD11b_CD15_stroma.i > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_stroma.i3 = case_when(
    percent_CD11b_stroma.i <= 1      ~ "low",
    percent_CD11b_stroma.i > 1       ~ "high"
  ), CD11b_stroma.i3 = factor(CD11b_stroma.i3, levels = c("low","high"))) %>%
  mutate(CD11b_CD15_stroma.i3 = case_when(
    percent_CD11b_CD15_stroma.i <= 1      ~ "low",
    percent_CD11b_CD15_stroma.i > 1       ~ "high"
  ), CD11b_CD15_stroma.i3 = factor(CD11b_CD15_stroma.i3, levels = c("low","high"))) %>% 
  mutate(CD3_total.i = case_when(
    percent_CD3_total.i <= 1      ~ "low",
    percent_CD3_total.i > 1       ~ "high"
  ), CD3_total.i = factor(CD3_total.i, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_total.i = case_when(
    percent_CD3_CD8_total.i <= 1      ~ "low",
    percent_CD3_CD8_total.i > 1       ~ "high"
  ), CD3_CD8_total.i = factor(CD3_CD8_total.i, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_total.i = case_when(
    percent_CD3_FoxP3_total.i <= 1      ~ "low",
    percent_CD3_FoxP3_total.i > 1       ~ "high"
  ), CD3_FoxP3_total.i = factor(CD3_FoxP3_total.i, levels = c("low","high"))) %>% 
  mutate(CD11b_total.i = case_when(
    percent_CD11b_total.i == 0      ~ "Absence",
    percent_CD11b_total.i > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_total.i = case_when(
    percent_CD11b_CD15_total.i == 0      ~ "Absence",
    percent_CD11b_CD15_total.i > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_total.i3 = case_when(
    percent_CD11b_total.i <= 1      ~ "low",
    percent_CD11b_total.i > 1       ~ "high"
  ), CD11b_total.i3 = factor(CD11b_total.i3, levels = c("low","high"))) %>% 
  mutate(CD11b_CD15_total.i3 = case_when(
    percent_CD11b_CD15_total.i <= 1      ~ "low",
    percent_CD11b_CD15_total.i > 1       ~ "high"
  ), CD11b_CD15_total.i3 = factor(CD11b_CD15_total.i3, levels = c("low","high"))) %>% 
  
  
  mutate(CD3_tumor.p = case_when(
    percent_CD3_tumor.p <= 1      ~ "low",
    percent_CD3_tumor.p > 1       ~ "high"
  ), CD3_tumor.p = factor(CD3_tumor.p, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_tumor.p = case_when(
    percent_CD3_CD8_tumor.p <= 1      ~ "low",
    percent_CD3_CD8_tumor.p > 1       ~ "high"
  ), CD3_CD8_tumor.p = factor(CD3_CD8_tumor.p, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_tumor.p = case_when(
    percent_CD3_FoxP3_tumor.p <= 1      ~ "low",
    percent_CD3_FoxP3_tumor.p > 1       ~ "high"
  ), CD3_FoxP3_tumor.p = factor(CD3_FoxP3_tumor.p, levels = c("low","high"))) %>% 
  mutate(CD11b_tumor.p = case_when(
    percent_CD11b_tumor.p == 0      ~ "Absence",
    percent_CD11b_tumor.p > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_tumor.p = case_when(
    percent_CD11b_CD15_tumor.p == 0      ~ "Absence",
    percent_CD11b_CD15_tumor.p > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_tumor.p3 = case_when(
    percent_CD11b_tumor.p <= 1      ~ "low",
    percent_CD11b_tumor.p > 1         ~ "high"
  ), CD11b_tumor.p3 = factor(CD11b_tumor.p3, levels = c("low","high"))) %>% 
  mutate(CD11b_CD15_tumor.p3 = case_when(
    percent_CD11b_CD15_tumor.p <= 1      ~ "low",
    percent_CD11b_CD15_tumor.p > 1       ~ "high"
  ), CD11b_CD15_tumor.p3 = factor(CD11b_CD15_tumor.p3, levels = c("low","high"))) %>% 
  mutate(CD3_stroma.p = case_when(
    percent_CD3_stroma.p <= 1      ~ "low",
    percent_CD3_stroma.p > 1       ~ "high"
  ), CD3_stroma.p = factor(CD3_stroma.p, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_stroma.p = case_when(
    percent_CD3_CD8_stroma.p <= 1      ~ "low",
    percent_CD3_CD8_stroma.p > 1       ~ "high"
  ), CD3_CD8_stroma.p = factor(CD3_CD8_stroma.p, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_stroma.p = case_when(
    percent_CD3_FoxP3_stroma.p <= 1      ~ "low",
    percent_CD3_FoxP3_stroma.p > 1       ~ "high"
  ), CD3_FoxP3_stroma.p = factor(CD3_FoxP3_stroma.p, levels = c("low","high"))) %>% 
  mutate(CD11b_stroma.p = case_when(
    percent_CD11b_stroma.p == 0      ~ "Absence",
    percent_CD11b_stroma.p > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_stroma.p = case_when(
    percent_CD11b_CD15_stroma.p == 0      ~ "Absence",
    percent_CD11b_CD15_stroma.p > 0       ~ "Presence"
  )) %>% 
    mutate(CD11b_stroma.p3 = case_when(
    percent_CD11b_stroma.p <= 1      ~ "low",
    percent_CD11b_stroma.p > 1       ~ "high"
  ), CD11b_stroma.p3 = factor(CD11b_stroma.p3, levels = c("low","high"))) %>% 
  mutate(CD11b_CD15_stroma.p3 = case_when(
    percent_CD11b_CD15_stroma.p <= 1      ~ "low",
    percent_CD11b_CD15_stroma.p > 1       ~ "high"
  ), CD11b_CD15_stroma.p3 = factor(CD11b_CD15_stroma.p3, levels = c("low","high"))) %>% 
  mutate(CD3_total.p = case_when(
    percent_CD3_total.p <= 1      ~ "low",
    percent_CD3_total.p > 1       ~ "high"
  ), CD3_total.p = factor(CD3_total.p, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_total.p = case_when(
    percent_CD3_CD8_total.p <= 1      ~ "low",
    percent_CD3_CD8_total.p > 1       ~ "high"
  ), CD3_CD8_total.p = factor(CD3_CD8_total.p, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_total.p = case_when(
    percent_CD3_FoxP3_total.p <= 1      ~ "low",
    percent_CD3_FoxP3_total.p > 1       ~ "high"
  ), CD3_FoxP3_total.p = factor(CD3_FoxP3_total.p, levels = c("low","high"))) %>% 
  mutate(CD11b_total.p = case_when(
    percent_CD11b_total.p == 0      ~ "Absence",
    percent_CD11b_total.p > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_total.p = case_when(
    percent_CD11b_CD15_total.p == 0      ~ "Absence",
    percent_CD11b_CD15_total.p > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_total.p3 = case_when(
    percent_CD11b_total.p <= 1      ~ "low",
    percent_CD11b_total.p > 1       ~ "high"
  ), CD11b_total.p3 = factor(CD11b_total.p3, levels = c("low","high"))) %>% 
  mutate(CD11b_CD15_total.p3 = case_when(
    percent_CD11b_CD15_total.p <= 1      ~ "low",
    percent_CD11b_CD15_total.p > 1       ~ "high"
  ), CD11b_CD15_total.p3 = factor(CD11b_CD15_total.p3, levels = c("low","high"))) 



# for(i in 1:length(colnames(markers_ROI))) {
#   
#   
#   if(str_detect(markers_ROI[,i], "percent_CD|percent_Fox")) {
#     
#     markers_ROI <- markers_ROI %>%
#       mutate(.[,i] = case_when(
#     [,i] <= median([,i][[,i]>0])      ~ "low",
#     [,i] > median([,i][[,i]>0])      ~ "high",
#     [,i] == 0                         ~ "zero"
#   ))
#     
#     
#   }
#   print(markers_ROI[,i])
# }
# 
# for (v in colnames(df[ ,grepl(".x",names(df))])) {
#   print(v)
#   df$v <- ifelse(is.na(df$v), ols$coefficients[1]+ols$coefficients[2]*log(df$gsub(".x",".y",v)), df$v)
# }
```


```{r Table classification cells in ROIs}
tbl1 <-
  markers_ROI %>% 
  select(CD3_tumor.i, CD3_CD8_tumor.i, CD3_FoxP3_tumor.i, 
              CD11b_tumor.i, CD11b_CD15_tumor.i,
         race) %>% 
  rename(CD3_tumor = CD3_tumor.i, CD3_CD8_tumor = CD3_CD8_tumor.i,
         CD3_FoxP3_tumor = CD3_FoxP3_tumor.i, 
         CD11b_tumor = CD11b_tumor.i, CD11b_CD15_tumor = CD11b_CD15_tumor.i) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
              label = list(CD3_tumor ~ "percent CD3+", CD3_CD8_tumor ~ "percent CD3+/CD8+",
                           CD3_FoxP3_tumor ~ "percent CD3+/FoxP3+",
                           CD11b_tumor ~ "percent CD11b+", CD11b_CD15_tumor ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl2 <-
  markers_ROI %>% 
  select(CD3_stroma.i, CD3_CD8_stroma.i, CD3_FoxP3_stroma.i, 
              CD11b_stroma.i, CD11b_CD15_stroma.i,
race) %>% 
  rename(CD3_stroma = CD3_stroma.i, CD3_CD8_stroma = CD3_CD8_stroma.i,
         CD3_FoxP3_stroma = CD3_FoxP3_stroma.i, 
CD11b_stroma = CD11b_stroma.i, CD11b_CD15_stroma = CD11b_CD15_stroma.i) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                           label = list(CD3_stroma ~ "percent CD3+", CD3_CD8_stroma ~ "percent CD3+/CD8+",
                           CD3_FoxP3_stroma ~ "percent CD3+/FoxP3+",
                           CD11b_stroma ~ "percent CD11b+", CD11b_CD15_stroma ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 
tbl3 <-
  markers_ROI %>% 
  select(CD3_total.i, CD3_CD8_total.i, CD3_FoxP3_total.i, 
              CD11b_total.i, CD11b_CD15_total.i,
race) %>% 
  rename(CD3_total = CD3_total.i, CD3_CD8_total = CD3_CD8_total.i,
         CD3_FoxP3_total = CD3_FoxP3_total.i, 
CD11b_total = CD11b_total.i, CD11b_CD15_total = CD11b_CD15_total.i) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                           label = list(CD3_total ~ "percent CD3+", CD3_CD8_total ~ "percent CD3+/CD8+",
                           CD3_FoxP3_total ~ "percent CD3+/FoxP3+",
                           CD11b_total ~ "percent CD11b+", CD11b_CD15_total ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 


tbl5 <-
  markers_ROI %>% 
  select(CD3_tumor.p, CD3_CD8_tumor.p, CD3_FoxP3_tumor.p, 
              CD11b_tumor.p, CD11b_CD15_tumor.p,
race) %>% 
  rename(CD3_tumor = CD3_tumor.p, CD3_CD8_tumor = CD3_CD8_tumor.p,
         CD3_FoxP3_tumor = CD3_FoxP3_tumor.p, 
CD11b_tumor = CD11b_tumor.p, CD11b_CD15_tumor = CD11b_CD15_tumor.p) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(CD3_tumor ~ "percent CD3+", CD3_CD8_tumor ~ "percent CD3+/CD8+",
                           CD3_FoxP3_tumor ~ "percent CD3+/FoxP3+",
                           CD11b_tumor ~ "percent CD11b+", CD11b_CD15_tumor ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl6 <-
  markers_ROI %>% 
  select(CD3_stroma.p, CD3_CD8_stroma.p, CD3_FoxP3_stroma.p, 
              CD11b_stroma.p, CD11b_CD15_stroma.p,
race) %>% 
  rename(CD3_stroma = CD3_stroma.p, CD3_CD8_stroma = CD3_CD8_stroma.p,
         CD3_FoxP3_stroma = CD3_FoxP3_stroma.p, 
CD11b_stroma = CD11b_stroma.p, CD11b_CD15_stroma = CD11b_CD15_stroma.p) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(CD3_stroma ~ "percent CD3+", CD3_CD8_stroma ~ "percent CD3+/CD8+",
                           CD3_FoxP3_stroma ~ "percent CD3+/FoxP3+",
                           CD11b_stroma ~ "percent CD11b+", CD11b_CD15_stroma ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl7 <-
  markers_ROI %>% 
  select(CD3_total.p, CD3_CD8_total.p, CD3_FoxP3_total.p, 
              CD11b_total.p, CD11b_CD15_total.p,
race) %>% 
  rename(CD3_total = CD3_total.p, CD3_CD8_total = CD3_CD8_total.p,
         CD3_FoxP3_total = CD3_FoxP3_total.p, 
CD11b_total = CD11b_total.p, CD11b_CD15_total = CD11b_CD15_total.p) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(CD3_total ~ "percent CD3+", CD3_CD8_total ~ "percent CD3+/CD8+",
                           CD3_FoxP3_total ~ "percent CD3+/FoxP3+",
                           CD11b_total ~ "percent CD11b+", CD11b_CD15_total ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 

tbl4 <- tbl_merge(list(tbl1, tbl5), tab_spanner = c("**Intratumoral**", "**Peripheral**"))
tbl8 <- tbl_merge(list(tbl2, tbl6), tab_spanner = c("**Intratumoral**", "**Peripheral**"))
tbl9 <- tbl_merge(list(tbl3, tbl7), tab_spanner = c("**Intratumoral**", "**Peripheral**"))


tbl10 <- tbl_stack(list(tbl4, tbl8, tbl9), group_header = c("Tumor", "Stroma", "Overall")) %>% as_gt() %>% 
    gt::tab_source_note(gt::md('**"Low" represent categories with less than 1% immune cells detected while "Absent" represent categories with no immune cells detected**'))

tbl10
# gt::gtsave(tbl10, paste0(path, "/Table 2b Distribution of immune cell abundance absent_1percent categories in ROIs.pdf"))
```
<br>

***

# Immunoscore

Immunoscore calculated on the mean of the 3 value per patient.
```{r immunoscore per patients mean}
markers_ROI <- markers_ROI %>% 
  mutate(percentile_score_CD3_i = ntile(percent_CD3_total.i, 100) ) %>% 
  mutate(percentile_score_CD3_p = ntile(percent_CD3_total.p, 100) ) %>% 
  mutate(percentile_score_CD8_i = ntile(percent_CD8_total.i, 100) ) %>% 
  mutate(percentile_score_CD8_p = ntile(percent_CD8_total.p, 100) ) 

markers_ROI <- markers_ROI %>%
  mutate(percentile_score_mean = rowMeans( markers_ROI[c("percentile_score_CD3_i", "percentile_score_CD3_p", 
                                                    "percentile_score_CD8_i", "percentile_score_CD8_p")] ))
markers_ROI <- markers_ROI %>%
  mutate(immunoscore_patients = case_when(
    percentile_score_mean <= 10        ~ 0,
    percentile_score_mean <= 25        ~ 1,
    percentile_score_mean <= 70        ~ 2,
    percentile_score_mean <= 95        ~ 3,
    percentile_score_mean > 95         ~ 4 
  )) %>% 
  mutate(immunoscore_patients = factor(immunoscore_patients)) %>% 
  mutate(immunoscore_2018lancet_patients = case_when(
    percentile_score_mean <= 25        ~ "Low",
    percentile_score_mean <= 70        ~ "Intermediate",
    percentile_score_mean > 70         ~ "High"
    )) %>% 
  mutate(immunoscore_2018lancet_patients = factor(immunoscore_2018lancet_patients, levels = c("Low", "Intermediate", "High"))) 
```

```{r Table immunoscore}
tbl <- markers_ROI %>% 
  select(immunoscore_patients, immunoscore_2018lancet_patients,
         race) %>% 
  tbl_summary(by = race,
              label = list(immunoscore_patients ~ "classic immunoscore", 
                           immunoscore_2018lancet_patients ~ "immunoscore lancet"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% as_gt()
tbl
# gt::gtsave(tbl10, paste0(path, "/Table 2c Immunoscore in ROIs.pdf"))
```
<b>

***
<br>

# Cluster  


The count of cells double stained (for example CD3+CD8+) **ARE NOT** subtracted from the single stain count (CD3 alone and CD8 alone).  

```{r removing double stain from single stain count}
# markers_ROI <- markers_ROI %>% 
#   mutate(percent_CD3_total.i = percent_CD3_total.i - percent_CD3_CD8_total.i - percent_CD3_FoxP3_total.i) %>% 
#   mutate(percent_CD8_total.i = percent_CD8_total.i - percent_CD3_CD8_total.i) %>% 
#   mutate(percent_FoxP3_total.i = percent_FoxP3_total.i - percent_CD3_FoxP3_total.i) %>% 
#   mutate(percent_CD11b_total.i = percent_CD11b_total.i - percent_CD11b_CD15_total.i) %>% 
#   mutate(percent_CD15_total.i = percent_CD15_total.i - percent_CD11b_CD15_total.i) %>% 
#   
#   mutate(percent_CD3_tumor.i = percent_CD3_tumor.i - percent_CD3_CD8_tumor.i - percent_CD3_FoxP3_tumor.i) %>% 
#   mutate(percent_CD8_tumor.i = percent_CD8_tumor.i - percent_CD3_CD8_tumor.i) %>% 
#   mutate(percent_FoxP3_tumor.i = percent_FoxP3_tumor.i - percent_CD3_FoxP3_tumor.i) %>% 
#   mutate(percent_CD11b_tumor.i = percent_CD11b_tumor.i - percent_CD11b_CD15_tumor.i) %>% 
#   mutate(percent_CD15_tumor.i = percent_CD15_tumor.i - percent_CD11b_CD15_tumor.i) %>% 
#   
#   mutate(percent_CD3_stroma.i = percent_CD3_stroma.i - percent_CD3_CD8_stroma.i - percent_CD3_FoxP3_stroma.i) %>% 
#   mutate(percent_CD8_stroma.i = percent_CD8_stroma.i - percent_CD3_CD8_stroma.i) %>% 
#   mutate(percent_FoxP3_stroma.i = percent_FoxP3_stroma.i - percent_CD3_FoxP3_stroma.i) %>% 
#   mutate(percent_CD11b_stroma.i = percent_CD11b_stroma.i - percent_CD11b_CD15_stroma.i) %>% 
#   mutate(percent_CD15_stroma.i = percent_CD15_stroma.i - percent_CD11b_CD15_stroma.i) %>% 
#   
#   mutate(percent_CD3_total.p = percent_CD3_total.p - percent_CD3_CD8_total.p - percent_CD3_FoxP3_total.p) %>% 
#   mutate(percent_CD8_total.p = percent_CD8_total.p - percent_CD3_CD8_total.p) %>% 
#   mutate(percent_FoxP3_total.p = percent_FoxP3_total.p - percent_CD3_FoxP3_total.p) %>% 
#   mutate(percent_CD11b_total.p = percent_CD11b_total.p - percent_CD11b_CD15_total.p) %>% 
#   mutate(percent_CD15_total.p = percent_CD15_total.p - percent_CD11b_CD15_total.p) %>% 
#   
#   mutate(percent_CD3_tumor.p = percent_CD3_tumor.p - percent_CD3_CD8_tumor.p - percent_CD3_FoxP3_tumor.p) %>% 
#   mutate(percent_CD8_tumor.p = percent_CD8_tumor.p - percent_CD3_CD8_tumor.p) %>% 
#   mutate(percent_FoxP3_tumor.p = percent_FoxP3_tumor.p - percent_CD3_FoxP3_tumor.p) %>% 
#   mutate(percent_CD11b_tumor.p = percent_CD11b_tumor.p - percent_CD11b_CD15_tumor.p) %>% 
#   mutate(percent_CD15_tumor.p = percent_CD15_tumor.p - percent_CD11b_CD15_tumor.p) %>% 
#   
#   mutate(percent_CD3_stroma.p = percent_CD3_stroma.p - percent_CD3_CD8_stroma.p - percent_CD3_FoxP3_stroma.p) %>% 
#   mutate(percent_CD8_stroma.p = percent_CD8_stroma.p - percent_CD3_CD8_stroma.p) %>% 
#   mutate(percent_FoxP3_stroma.p = percent_FoxP3_stroma.p - percent_CD3_FoxP3_stroma.p) %>% 
#   mutate(percent_CD11b_stroma.p = percent_CD11b_stroma.p - percent_CD11b_CD15_stroma.p) %>% 
#   mutate(percent_CD15_stroma.p = percent_CD15_stroma.p - percent_CD11b_CD15_stroma.p)
```
<br>

## Cluster with a non-defined number of cluster **when looking at all intra/periph + tumor/stroma (CD3, CD3/8, CD3/FoxP3, CD11b, CD11b/15)**  
**Each markers are scaled, default method is center**  

<!-- **Leave 4 patients no BMI** -->

```{r clustering}
set.seed(1234)

### Cluster for stroma/tumor in the intratumoral/peritumoral ROIs 
clust_markers <- markers_ROI %>% 
  filter(!is.na(markers_ROI$percent_CD3_CD8_tumor.i) & !is.na(markers_ROI$percent_CD3_CD8_tumor.p)) %>% 
  select(suid, c("percent_CD3_tumor.i", "percent_CD3_CD8_tumor.i", "percent_CD3_FoxP3_tumor.i", "percent_CD11b_tumor.i", "percent_CD11b_CD15_tumor.i",
                 "percent_CD3_stroma.i", "percent_CD3_CD8_stroma.i", "percent_CD3_FoxP3_stroma.i", "percent_CD11b_stroma.i", "percent_CD11b_CD15_stroma.i",
                 "percent_CD3_tumor.p", "percent_CD3_CD8_tumor.p", "percent_CD3_FoxP3_tumor.p", "percent_CD11b_tumor.p", "percent_CD11b_CD15_tumor.p",
                 "percent_CD3_stroma.p", "percent_CD3_CD8_stroma.p", "percent_CD3_FoxP3_stroma.p", "percent_CD11b_stroma.p", "percent_CD11b_CD15_stroma.p"
                 ))

clust <- Mclust(scale(clust_markers[,c(2:ncol(clust_markers))]))
summary(clust)

X <- clust_markers[,-1]
BIC <- mclustBIC(X)
plot(BIC)
summary(BIC)

clust_markers$clusters_all_IandP <- clust$classification
# clust_markers$clusters_all_IandP <- factor(clust_markers$clusters_all_IandP,
#                                            levels = c(1, 2, 3),
#                                            labels = c("mid", "high", "low"))
clust_markers$clusters_all_IandP <- factor(clust_markers$clusters_all_IandP,
                                           levels = c(1, 2, 3, 4, 5),
                                           labels = c("mid", "high", "mid-high", "mid-low", "low"))
clust_markers <- clust_markers %>% mutate(clusters_all_IandP = factor(clusters_all_IandP, levels = c("low", "mid-low", "mid", "mid-high", "high")))
# clust_markers <- clust_markers %>% mutate(clusters_all_IandP = factor(clusters_all_IandP, levels = c("low", "mid", "high")))

clust_markers %>% 
tidyr::gather(key = "markers_cat", value = "value",
              c("percent_CD3_tumor.i":"percent_CD11b_CD15_stroma.i")) %>% 
  select(suid, clusters_all_IandP, markers_cat, value) %>% 
  ggplot(aes(x=suid, y=value, group=markers_cat,  color=markers_cat))+
  geom_boxplot()+
  facet_grid(.~ clusters_all_IandP)
clust_markers %>% 
tidyr::gather(key = "markers_cat", value = "value",
              c("percent_CD3_tumor.p":"percent_CD11b_CD15_stroma.p")) %>% 
  select(suid, clusters_all_IandP, markers_cat, value) %>% 
  ggplot(aes(x=suid, y=value, group=markers_cat,  color=markers_cat))+
  geom_boxplot()+
  facet_grid(.~ clusters_all_IandP)
markers_ROI <- full_join(markers_ROI, clust_markers %>% select(suid, clusters_all_IandP), by = "suid")


### Cluster for tumor intratumoral all double positive "percent_CD3_CD8_tumor.i", "percent_CD3_FoxP3_tumor.i", "percent_CD11b_CD15_tumor.i"
clust_markers <- markers_ROI %>% filter(!is.na(markers_ROI$percent_CD3_CD8_tumor.i ))
clust <- 
  Mclust(clust_markers[,c("percent_CD3_CD8_tumor.i", "percent_CD3_FoxP3_tumor.i", "percent_CD11b_CD15_tumor.i")])
summary(clust)
clust_markers$dbl_pos <- clust$classification
clust_markers$dbl_pos <- factor(clust_markers$dbl_pos,
                                           levels = c(1, 2, 3),
                                           labels = c("low", "high", "mid"))
clust_markers <- clust_markers %>% mutate(dbl_pos = factor(dbl_pos, levels = c("low", "mid", "high")))

### Cluster for tumor intratumoral CD3-CD8
clust <- Mclust(clust_markers$percent_CD3_CD8_tumor.i)
summary(clust)
clust_markers$clusters_CD3CD8 <- clust$classification
clust_markers$clusters_CD3CD8 <- factor(clust_markers$clusters_CD3CD8,
                                           levels = c(1, 2, 3, 4, 5),
                                           labels = c("low", "mid-low", "mid", "mid-high", "high"))

### Cluster for tumor intratumoral CD3-FoxP3
clust <- Mclust(clust_markers$percent_CD3_FoxP3_tumor.i)
summary(clust)
clust_markers$clusters_CD3FoxP3 <- clust$classification
clust_markers$clusters_CD3FoxP3 <- factor(clust_markers$clusters_CD3FoxP3,
                                           levels = c(1, 2, 3),
                                           labels = c("low", "mid", "high"))

### Cluster for tumor intratumoral FoxP3 because it can be expressed by tumor cell
clust <- Mclust(clust_markers$percent_FoxP3_tumor.i)
summary(clust)
clust_markers$clusters_FoxP3_ <- clust$classification
clust_markers$clusters_FoxP3_ <- factor(clust_markers$clusters_FoxP3_,
                                           levels = c(1, 2, 3, 4),
                                           labels = c("low", "mid", "mid-high", "high"))

### Cluster for tumor intratumoral CD11b/CD15 
clust <- Mclust(clust_markers$percent_CD11b_CD15_tumor.i)
summary(clust)
clust_markers$clusters_CD11bCD15 <- clust$classification
clust_markers$clusters_CD11bCD15 <- factor(clust_markers$clusters_CD11bCD15,
                                           levels = c(1, 7, 8),
                                           labels = c("low", "high", "mid"))
clust_markers <- clust_markers %>% mutate(clusters_CD11bCD15 = factor(clusters_CD11bCD15, levels = c("low", "mid", "high")))

markers_ROI <- full_join(markers_ROI, clust_markers %>% select(suid, dbl_pos, clusters_CD3CD8, clusters_CD3FoxP3, clusters_FoxP3_, clusters_CD11bCD15), by = "suid")

```
<br>

```{r Table cluster}
tbl <- markers_ROI %>% 
  select(clusters_all_IandP, dbl_pos, clusters_CD3CD8, clusters_CD3FoxP3, clusters_FoxP3_, clusters_CD11bCD15,
         race) %>% 
  tbl_summary(by = race,
              label = list(clusters_all_IandP ~ "intra+periph, tumor+stroma", dbl_pos ~ "all double positive",
                           clusters_CD3CD8 ~ "CD3+/CD8+",
                           clusters_CD3FoxP3 ~ "CD3+/FoxP3+", clusters_FoxP3_ ~ "FoxP3+",
                           clusters_CD11bCD15 ~ "CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% as_gt()
tbl
# gt::gtsave(tbl, paste0(path, "/Table 2d Cluster in ROIs.pdf"))
```

## Visualisation abundance in mclust groups

<!-- ### Normalizing with the median -->

```{r}
# df1 <- as.data.frame(markers_ROI[,c("percent_CD3_tumor.i", "percent_CD3_CD8_tumor.i", "percent_CD3_FoxP3_tumor.i", 
#                                     "percent_CD11b_tumor.i", "percent_CD11b_CD15_tumor.i",
#                                     "percent_CD3_stroma.i", "percent_CD3_CD8_stroma.i", "percent_CD3_FoxP3_stroma.i",
#                                     "percent_CD11b_stroma.i", "percent_CD11b_CD15_stroma.i",
#                                     "suid", "race", "clusters_all_IandP")]) %>% 
#   mutate(percent_CD3_tumor.i = (percent_CD3_tumor.i - median(percent_CD3_tumor.i, na.rm = TRUE))) %>% 
#   mutate(percent_CD3_CD8_tumor.i = (percent_CD3_CD8_tumor.i - median(percent_CD3_CD8_tumor.i, na.rm = TRUE))) %>% 
#   mutate(percent_CD3_FoxP3_tumor.i = (percent_CD3_FoxP3_tumor.i - median(percent_CD3_FoxP3_tumor.i, na.rm = TRUE))) %>% 
#   mutate(percent_CD11b_tumor.i = (percent_CD11b_tumor.i - median(percent_CD11b_tumor.i, na.rm = TRUE))) %>% 
#   mutate(percent_CD11b_CD15_tumor.i = (percent_CD11b_CD15_tumor.i - median(percent_CD11b_CD15_tumor.i, na.rm = TRUE))) %>% 
#   mutate(percent_CD3_stroma.i = (percent_CD3_stroma.i - median(percent_CD3_stroma.i, na.rm = TRUE))) %>% 
#   mutate(percent_CD3_CD8_stroma.i = (percent_CD3_CD8_stroma.i - median(percent_CD3_CD8_stroma.i, na.rm = TRUE))) %>% 
#   mutate(percent_CD3_FoxP3_stroma.i = (percent_CD3_FoxP3_stroma.i - median(percent_CD3_FoxP3_stroma.i, na.rm = TRUE))) %>% 
#   mutate(percent_CD11b_stroma.i = (percent_CD11b_stroma.i - median(percent_CD11b_stroma.i, na.rm = TRUE))) %>% 
#   mutate(percent_CD11b_CD15_stroma.i = (percent_CD11b_CD15_stroma.i - median(percent_CD11b_CD15_stroma.i, na.rm = TRUE))) %>% 
#   # mutate(across(where(is.numeric)), abs(. - median(CD3, na.rm = TRUE))
#   #        )
#   arrange(clusters_all_IandP, percent_CD3_stroma.i, percent_CD3_CD8_stroma.i) %>%
#   unite(suid, c(suid, race, clusters_all_IandP), sep = "_", remove = TRUE) %>%
#   `row.names<-`(.$suid) %>%
#   select(-c(suid, starts_with("CD")))
# 
# df2 <- t(scale((as.matrix(df1)))) # scale for standardizing the data to make variables comparable
# df2 <- df2[complete.cases(df2 * 0), , drop=FALSE]
# 
# # Create colors for cluster
# condition_colors <- unlist(lapply(rownames(df1), function(x){
#   if(grepl("White", x)) "#365D8DFF" # 0D0887FF 31688EFF
#   else if(grepl("Black", x)) "#FFEA46FF" # F0F921FF
# }))
# condition_colors1 <- unlist(lapply(rownames(df1), function(x){
#   case_when(
#     str_detect(x, "mid-low") ~ "#721F81FF",
#     str_detect(x, "mid-high") ~ "#FD9567FF",
#     str_detect(x, "low") ~ "#000004FF",
#     str_detect(x, "mid") ~ "#CD4071FF",
#     str_detect(x, "high") ~ "#FEC98DFF",
#     TRUE          ~ NA_character_)
# }))
# mycols <- cbind(condition_colors, condition_colors1, deparse.level = 2)
# colnames(mycols)[1] <- "reaceth"
# colnames(mycols)[2] <- "clust"
# 
# 
# heatmap.plus(df2, 
#              main = "Heatmap",
#              col = bluered(20),
#              cexRow = 1,
#              margins = c(1, 17), # bottom, right
#              ColSideColors = mycols,
#              scale = "column",
#              Rowv = NA, Colv = NA,
# )
```


### In the methods/caption for the figure need to say standardized by the median and MAD 
```{r}
# calculated_mad <- mad(as.matrix(markers_ROI[,c("percent_CD3_tumor.i", "percent_CD3_CD8_tumor.i", "percent_CD3_FoxP3_tumor.i", 
#                                  "percent_CD11b_tumor.i", "percent_CD11b_CD15_tumor.i",
#                                  "percent_CD3_stroma.i", "percent_CD3_CD8_stroma.i", "percent_CD3_FoxP3_stroma.i",
#                                  "percent_CD11b_stroma.i", "percent_CD11b_CD15_stroma.i")]))
# 
# df1 <- as.data.frame(markers_ROI[,c("percent_CD3_tumor.i", "percent_CD3_CD8_tumor.i", "percent_CD3_FoxP3_tumor.i", 
#                                     "percent_CD11b_tumor.i", "percent_CD11b_CD15_tumor.i",
#                                     "percent_CD3_stroma.i", "percent_CD3_CD8_stroma.i", "percent_CD3_FoxP3_stroma.i",
#                                     "percent_CD11b_stroma.i", "percent_CD11b_CD15_stroma.i",
#                                     "suid", "race", "clusters_all_IandP")]) %>% 
#   mutate(percent_CD3_tumor.i = (percent_CD3_tumor.i - median(percent_CD3_tumor.i, na.rm = TRUE))/
#            calculated_mad) %>% 
#   mutate(percent_CD3_CD8_tumor.i = (percent_CD3_CD8_tumor.i - median(percent_CD3_CD8_tumor.i, na.rm = TRUE))/
#            calculated_mad) %>% 
#   mutate(percent_CD3_FoxP3_tumor.i = (percent_CD3_FoxP3_tumor.i - median(percent_CD3_FoxP3_tumor.i, na.rm = TRUE))/
#            calculated_mad) %>% 
#   mutate(percent_CD11b_tumor.i = (percent_CD11b_tumor.i - median(percent_CD11b_tumor.i, na.rm = TRUE))/
#            calculated_mad) %>% 
#   mutate(percent_CD11b_CD15_tumor.i = (percent_CD11b_CD15_tumor.i - median(percent_CD11b_CD15_tumor.i, na.rm = TRUE))/
#            calculated_mad) %>% 
#   mutate(percent_CD3_stroma.i = (percent_CD3_stroma.i - median(percent_CD3_stroma.i, na.rm = TRUE))/
#            calculated_mad) %>% 
#   mutate(percent_CD3_CD8_stroma.i = (percent_CD3_CD8_stroma.i - median(percent_CD3_CD8_stroma.i, na.rm = TRUE))/
#            calculated_mad) %>% 
#   mutate(percent_CD3_FoxP3_stroma.i = (percent_CD3_FoxP3_stroma.i - median(percent_CD3_FoxP3_stroma.i, na.rm = TRUE))/
#            calculated_mad) %>% 
#   mutate(percent_CD11b_stroma.i = (percent_CD11b_stroma.i - median(percent_CD11b_stroma.i, na.rm = TRUE))/
#            calculated_mad) %>% 
#   mutate(percent_CD11b_CD15_stroma.i = (percent_CD11b_CD15_stroma.i - median(percent_CD11b_CD15_stroma.i, na.rm = TRUE))/
#            calculated_mad) %>% 
#   # mutate(across(where(is.numeric)), abs(. - median(CD3, na.rm = TRUE))
#   #        )
#   arrange(clusters_all_IandP, percent_CD3_stroma.i, percent_CD3_CD8_stroma.i) %>%
#   unite(suid, c(suid, race, clusters_all_IandP), sep = "_", remove = TRUE) %>%
#   `row.names<-`(.$suid) %>%
#   select(-c(suid, starts_with("CD")))
# 
# # Create colors for cluster
# condition_colors <- unlist(lapply(rownames(df1), function(x){
#   if(grepl("White", x)) "#365D8DFF" # 0D0887FF 31688EFF
#   else if(grepl("Black", x)) "#FFEA46FF" # F0F921FF
# }))
# condition_colors1 <- unlist(lapply(rownames(df1), function(x){
#   case_when(
#     str_detect(x, "mid-low") ~ "#721F81FF",
#     str_detect(x, "mid-high") ~ "#FD9567FF",
#     str_detect(x, "low") ~ "#000004FF",
#     str_detect(x, "mid") ~ "#CD4071FF",
#     str_detect(x, "high") ~ "#FEC98DFF",
#     TRUE          ~ NA_character_)
# }))
# mycols <- cbind(condition_colors, condition_colors1, deparse.level = 2)
# colnames(mycols)[1] <- "reaceth"
# colnames(mycols)[2] <- "clust"
# 
# df3 <- as.matrix(df1)
# heatmap.plus(t(df3), 
#              main = "Heatmap",
#              col = bluered(20),
#              cexRow = 1,
#              margins = c(1, 17), # bottom, right
#              ColSideColors = mycols,
#              scale = "none",
#              Rowv = NA, Colv = NA,
# )
# 
# heatmap.plus(t(df3), 
#              main = "Heatmap",
#              col = bluered(20),
#              cexRow = 1,
#              margins = c(1, 30), # bottom, right
#              ColSideColors = mycols,
#              scale = "none",
#              Rowv = NA,
#              revC =
# )
# 
# legend(0.85, 1, # right, up
#        legend = c("Recurrence", "No Recurrence"), 
#        fill = c("pink", "grey"), cex = 0.6,
#        bty = "n")
# legend(0.7, 1, # right, up
#        legend = c("low", "mid-low", "mid", "mid-high", "high"),
#        fill = c("#440154FF", "#3B528BFF", "#21908CFF", "#5DC863FF", "#FDE725FF"), cex = 0.6,
#        bty = "n")
```

#### Intratumoral
```{r heatmap intra, fig.width=12}
marker.exp <- markers_ROI[,c("suid", "percent_CD3_tumor.i", "percent_CD3_CD8_tumor.i", "percent_CD3_FoxP3_tumor.i", 
                               "percent_CD11b_tumor.i", "percent_CD11b_CD15_tumor.i",
                               "percent_CD3_stroma.i", "percent_CD3_CD8_stroma.i", "percent_CD3_FoxP3_stroma.i",
                               "percent_CD11b_stroma.i", "percent_CD11b_CD15_stroma.i",
                               "race", "clusters_all_IandP")] %>% 
  arrange(clusters_all_IandP, percent_CD3_stroma.i, percent_CD3_tumor.i, percent_CD3_FoxP3_tumor.i, percent_CD11b_CD15_tumor.i) 
marker.exp1 <- marker.exp %>%
  unite(suid, c(suid, race, clusters_all_IandP), sep = "_", remove = TRUE) %>%
  `row.names<-`(.$suid) %>%
  select(-c(suid, starts_with("CD")))

sqrt.markers <- sqrt(marker.exp1[,c(1:length(marker.exp1))])

z_sqrt.markers <- sqrt.markers %>% 
  mutate(mad_percent_CD3_tumor.i = mad((percent_CD3_tumor.i)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD3_CD8_tumor.i = mad((percent_CD3_CD8_tumor.i)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD3_FoxP3_tumor.i = mad((percent_CD3_FoxP3_tumor.i)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD11b_tumor.i = mad((percent_CD11b_tumor.i)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD11b_CD15_tumor.i = mad((percent_CD11b_CD15_tumor.i)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD3_stroma.i = mad((percent_CD3_stroma.i)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD3_CD8_stroma.i = mad((percent_CD3_CD8_stroma.i)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD3_FoxP3_stroma.i = mad((percent_CD3_FoxP3_stroma.i)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD11b_stroma.i = mad((percent_CD11b_stroma.i)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD11b_CD15_stroma.i = mad((percent_CD11b_CD15_stroma.i)) + 0.0001
  ) %>% 
  
  mutate(z_CD3_tumor.i = (percent_CD3_tumor.i - median(percent_CD3_tumor.i, na.rm = TRUE))/
           mad_percent_CD3_tumor.i) %>% 
  mutate(z_CD3_CD8_tumor.i = (percent_CD3_CD8_tumor.i - median(percent_CD3_CD8_tumor.i, na.rm = TRUE))/
           mad_percent_CD3_CD8_tumor.i) %>% 
  mutate(z_CD3_FoxP3_tumor.i = (percent_CD3_FoxP3_tumor.i - median(percent_CD3_FoxP3_tumor.i, na.rm = TRUE))/
           mad_percent_CD3_FoxP3_tumor.i) %>% 
  mutate(z_CD11b_tumor.i = (percent_CD11b_tumor.i - median(percent_CD11b_tumor.i, na.rm = TRUE))/
           mad_percent_CD11b_tumor.i) %>% 
  mutate(z_CD11b_CD15_tumor.i = (percent_CD11b_CD15_tumor.i - median(percent_CD11b_CD15_tumor.i, na.rm = TRUE))/
           mad_percent_CD11b_CD15_tumor.i) %>% 
  mutate(z_CD3_stroma.i = (percent_CD3_stroma.i - median(percent_CD3_stroma.i, na.rm = TRUE))/
           mad_percent_CD3_stroma.i) %>% 
  mutate(z_CD3_CD8_stroma.i = (percent_CD3_CD8_stroma.i - median(percent_CD3_CD8_stroma.i, na.rm = TRUE))/
           mad_percent_CD3_CD8_stroma.i) %>% 
  mutate(z_CD3_FoxP3_stroma.i = (percent_CD3_FoxP3_stroma.i - median(percent_CD3_FoxP3_stroma.i, na.rm = TRUE))/
           mad_percent_CD3_FoxP3_stroma.i) %>% 
  mutate(z_CD11b_stroma.i = (percent_CD11b_stroma.i - median(percent_CD11b_stroma.i, na.rm = TRUE))/
           mad_percent_CD11b_stroma.i) %>% 
  mutate(z_CD11b_CD15_stroma.i = (percent_CD11b_CD15_stroma.i - median(percent_CD11b_CD15_stroma.i, na.rm = TRUE))/
           mad_percent_CD11b_CD15_stroma.i) %>% 
  select(c(starts_with("z_")))

df5 <- t(scale(as.matrix(z_sqrt.markers))) # scale for standardizing the data to make variables comparable

column_ho = HeatmapAnnotation(race = c(marker.exp$race),
                              clus = (marker.exp$clusters_all_IandP), 
                              col = list(race = c("White" = "#932667FF", "Black" = "grey"),
                                         clus = c("low" = "#440154FF", "mid-low"= "#3B528BFF", 
                                                 "mid" = "#21908CFF", 
                                                  "mid-high"= "#5DC863FF", "high" = "#FDE725FF")
                                         ),
    na_col = "black")
Heatmap(df5, name = " ",
        cluster_rows = FALSE, cluster_columns = FALSE,
        top_annotation = column_ho)

column_ho = HeatmapAnnotation(race = c(marker.exp$race),
                              col = list(race = c("White" = "#932667FF", "Black" = "grey")),
    na_col = "black")
Heatmap(df5, name = " ",
        cluster_rows = FALSE,
        top_annotation = column_ho)

```

#### Peritumoral
```{r heatmap peri, fig.width=12}
marker.exp <- markers_ROI[,c("suid", "percent_CD3_tumor.p", "percent_CD3_CD8_tumor.p", "percent_CD3_FoxP3_tumor.p", 
                               "percent_CD11b_tumor.p", "percent_CD11b_CD15_tumor.p",
                               "percent_CD3_stroma.p", "percent_CD3_CD8_stroma.p", "percent_CD3_FoxP3_stroma.p",
                               "percent_CD11b_stroma.p", "percent_CD11b_CD15_stroma.p",
                               "race", "clusters_all_IandP")] %>% 
    drop_na(-suid) %>% 
  arrange(clusters_all_IandP, percent_CD3_stroma.p, percent_CD3_tumor.p, percent_CD3_FoxP3_tumor.p, percent_CD11b_CD15_tumor.p) 
marker.exp1 <- marker.exp %>%
  unite(suid, c(suid, race, clusters_all_IandP), sep = "_", remove = TRUE) %>%
  `row.names<-`(.$suid) %>%
  select(-c(suid, starts_with("CD")))

sqrt.markers <- sqrt(marker.exp1[,c(1:length(marker.exp1))])

z_sqrt.markers <- sqrt.markers %>% 
  mutate(mad_percent_CD3_tumor.p = mad((percent_CD3_tumor.p)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD3_CD8_tumor.p = mad((percent_CD3_CD8_tumor.p)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD3_FoxP3_tumor.p = mad((percent_CD3_FoxP3_tumor.p)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD11b_tumor.p = mad((percent_CD11b_tumor.p)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD11b_CD15_tumor.p = mad((percent_CD11b_CD15_tumor.p)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD3_stroma.p = mad((percent_CD3_stroma.p)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD3_CD8_stroma.p = mad((percent_CD3_CD8_stroma.p)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD3_FoxP3_stroma.p = mad((percent_CD3_FoxP3_stroma.p)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD11b_stroma.p = mad((percent_CD11b_stroma.p)) + 0.0001
  ) %>% 
  mutate(mad_percent_CD11b_CD15_stroma.p = mad((percent_CD11b_CD15_stroma.p)) + 0.0001
  ) %>% 
  
  mutate(z_CD3_tumor.p = (percent_CD3_tumor.p - median(percent_CD3_tumor.p, na.rm = TRUE))/
           mad_percent_CD3_tumor.p) %>% 
  mutate(z_CD3_CD8_tumor.p = (percent_CD3_CD8_tumor.p - median(percent_CD3_CD8_tumor.p, na.rm = TRUE))/
           mad_percent_CD3_CD8_tumor.p) %>% 
  mutate(z_CD3_FoxP3_tumor.p = (percent_CD3_FoxP3_tumor.p - median(percent_CD3_FoxP3_tumor.p, na.rm = TRUE))/
           mad_percent_CD3_FoxP3_tumor.p) %>% 
  mutate(z_CD11b_tumor.p = (percent_CD11b_tumor.p - median(percent_CD11b_tumor.p, na.rm = TRUE))/
           mad_percent_CD11b_tumor.p) %>% 
  mutate(z_CD11b_CD15_tumor.p = (percent_CD11b_CD15_tumor.p - median(percent_CD11b_CD15_tumor.p, na.rm = TRUE))/
           mad_percent_CD11b_CD15_tumor.p) %>% 
  mutate(z_CD3_stroma.p = (percent_CD3_stroma.p - median(percent_CD3_stroma.p, na.rm = TRUE))/
           mad_percent_CD3_stroma.p) %>% 
  mutate(z_CD3_CD8_stroma.p = (percent_CD3_CD8_stroma.p - median(percent_CD3_CD8_stroma.p, na.rm = TRUE))/
           mad_percent_CD3_CD8_stroma.p) %>% 
  mutate(z_CD3_FoxP3_stroma.p = (percent_CD3_FoxP3_stroma.p - median(percent_CD3_FoxP3_stroma.p, na.rm = TRUE))/
           mad_percent_CD3_FoxP3_stroma.p) %>% 
  mutate(z_CD11b_stroma.p = (percent_CD11b_stroma.p - median(percent_CD11b_stroma.p, na.rm = TRUE))/
           mad_percent_CD11b_stroma.p) %>% 
  mutate(z_CD11b_CD15_stroma.p = (percent_CD11b_CD15_stroma.p - median(percent_CD11b_CD15_stroma.p, na.rm = TRUE))/
           mad_percent_CD11b_CD15_stroma.p) %>% 
  select(c(starts_with("z_")))

df6 <- t(scale(as.matrix(z_sqrt.markers))) # scale for standardizing the data to make variables comparable

column_peri = HeatmapAnnotation(race = c(marker.exp$race),
                              clus = (marker.exp$clusters_all_IandP), 
                              col = list(race = c("White" = "#932667FF", "Black" = "grey"),
                                         clus = c("low" = "#440154FF", "mid-low"= "#3B528BFF", 
                                                 "mid" = "#21908CFF", 
                                                  "mid-high"= "#5DC863FF", "high" = "#FDE725FF")
                                         ),
    na_col = "black")
Heatmap(df6, name = " ",
        cluster_rows = FALSE, cluster_columns = FALSE,
        top_annotation = column_peri)

column_peri = HeatmapAnnotation(race = c(marker.exp$race),
                              col = list(race = c("White" = "#932667FF", "Black" = "grey")),
    na_col = "black")
Heatmap(df6, name = " ",
        cluster_rows = FALSE,
        top_annotation = column_peri)

```

```{r ggridges, fig.width=12}

# # a <- markers_ROI %>% 
# #   filter(!is.na(immunoscore_2018lancet_patients)) %>% 
# #   select(immunoscore_2018lancet_patients, 
# #          percent_CD3_tumor = percent_CD3_tumor.p, 
# #          percent_CD3_CD8_tumor = percent_CD3_CD8_tumor.p, 
# #          percent_CD3_FoxP3_tumor = percent_CD3_FoxP3_tumor.p, 
# #          percent_CD11b_tumor = percent_CD11b_tumor.p, 
# #          percent_CD11b_CD15_tumor = percent_CD11b_CD15_tumor.p) %>% 
# #   pivot_longer(-immunoscore_2018lancet_patients, names_to = "markers", values_to = "value") %>% 
# #   mutate(location = "Peripheral")
# # 
# # 
# # markers_ROI %>% 
# #   filter(!is.na(immunoscore_2018lancet_patients)) %>% 
# #   select(immunoscore_2018lancet_patients, 
# #          percent_CD3_tumor = percent_CD3_tumor.i, 
# #          percent_CD3_CD8_tumor = percent_CD3_CD8_tumor.i, 
# #          percent_CD3_FoxP3_tumor = percent_CD3_FoxP3_tumor.i, 
# #          percent_CD11b_tumor = percent_CD11b_tumor.i, 
# #          percent_CD11b_CD15_tumor = percent_CD11b_CD15_tumor.i) %>% 
# #   pivot_longer(-immunoscore_2018lancet_patients, names_to = "markers", values_to = "value") %>% 
# #   mutate(location = "Intratumoral") %>% 
# #   bind_rows(., a) %>% 
# #   
# #   
# #   ggplot( aes(y=markers, x=value,  fill=markers, 
# #               linetype = location
# #               )) +
# #     geom_density_ridges(alpha=0.6#, 
# #                         # stat="binline", bins=20
# #                         ) +
# #     theme_ridges()+
# #   theme(
# #     axis.text.y = element_blank(),
# #       panel.spacing = unit(0.1, "lines"),
# #       strip.text.x = element_text(size = 8)
# #     ) +
# #   
# #   facet_wrap(~ immunoscore_2018lancet_patients, nrow = 1)
# 
# 
# b <- markers_ROI %>% 
#   filter(!is.na(immunoscore_2018lancet_patients)) %>% 
#   select(immunoscore_2018lancet_patients, 
#          percent_CD3 = percent_CD3_stroma.i, 
#          percent_CD3_CD8 = percent_CD3_CD8_stroma.i, 
#          percent_CD3_FoxP3 = percent_CD3_FoxP3_stroma.i, 
#          percent_CD11b = percent_CD11b_stroma.i, 
#          percent_CD11b_CD15 = percent_CD11b_CD15_stroma.i) %>% 
#   pivot_longer(-immunoscore_2018lancet_patients, names_to = "markers", values_to = "value") %>% 
#   mutate(location = "Stroma")
# 
# markers_ROI %>% 
#   filter(!is.na(immunoscore_2018lancet_patients)) %>% 
#   select(immunoscore_2018lancet_patients, 
#          percent_CD3 = percent_CD3_tumor.i, 
#          percent_CD3_CD8 = percent_CD3_CD8_tumor.i, 
#          percent_CD3_FoxP3 = percent_CD3_FoxP3_tumor.i, 
#          percent_CD11b = percent_CD11b_tumor.i, 
#          percent_CD11b_CD15 = percent_CD11b_CD15_tumor.i) %>% 
#   pivot_longer(-immunoscore_2018lancet_patients, names_to = "markers", values_to = "value") %>% 
#   mutate(location = "Tumor") %>% 
#   bind_rows(., b) %>% 
#   
#   ggplot(aes(y=markers, x=value,  fill=markers, linetype = location)) +
#     geom_density_ridges(alpha=0.5) +
#   ggtitle("Intratumoral")+
#     theme_ridges()+
#   theme(axis.text.y = element_blank(),
#         panel.spacing = unit(0.1, "lines"),
#         strip.text.x = element_text(size = 8)
#     ) +
#   
#   facet_wrap(~ immunoscore_2018lancet_patients, nrow = 1)
# 
# a <- markers_ROI %>% 
#   filter(!is.na(immunoscore_2018lancet_patients)) %>% 
#   select(immunoscore_2018lancet_patients, 
#          percent_CD3 = percent_CD3_stroma.p, 
#          percent_CD3_CD8 = percent_CD3_CD8_stroma.p, 
#          percent_CD3_FoxP3 = percent_CD3_FoxP3_stroma.p, 
#          percent_CD11b = percent_CD11b_stroma.p, 
#          percent_CD11b_CD15 = percent_CD11b_CD15_stroma.p) %>% 
#   pivot_longer(-immunoscore_2018lancet_patients, names_to = "markers", values_to = "value") %>% 
#   mutate(location = "Stroma")
# 
# markers_ROI %>% 
#   filter(!is.na(immunoscore_2018lancet_patients)) %>% 
#   select(immunoscore_2018lancet_patients, 
#          percent_CD3 = percent_CD3_tumor.p, 
#          percent_CD3_CD8 = percent_CD3_CD8_tumor.p, 
#          percent_CD3_FoxP3 = percent_CD3_FoxP3_tumor.p, 
#          percent_CD11b = percent_CD11b_tumor.p, 
#          percent_CD11b_CD15 = percent_CD11b_CD15_tumor.p) %>% 
#   pivot_longer(-immunoscore_2018lancet_patients, names_to = "markers", values_to = "value") %>% 
#   mutate(location = "Tumor") %>% 
#   bind_rows(., b) %>% 
#   
#   ggplot(aes(y=markers, x=value,  fill=markers, linetype = location)) +
#     geom_density_ridges(alpha=0.5) +
#   ggtitle("Peripheral")+
#     theme_ridges()+
#   theme(axis.text.y = element_blank(),
#         panel.spacing = unit(0.1, "lines"),
#         strip.text.x = element_text(size = 8)
#     ) +
#   
#   facet_wrap(~ immunoscore_2018lancet_patients, nrow = 1)
```


```{r, fig.width=12}
b <- markers_ROI %>% 
  filter(!is.na(clusters_all_IandP)) %>% 
  select(clusters_all_IandP, 
         percent_CD3 = percent_CD3_stroma.i, 
         percent_CD3_CD8 = percent_CD3_CD8_stroma.i, 
         percent_CD3_FoxP3 = percent_CD3_FoxP3_stroma.i, 
         percent_CD11b = percent_CD11b_stroma.i, 
         percent_CD11b_CD15 = percent_CD11b_CD15_stroma.i) %>% 
  pivot_longer(-clusters_all_IandP, names_to = "markers", values_to = "value") %>% 
  mutate(location = "Stroma")

markers_ROI %>% 
  filter(!is.na(clusters_all_IandP)) %>% 
  select(clusters_all_IandP, 
         percent_CD3 = percent_CD3_tumor.i, 
         percent_CD3_CD8 = percent_CD3_CD8_tumor.i, 
         percent_CD3_FoxP3 = percent_CD3_FoxP3_tumor.i, 
         percent_CD11b = percent_CD11b_tumor.i, 
         percent_CD11b_CD15 = percent_CD11b_CD15_tumor.i) %>% 
  pivot_longer(-clusters_all_IandP, names_to = "markers", values_to = "value") %>% 
  mutate(location = "Tumor") %>% 
  bind_rows(., b) %>% 
  
  ggplot(aes(y=markers, x=value,  fill=markers, linetype = location)) +
    geom_density_ridges(alpha=0.5) +
  ggtitle("Intratumoral")+
    theme_ridges()+
  theme(axis.text.y = element_blank(),
        panel.spacing = unit(0.1, "lines"),
        strip.text.x = element_text(size = 8)
    ) +
  
  facet_wrap(~ clusters_all_IandP, nrow = 1)

a <- markers_ROI %>% 
  filter(!is.na(clusters_all_IandP)) %>% 
  select(clusters_all_IandP, 
         percent_CD3 = percent_CD3_stroma.p, 
         percent_CD3_CD8 = percent_CD3_CD8_stroma.p, 
         percent_CD3_FoxP3 = percent_CD3_FoxP3_stroma.p, 
         percent_CD11b = percent_CD11b_stroma.p, 
         percent_CD11b_CD15 = percent_CD11b_CD15_stroma.p) %>% 
  pivot_longer(-clusters_all_IandP, names_to = "markers", values_to = "value") %>% 
  mutate(location = "Stroma")

markers_ROI %>% 
  filter(!is.na(clusters_all_IandP)) %>% 
  select(clusters_all_IandP, 
         percent_CD3 = percent_CD3_tumor.p, 
         percent_CD3_CD8 = percent_CD3_CD8_tumor.p, 
         percent_CD3_FoxP3 = percent_CD3_FoxP3_tumor.p, 
         percent_CD11b = percent_CD11b_tumor.p, 
         percent_CD11b_CD15 = percent_CD11b_CD15_tumor.p) %>% 
  pivot_longer(-clusters_all_IandP, names_to = "markers", values_to = "value") %>% 
  mutate(location = "Tumor") %>% 
  bind_rows(., b) %>% 
  
  ggplot(aes(y=markers, x=value,  fill=markers, linetype = location)) +
    geom_density_ridges(alpha=0.5) +
  ggtitle("Peripheral")+
    theme_ridges()+
  theme(axis.text.y = element_blank(),
        panel.spacing = unit(0.1, "lines"),
        strip.text.x = element_text(size = 8)
    ) +
  
  facet_wrap(~ clusters_all_IandP, nrow = 1)
```


# Table 3. Adjusted hazard ratios and 95% confidence intervals
## 1% group- absensece /presece
<br>

<!-- **Removed 4 patients no BMI** -->

## Whole population
```{r}
markers_ROI_o <- markers_ROI %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  rename(CD3 = CD3_total.i, CD3_CD8 = CD3_CD8_total.i,
         CD3_FoxP3 = CD3_FoxP3_total.i, 
         CD11b = CD11b_total.i, CD11b_CD15 = CD11b_CD15_total.i)
  
tbl1 <- coxph(Surv(time = markers_ROI_o$timeint_fu, 
                   event = markers_ROI_o$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_o)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI_o$timeint_fu, 
                   event = markers_ROI_o$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- coxph(Surv(time = markers_ROI_o$timeint_fu, 
                   event = markers_ROI_o$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROI_o$timeint_fu, 
                   event = markers_ROI_o$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROI_o$timeint_fu, 
                   event = markers_ROI_o$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl10 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))

markers_ROI_t <- markers_ROI %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  rename(CD3 = CD3_tumor.i, CD3_CD8 = CD3_CD8_tumor.i,
         CD3_FoxP3 = CD3_FoxP3_tumor.i, 
         CD11b = CD11b_tumor.i, CD11b_CD15 = CD11b_CD15_tumor.i)
  
tbl1 <- coxph(Surv(time = markers_ROI_t$timeint_fu, 
                   event = markers_ROI_t$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_t)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI_t$timeint_fu, 
                   event = markers_ROI_t$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- coxph(Surv(time = markers_ROI_t$timeint_fu, 
                   event = markers_ROI_t$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROI_t$timeint_fu, 
                   event = markers_ROI_t$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROI_t$timeint_fu, 
                   event = markers_ROI_t$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl11 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))

markers_ROI_s <- markers_ROI %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  rename(CD3 = CD3_stroma.i, CD3_CD8 = CD3_CD8_stroma.i,
         CD3_FoxP3 = CD3_FoxP3_stroma.i, 
         CD11b = CD11b_stroma.i, CD11b_CD15 = CD11b_CD15_stroma.i)

tbl1 <- coxph(Surv(time = markers_ROI_s$timeint_fu, 
                   event = markers_ROI_s$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI_s$timeint_fu, 
                   event = markers_ROI_s$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- coxph(Surv(time = markers_ROI_s$timeint_fu, 
                   event = markers_ROI_s$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROI_s$timeint_fu, 
                   event = markers_ROI_s$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROI_s$timeint_fu, 
                   event = markers_ROI_s$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl12 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))
# tbl13 <- tbl_merge(list(tbl10, tbl11, tbl12), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))



markers_ROI_o <- markers_ROI %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  rename(CD3 = CD3_total.p, CD3_CD8 = CD3_CD8_total.p,
         CD3_FoxP3 = CD3_FoxP3_total.p, 
         CD11b = CD11b_total.p, CD11b_CD15 = CD11b_CD15_total.p)
  
tbl1 <- coxph(Surv(time = markers_ROI_o$timeint_fu, 
                   event = markers_ROI_o$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_o)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI_o$timeint_fu, 
                   event = markers_ROI_o$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- coxph(Surv(time = markers_ROI_o$timeint_fu, 
                   event = markers_ROI_o$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROI_o$timeint_fu, 
                   event = markers_ROI_o$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROI_o$timeint_fu, 
                   event = markers_ROI_o$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl13 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))

markers_ROI_t <- markers_ROI %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  rename(CD3 = CD3_tumor.p, CD3_CD8 = CD3_CD8_tumor.p,
         CD3_FoxP3 = CD3_FoxP3_tumor.p, 
         CD11b = CD11b_tumor.p, CD11b_CD15 = CD11b_CD15_tumor.p)
  
tbl1 <- coxph(Surv(time = markers_ROI_t$timeint_fu, 
                   event = markers_ROI_t$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_t)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI_t$timeint_fu, 
                   event = markers_ROI_t$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- coxph(Surv(time = markers_ROI_t$timeint_fu, 
                   event = markers_ROI_t$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROI_t$timeint_fu, 
                   event = markers_ROI_t$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROI_t$timeint_fu, 
                   event = markers_ROI_t$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl14 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))

markers_ROI_s <- markers_ROI %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  rename(CD3 = CD3_stroma.p, CD3_CD8 = CD3_CD8_stroma.p,
         CD3_FoxP3 = CD3_FoxP3_stroma.p, 
         CD11b = CD11b_stroma.p, CD11b_CD15 = CD11b_CD15_stroma.p)

tbl1 <- coxph(Surv(time = markers_ROI_s$timeint_fu, 
                   event = markers_ROI_s$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI_s$timeint_fu, 
                   event = markers_ROI_s$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- coxph(Surv(time = markers_ROI_s$timeint_fu, 
                   event = markers_ROI_s$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROI_s$timeint_fu, 
                   event = markers_ROI_s$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROI_s$timeint_fu, 
                   event = markers_ROI_s$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl15 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))

# tbl14 <- tbl_merge(list(tbl13, tbl14, tbl15), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))
```

## Overall
```{r}
tbl16 <- tbl_stack(list(tbl10, tbl13), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl16
# gt::gtsave(tbl16, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Overall ROIs.pdf"))
```

## Tumor
```{r}
tbl17 <- tbl_stack(list(tbl11, tbl14), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl17
# gt::gtsave(tbl17, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Tumor ROIs.pdf"))
```

## Stroma
```{r}
tbl18 <- tbl_stack(list(tbl12, tbl15), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl18
# gt::gtsave(tbl18, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Stroma ROIs.pdf"))
```


# Table 3b. Adjusted hazard ratios and 95% confidence intervals (**include each 3 values and use the cluster option**)

```{r create group per sample on ROI_global}
ROI_global <- ROI_global %>% 
  
  mutate(CD3_tumor = case_when(
    
    tumor_percent_cd3_opal_650_positive_cells <= 1      ~ "low",
    tumor_percent_cd3_opal_650_positive_cells > 1       ~ "high"
  ), CD3_tumor = factor(CD3_tumor, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_tumor = case_when(
    tumor_percent_cd3plus_cd8plus_positive_cells <= 1      ~ "low",
    tumor_percent_cd3plus_cd8plus_positive_cells > 1       ~ "high"
  ), CD3_CD8_tumor = factor(CD3_CD8_tumor, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_tumor = case_when(
    tumor_percent_cd3plus_foxp3plus_positive_cells <= 1      ~ "low",
    tumor_percent_cd3plus_foxp3plus_positive_cells > 1       ~ "high"
  ), CD3_FoxP3_tumor = factor(CD3_FoxP3_tumor, levels = c("low","high"))) %>% 
  mutate(CD11b_tumor = case_when(
    tumor_percent_cd11b_opal_620_positive_cells == 0      ~ "Absence",
    tumor_percent_cd11b_opal_620_positive_cells > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_tumor = case_when(
    tumor_percent_cd15_opal_520_positive_cells == 0      ~ "Absence",
    tumor_percent_cd15_opal_520_positive_cells > 0       ~ "Presence"
  )) %>% 
  
  mutate(CD3_stroma = case_when(
    stroma_percent_cd3_opal_650_positive_cells <= 1      ~ "low",
    stroma_percent_cd3_opal_650_positive_cells > 1       ~ "high"
  ), CD3_stroma = factor(CD3_stroma, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_stroma = case_when(
    stroma_percent_cd3plus_cd8plus_positive_cells <= 1      ~ "low",
    stroma_percent_cd3plus_cd8plus_positive_cells > 1       ~ "high"
  ), CD3_CD8_stroma = factor(CD3_CD8_stroma, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_stroma = case_when(
    stroma_percent_cd3plus_foxp3plus_positive_cells <= 1      ~ "low",
    stroma_percent_cd3plus_foxp3plus_positive_cells > 1       ~ "high"
  ), CD3_FoxP3_stroma = factor(CD3_FoxP3_stroma, levels = c("low","high"))) %>% 
  mutate(CD11b_stroma = case_when(
    stroma_percent_cd11b_opal_620_positive_cells == 0      ~ "Absence",
    stroma_percent_cd11b_opal_620_positive_cells > 0       ~ "Presence"
  )) %>%
  mutate(CD11b_CD15_stroma = case_when(
    stroma_percent_cd11bplus_cd15plus_positive_cells == 0      ~ "Absence",
    stroma_percent_cd11bplus_cd15plus_positive_cells > 0       ~ "Presence"
  )) %>% 
  
  mutate(CD3_total = case_when(
    percent_cd3_opal_650_positive_cells <= 1      ~ "low",
    percent_cd3_opal_650_positive_cells > 1       ~ "high"
  ), CD3_total = factor(CD3_total, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_total = case_when(
    percent_cd3plus_cd8plus_positive_cells <= 1      ~ "low",
    percent_cd3plus_cd8plus_positive_cells > 1       ~ "high"
  ), CD3_CD8_total = factor(CD3_CD8_total, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_total = case_when(
    percent_cd3plus_foxp3plus_positive_cells <= 1      ~ "low",
    percent_cd3plus_foxp3plus_positive_cells > 1       ~ "high"
  ), CD3_FoxP3_total = factor(CD3_FoxP3_total, levels = c("low","high"))) %>% 
  mutate(CD11b_total = case_when(
    percent_cd11b_opal_620_positive_cells == 0      ~ "Absence",
    percent_cd11b_opal_620_positive_cells > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_total = case_when(
    percent_cd11bplus_cd15plus_positive_cells == 0      ~ "Absence",
    percent_cd11bplus_cd15plus_positive_cells > 0       ~ "Presence"
  )) 

```

<!-- **Removed 4 patients no BMI** -->

```{r Table % cluster option}
markers_ROIclust_o <- ROI_global %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  rename(CD3 = CD3_total, CD3_CD8 = CD3_CD8_total,
         CD3_FoxP3 = CD3_FoxP3_total, 
         CD11b = CD11b_total, CD11b_CD15 = CD11b_CD15_total)
  
tbl1 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3 + stage + refage + race, cluster = suid, data =  markers_ROIclust_o)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3_CD8 + stage + refage + race, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu,
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + stage + refage + race, cluster = suid, data =  markers_ROIclust_o) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")


# newdata <- survSplit(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + stage + refage + race, id = "suid", data = markers_ROIclust_o, cut=1700, episode='tgroup')
# 
# coxph(Surv(newdata$tstart, newdata$tstop,
#                    event = newdata$event) ~ CD3_FoxP3 + CD3_FoxP3:tstop + strata(stage) + refage + race, cluster = suid, 
#               data =  newdata)
# 
# coxph(Surv(newdata$tstart, newdata$tstop,
#                    event = newdata$event) ~ CD3_FoxP3:strata(tgroup) + strata(stage) + refage + race, cluster = suid, 
#               data =  newdata)
# 
# survcheck(Surv(newdata$tstart, newdata$tstop,
#                    event = newdata$event) ~ CD3_FoxP3:strata(tgroup) + strata(stage) + refage + race, id = suid, 
#               data =  newdata)
# 
# survfit(Surv(newdata$tstart, newdata$tstop,
#                    event = newdata$event) ~ CD3_FoxP3 + strata(tgroup) + strata(stage) + refage + race, cluster = suid, influence = TRUE,
#               data =  newdata)



# tbl3 <-
#   coxph(Surv(time = newdata$tstart, newdata$tstop,
#                    event = newdata$event) ~ CD3_FoxP3 + CD3_FoxP3:tstop + strata(stage) + refage + race, cluster = suid, 
#               data =  newdata) %>% 
#   tbl_regression(exponentiate = TRUE,
#                  include = 'CD3_FoxP3:tstop') %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl4 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b + stage + refage + race, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b_CD15 + stage + refage + race, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl10 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))

markers_ROIclust_t <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  rename(CD3 = CD3_tumor, CD3_CD8 = CD3_CD8_tumor,
         CD3_FoxP3 = CD3_FoxP3_tumor, 
         CD11b = CD11b_tumor, CD11b_CD15 = CD11b_CD15_tumor)
  
tbl1 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3 + stage + refage + race, cluster = suid, data =  markers_ROIclust_t)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3_CD8 + stage + refage + race, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + stage + refage + race, cluster = suid, data =  markers_ROIclust_t) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# newdata <- survSplit(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + stage + refage + race, id = "suid", data = markers_ROIclust_t, cut=1700, episode='tgroup')   
# 
# tbl3 <- coxph(Surv(time = newdata$tstart, newdata$tstop,
#                    event = newdata$event) ~ CD3_FoxP3:strata(tgroup) + strata(stage) + refage + race, cluster = suid, 
#               data =  newdata) %>% 
#   tbl_regression(exponentiate = TRUE,
#                  include = 'CD3_FoxP3:strata(tgroup)') %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b + stage + refage + race, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b_CD15 + stage + refage + race, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl11 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))

markers_ROIclust_s <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  rename(CD3 = CD3_stroma, CD3_CD8 = CD3_CD8_stroma,
         CD3_FoxP3 = CD3_FoxP3_stroma, 
         CD11b = CD11b_stroma, CD11b_CD15 = CD11b_CD15_stroma)

tbl1 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3 + stage + refage + race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3_CD8 + stage + refage + race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + stage + refage + race, cluster = suid, data =  markers_ROIclust_s) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# newdata <- survSplit(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + stage + refage + race, id = "suid", data = markers_ROIclust_s, cut=1700, episode='tgroup')   
# 
# tbl3 <- coxph(Surv(time = newdata$tstart, newdata$tstop,
#                    event = newdata$event) ~ CD3_FoxP3:strata(tgroup) + strata(stage) + refage + race, cluster = suid, 
#               data =  newdata) %>% 
#   tbl_regression(exponentiate = TRUE,
#                  include = 'CD3_FoxP3:strata(tgroup)') %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b + stage + refage + race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b_CD15 + stage + refage + race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl12 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))
# tbl13 <- tbl_merge(list(tbl10, tbl11, tbl12), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))



markers_ROIclust_o <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  filter(!str_detect(suid, paste0(remove_id, collapse = "|")), 
         intratumoral_i_vs_peripheral_p_ == "Peripheral") %>% 
  rename(CD3 = CD3_total, CD3_CD8 = CD3_CD8_total,
         CD3_FoxP3 = CD3_FoxP3_total, 
         CD11b = CD11b_total, CD11b_CD15 = CD11b_CD15_total)
  
tbl1 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3 + stage + refage + race, cluster = suid, data =  markers_ROIclust_o)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3_CD8 + stage + refage + race, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + stage + refage + race, cluster = suid, data =  markers_ROIclust_o) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# newdata <- survSplit(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + stage + refage + race, id = "suid", data = markers_ROIclust_o, cut=1700, episode='tgroup')   
# 
# tbl3 <- coxph(Surv(time = newdata$tstart, newdata$tstop,
#                    event = newdata$event) ~ CD3_FoxP3:strata(tgroup) + strata(stage) + refage + race, cluster = suid, 
#               data =  newdata) %>% 
#   tbl_regression(exponentiate = TRUE,
#                  include = 'CD3_FoxP3:strata(tgroup)') %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b + stage + refage + race, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b_CD15 + stage + refage + race, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl13 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))

markers_ROIclust_t <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  filter(!str_detect(suid, paste0(remove_id, collapse = "|")), 
         intratumoral_i_vs_peripheral_p_ == "Peripheral") %>%
  rename(CD3 = CD3_tumor, CD3_CD8 = CD3_CD8_tumor,
         CD3_FoxP3 = CD3_FoxP3_tumor, 
         CD11b = CD11b_tumor, CD11b_CD15 = CD11b_CD15_tumor)
  
tbl1 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3 + stage + refage + race, cluster = suid, data =  markers_ROIclust_t)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3_CD8 + stage + refage + race, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + stage + refage + race, cluster = suid, data =  markers_ROIclust_t) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# newdata <- survSplit(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + stage + refage + race, id = "suid", data = markers_ROIclust_t, cut=1700, episode='tgroup')   
# 
# tbl3 <- coxph(Surv(time = newdata$tstart, newdata$tstop,
#                    event = newdata$event) ~ CD3_FoxP3:strata(tgroup) + strata(stage) + refage + race, cluster = suid, 
#               data =  newdata) %>% 
#   tbl_regression(exponentiate = TRUE,
#                  include = 'CD3_FoxP3:strata(tgroup)') %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b + stage + refage + race, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b_CD15 + stage + refage + race, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl14 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))

markers_ROIclust_s <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  filter(!str_detect(suid, paste0(remove_id, collapse = "|")), 
         intratumoral_i_vs_peripheral_p_ == "Peripheral") %>% 
  rename(CD3 = CD3_stroma, CD3_CD8 = CD3_CD8_stroma,
         CD3_FoxP3 = CD3_FoxP3_stroma, 
         CD11b = CD11b_stroma, CD11b_CD15 = CD11b_CD15_stroma)

tbl1 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3 + stage + refage + race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3_CD8 + stage + refage + race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + stage + refage + race, cluster = suid, data =  markers_ROIclust_s) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# newdata <- survSplit(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + stage + refage + race, id = "suid", data = markers_ROIclust_s, cut=1700, episode='tgroup')   
# 
# tbl3 <- coxph(Surv(time = newdata$tstart, newdata$tstop,
#                    event = newdata$event) ~ CD3_FoxP3:strata(tgroup) + strata(stage) + refage + race, cluster = suid, 
#               data =  newdata) %>% 
#   tbl_regression(exponentiate = TRUE,
#                  include = 'CD3_FoxP3:strata(tgroup)') %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b + stage + refage + race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b_CD15 + stage + refage + race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl15 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))
# tbl14 <- tbl_merge(list(tbl13, tbl14, tbl15), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))
```

## Overall
```{r}
tbl16 <- tbl_stack(list(tbl10, tbl13), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl16
# gt::gtsave(tbl16, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Overall ROIs cluster option.pdf"))
```

## Tumor
```{r}
tbl17 <- tbl_stack(list(tbl11, tbl14), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl17
# gt::gtsave(tbl17, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Tumor ROIs cluster option.pdf"))
```

## Stroma
```{r}
tbl18 <- tbl_stack(list(tbl12, tbl15), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl18
# gt::gtsave(tbl18, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Stroma ROIs cluster option.pdf"))
```

## In White (I can bind W/B later if you want them side by side)
```{r Table % cluster option white}
markers_ROIclust_o <- ROI_global %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral" & race == "White") %>% 
  rename(CD3 = CD3_total, CD3_CD8 = CD3_CD8_total,
         CD3_FoxP3 = CD3_FoxP3_total, 
         CD11b = CD11b_total, CD11b_CD15 = CD11b_CD15_total)
  
tbl1 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_o)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl10 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))

markers_ROIclust_t <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral" & race == "White") %>% 
  rename(CD3 = CD3_tumor, CD3_CD8 = CD3_CD8_tumor,
         CD3_FoxP3 = CD3_FoxP3_tumor, 
         CD11b = CD11b_tumor, CD11b_CD15 = CD11b_CD15_tumor)
  
tbl1 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_t)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl11 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))

markers_ROIclust_s <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral" & race == "White") %>% 
  rename(CD3 = CD3_stroma, CD3_CD8 = CD3_CD8_stroma,
         CD3_FoxP3 = CD3_FoxP3_stroma, 
         CD11b = CD11b_stroma, CD11b_CD15 = CD11b_CD15_stroma)

tbl1 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl12 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))
# tbl13 <- tbl_merge(list(tbl10, tbl11, tbl12), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))



markers_ROIclust_o <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  filter(!str_detect(suid, paste0(remove_id, collapse = "|")), 
         intratumoral_i_vs_peripheral_p_ == "Peripheral", race == "White") %>% 
  rename(CD3 = CD3_total, CD3_CD8 = CD3_CD8_total,
         CD3_FoxP3 = CD3_FoxP3_total, 
         CD11b = CD11b_total, CD11b_CD15 = CD11b_CD15_total)
  
tbl1 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_o)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl13 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))

markers_ROIclust_t <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  filter(!str_detect(suid, paste0(remove_id, collapse = "|")), 
         intratumoral_i_vs_peripheral_p_ == "Peripheral", race == "White") %>% 
  rename(CD3 = CD3_tumor, CD3_CD8 = CD3_CD8_tumor,
         CD3_FoxP3 = CD3_FoxP3_tumor, 
         CD11b = CD11b_tumor, CD11b_CD15 = CD11b_CD15_tumor)
  
tbl1 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_t)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl14 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))

markers_ROIclust_s <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  filter(!str_detect(suid, paste0(remove_id, collapse = "|")), 
         intratumoral_i_vs_peripheral_p_ == "Peripheral", race == "White") %>% 
  rename(CD3 = CD3_stroma, CD3_CD8 = CD3_CD8_stroma,
         CD3_FoxP3 = CD3_FoxP3_stroma, 
         CD11b = CD11b_stroma, CD11b_CD15 = CD11b_CD15_stroma)

tbl1 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl15 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))
# tbl14 <- tbl_merge(list(tbl13, tbl14, tbl15), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))
```

## Overall
```{r}
tbl16 <- tbl_stack(list(tbl10, tbl13), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl16
# gt::gtsave(tbl16, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Overall ROIs cluster option.pdf"))
```

## Tumor
```{r}
tbl17 <- tbl_stack(list(tbl11, tbl14), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl17
# gt::gtsave(tbl17, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Tumor ROIs cluster option.pdf"))
```

## Stroma
```{r}
tbl18 <- tbl_stack(list(tbl12, tbl15), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl18
# gt::gtsave(tbl18, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Stroma ROIs cluster option.pdf"))
```

## In Black
```{r Table % cluster option black}
markers_ROIclust_o <- ROI_global %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral" & race == "Black") %>% 
  rename(CD3 = CD3_total, CD3_CD8 = CD3_CD8_total,
         CD3_FoxP3 = CD3_FoxP3_total, 
         CD11b = CD11b_total, CD11b_CD15 = CD11b_CD15_total)
  
tbl1 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_o)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl10 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))

markers_ROIclust_t <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral" & race == "Black") %>% 
  rename(CD3 = CD3_tumor, CD3_CD8 = CD3_CD8_tumor,
         CD3_FoxP3 = CD3_FoxP3_tumor, 
         CD11b = CD11b_tumor, CD11b_CD15 = CD11b_CD15_tumor)
  
tbl1 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_t)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl11 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))

markers_ROIclust_s <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral" & race == "Black") %>% 
  rename(CD3 = CD3_stroma, CD3_CD8 = CD3_CD8_stroma,
         CD3_FoxP3 = CD3_FoxP3_stroma, 
         CD11b = CD11b_stroma, CD11b_CD15 = CD11b_CD15_stroma)

tbl1 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl12 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))
# tbl13 <- tbl_merge(list(tbl10, tbl11, tbl12), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))



markers_ROIclust_o <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  filter(!str_detect(suid, paste0(remove_id, collapse = "|")), 
         intratumoral_i_vs_peripheral_p_ == "Peripheral", race == "Black") %>% 
  rename(CD3 = CD3_total, CD3_CD8 = CD3_CD8_total,
         CD3_FoxP3 = CD3_FoxP3_total, 
         CD11b = CD11b_total, CD11b_CD15 = CD11b_CD15_total)
  
tbl1 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_o)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl13 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))

markers_ROIclust_t <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  filter(!str_detect(suid, paste0(remove_id, collapse = "|")), 
         intratumoral_i_vs_peripheral_p_ == "Peripheral", race == "Black") %>% 
  rename(CD3 = CD3_tumor, CD3_CD8 = CD3_CD8_tumor,
         CD3_FoxP3 = CD3_FoxP3_tumor, 
         CD11b = CD11b_tumor, CD11b_CD15 = CD11b_CD15_tumor)
  
tbl1 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_t)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl14 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))

markers_ROIclust_s <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  filter(!str_detect(suid, paste0(remove_id, collapse = "|")), 
         intratumoral_i_vs_peripheral_p_ == "Peripheral", race == "Black") %>% 
  rename(CD3 = CD3_stroma, CD3_CD8 = CD3_CD8_stroma,
         CD3_FoxP3 = CD3_FoxP3_stroma, 
         CD11b = CD11b_stroma, CD11b_CD15 = CD11b_CD15_stroma)

tbl1 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
# tbl3 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   tbl_regression(exponentiate = TRUE,
#                  include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl15 <- tbl_stack(list(tbl1, tbl2, tbl4, tbl5))
# tbl14 <- tbl_merge(list(tbl13, tbl14, tbl15), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))
```

## Overall
```{r}
tbl16 <- tbl_stack(list(tbl10, tbl13), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl16
# gt::gtsave(tbl16, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Overall ROIs cluster option.pdf"))
```

## Tumor
```{r}
tbl17 <- tbl_stack(list(tbl11, tbl14), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl17
# gt::gtsave(tbl17, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Tumor ROIs cluster option.pdf"))
```

## Stroma
```{r}
tbl18 <- tbl_stack(list(tbl12, tbl15), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl18
# gt::gtsave(tbl18, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Stroma ROIs cluster option.pdf"))
```
<br>


# Frequency distribution of the number of cases
<br>

<!-- **Removed 4 patients no BMI** -->

## Overall
```{r}
markers_ROI_o <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  rename(CD3 = CD3_total.i, CD3_CD8 = CD3_CD8_total.i,
         CD3_FoxP3 = CD3_FoxP3_total.i,
         CD11b = CD11b_total.i, CD11b_CD15 = CD11b_CD15_total.i)
tbl10 <- markers_ROI_o %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()

markers_ROI_t <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  rename(CD3 = CD3_tumor.i, CD3_CD8 = CD3_CD8_tumor.i,
         CD3_FoxP3 = CD3_FoxP3_tumor.i,
         CD11b = CD11b_tumor.i, CD11b_CD15 = CD11b_CD15_tumor.i)
tbl11 <- markers_ROI_t %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()

markers_ROI_s <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  rename(CD3 = CD3_stroma.i, CD3_CD8 = CD3_CD8_stroma.i,
         CD3_FoxP3 = CD3_FoxP3_stroma.i,
         CD11b = CD11b_stroma.i, CD11b_CD15 = CD11b_CD15_stroma.i)
tbl12 <- markers_ROI_s %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()
# tbl13 <- tbl_merge(list(tbl10, tbl11, tbl12), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))

markers_ROI_o <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  rename(CD3 = CD3_total.p, CD3_CD8 = CD3_CD8_total.p,
         CD3_FoxP3 = CD3_FoxP3_total.p,
         CD11b = CD11b_total.p, CD11b_CD15 = CD11b_CD15_total.p)
tbl13 <- markers_ROI_o %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()

markers_ROI_t <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  rename(CD3 = CD3_tumor.p, CD3_CD8 = CD3_CD8_tumor.p,
         CD3_FoxP3 = CD3_FoxP3_tumor.p,
         CD11b = CD11b_tumor.p, CD11b_CD15 = CD11b_CD15_tumor.p)
tbl14 <- markers_ROI_t %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()

markers_ROI_s <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  rename(CD3 = CD3_stroma.p, CD3_CD8 = CD3_CD8_stroma.p,
         CD3_FoxP3 = CD3_FoxP3_stroma.p,
         CD11b = CD11b_stroma.p, CD11b_CD15 = CD11b_CD15_stroma.p)
tbl15 <- markers_ROI_s %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()

# tbl14 <- tbl_merge(list(tbl13, tbl14, tbl15), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))
```

### Overall
```{r}
tbl16 <- tbl_stack(list(tbl10, tbl13), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl16
# gt::gtsave(tbl16, paste0(path, "/Table Frequency distribution of the number of cases Overall group.pdf"))
```

### Tumor
```{r}
tbl17 <- tbl_stack(list(tbl11, tbl14), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl17
# gt::gtsave(tbl17, paste0(path, "/Table Frequency distribution of the number of cases Tumor group.pdf"))
```

### Stroma
```{r}
tbl18 <- tbl_stack(list(tbl12, tbl15), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl18
# gt::gtsave(tbl18, paste0(path, "/Table Frequency distribution of the number of cases Stroma group.pdf"))
```

## In White/Black
```{r}
markers_ROI_o <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  filter(race == "White") %>% 
  rename(CD3 = CD3_total.i, CD3_CD8 = CD3_CD8_total.i,
         CD3_FoxP3 = CD3_FoxP3_total.i,
         CD11b = CD11b_total.i, CD11b_CD15 = CD11b_CD15_total.i)
tbl10 <- markers_ROI_o %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()

markers_ROI_t <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(race == "White") %>% 
rename(CD3 = CD3_tumor.i, CD3_CD8 = CD3_CD8_tumor.i,
         CD3_FoxP3 = CD3_FoxP3_tumor.i,
         CD11b = CD11b_tumor.i, CD11b_CD15 = CD11b_CD15_tumor.i)
tbl11 <- markers_ROI_t %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()

markers_ROI_s <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(race == "White") %>% 
rename(CD3 = CD3_stroma.i, CD3_CD8 = CD3_CD8_stroma.i,
         CD3_FoxP3 = CD3_FoxP3_stroma.i,
         CD11b = CD11b_stroma.i, CD11b_CD15 = CD11b_CD15_stroma.i)
tbl12 <- markers_ROI_s %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()
# tbl13 <- tbl_merge(list(tbl10, tbl11, tbl12), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))

markers_ROI_o <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(race == "White") %>% 
rename(CD3 = CD3_total.p, CD3_CD8 = CD3_CD8_total.p,
         CD3_FoxP3 = CD3_FoxP3_total.p,
         CD11b = CD11b_total.p, CD11b_CD15 = CD11b_CD15_total.p)
tbl13 <- markers_ROI_o %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()

markers_ROI_t <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(race == "White") %>% 
rename(CD3 = CD3_tumor.p, CD3_CD8 = CD3_CD8_tumor.p,
         CD3_FoxP3 = CD3_FoxP3_tumor.p,
         CD11b = CD11b_tumor.p, CD11b_CD15 = CD11b_CD15_tumor.p)
tbl14 <- markers_ROI_t %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()

markers_ROI_s <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(race == "White") %>% 
rename(CD3 = CD3_stroma.p, CD3_CD8 = CD3_CD8_stroma.p,
         CD3_FoxP3 = CD3_FoxP3_stroma.p,
         CD11b = CD11b_stroma.p, CD11b_CD15 = CD11b_CD15_stroma.p)
tbl15 <- markers_ROI_s %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()

markers_ROI_o <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  filter(race == "Black") %>% 
  rename(CD3 = CD3_total.i, CD3_CD8 = CD3_CD8_total.i,
         CD3_FoxP3 = CD3_FoxP3_total.i,
         CD11b = CD11b_total.i, CD11b_CD15 = CD11b_CD15_total.i)
tbl16 <- markers_ROI_o %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()

markers_ROI_t <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(race == "Black") %>% 
rename(CD3 = CD3_tumor.i, CD3_CD8 = CD3_CD8_tumor.i,
         CD3_FoxP3 = CD3_FoxP3_tumor.i,
         CD11b = CD11b_tumor.i, CD11b_CD15 = CD11b_CD15_tumor.i)
tbl17 <- markers_ROI_t %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()

markers_ROI_s <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(race == "Black") %>% 
rename(CD3 = CD3_stroma.i, CD3_CD8 = CD3_CD8_stroma.i,
         CD3_FoxP3 = CD3_FoxP3_stroma.i,
         CD11b = CD11b_stroma.i, CD11b_CD15 = CD11b_CD15_stroma.i)
tbl18 <- markers_ROI_s %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()
# tbl13 <- tbl_merge(list(tbl10, tbl11, tbl12), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))

markers_ROI_o <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(race == "Black") %>% 
rename(CD3 = CD3_total.p, CD3_CD8 = CD3_CD8_total.p,
         CD3_FoxP3 = CD3_FoxP3_total.p,
         CD11b = CD11b_total.p, CD11b_CD15 = CD11b_CD15_total.p)
tbl19 <- markers_ROI_o %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()

markers_ROI_t <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(race == "Black") %>% 
rename(CD3 = CD3_tumor.p, CD3_CD8 = CD3_CD8_tumor.p,
         CD3_FoxP3 = CD3_FoxP3_tumor.p,
         CD11b = CD11b_tumor.p, CD11b_CD15 = CD11b_CD15_tumor.p)
tbl20 <- markers_ROI_t %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()

markers_ROI_s <- markers_ROI %>%
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(race == "Black") %>% 
rename(CD3 = CD3_stroma.p, CD3_CD8 = CD3_CD8_stroma.p,
         CD3_FoxP3 = CD3_FoxP3_stroma.p,
         CD11b = CD11b_stroma.p, CD11b_CD15 = CD11b_CD15_stroma.p)
tbl21 <- markers_ROI_s %>% 
  select(CD3, CD3_CD8,
         CD3_FoxP3, 
         CD11b, CD11b_CD15, vitalstatus) %>% 
  tbl_summary(by= vitalstatus, statistic = list(all_categorical() ~ "{n}")) %>% 
      add_overall() %>% bold_labels()

tbl1 <- tbl_merge(list(tbl10, tbl16), tab_spanner = c("**White**", "**Black**"))
tbl2 <- tbl_merge(list(tbl11, tbl17), tab_spanner = c("**White**", "**Black**"))
tbl3 <- tbl_merge(list(tbl12, tbl18), tab_spanner = c("**White**", "**Black**"))
tbl4 <- tbl_merge(list(tbl13, tbl19), tab_spanner = c("**White**", "**Black**"))
tbl5 <- tbl_merge(list(tbl14, tbl20), tab_spanner = c("**White**", "**Black**"))
tbl6 <- tbl_merge(list(tbl15, tbl21), tab_spanner = c("**White**", "**Black**"))
```

### Overall
```{r}
tbl16 <- tbl_stack(list(tbl1, tbl4), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl16
# gt::gtsave(tbl16, paste0(path, "/Table Frequency distribution of the number of cases Overall group.pdf"))
```

### Tumor
```{r}
tbl17 <- tbl_stack(list(tbl2, tbl5), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl17
# gt::gtsave(tbl17, paste0(path, "/Table Frequency distribution of the number of cases Tumor group.pdf"))
```

### Stroma
```{r}
tbl18 <- tbl_stack(list(tbl3, tbl6), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl18
# gt::gtsave(tbl18, paste0(path, "/Table Frequency distribution of the number of cases Stroma group.pdf"))
```
<br>

***

# HR interaction terms by race
Cross product interaction terms between race and the immune markers group.  
Adjusted for stage, age and race and with cluster option.  

<!-- **Removed 4 patients no BMI** -->

<!-- inline_text(tbl1, variable = "CD3:race", level = "high * White", pattern = "{p.value}", pvalue_fun = purrr::partial(style_pvalue, digits = 2)) -->

```{r Table interactions by race cluster option}
markers_ROIclust_o <- ROI_global %>%
      # filter(!str_detect(suid, remove_id_bmi)) %>% 
filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  rename(CD3 = CD3_total, CD3_CD8 = CD3_CD8_total,
         CD3_FoxP3 = CD3_FoxP3_total, 
         CD11b = CD11b_total, CD11b_CD15 = CD11b_CD15_total)
  
tbl1 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu,
                   event = markers_ROIclust_o$surv_vital) ~ CD3 + stage + refage + race + CD3*race, cluster = suid, data =  markers_ROIclust_o)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = !CD3:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))

tbl2 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3_CD8 + stage + refage + race + CD3_CD8*race, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD3_CD8:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))

tbl3 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + stage + refage + race + CD3_FoxP3*race, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD3_FoxP3:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))

tbl4 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b + stage + refage + race + CD11b*race, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD11b:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))

tbl5 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b_CD15 + stage + refage + race + CD11b_CD15*race, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD11b_CD15:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))

tbl10 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))

markers_ROIclust_t <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  rename(CD3 = CD3_tumor, CD3_CD8 = CD3_CD8_tumor,
         CD3_FoxP3 = CD3_FoxP3_tumor, 
         CD11b = CD11b_tumor, CD11b_CD15 = CD11b_CD15_tumor)
  
tbl1 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3 + stage + refage + race + CD3*race, cluster = suid, data =  markers_ROIclust_t)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = !CD3:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>%
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl2 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3_CD8 + stage + refage + race + CD3_CD8*race, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD3_CD8:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl3 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + stage + refage + race + CD3_FoxP3*race, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD3_FoxP3:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl4 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b + stage + refage + race + CD11b*race, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD11b:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl5 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b_CD15 + stage + refage + race + CD11b_CD15*race, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD11b_CD15:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))

tbl11 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))

markers_ROIclust_s <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
    filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  rename(CD3 = CD3_stroma, CD3_CD8 = CD3_CD8_stroma,
         CD3_FoxP3 = CD3_FoxP3_stroma, 
         CD11b = CD11b_stroma, CD11b_CD15 = CD11b_CD15_stroma)

tbl1 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3 + stage + refage + race + CD3*race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD3:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl2 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3_CD8 + stage + refage + race + CD3_CD8*race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD3_CD8:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl3 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + stage + refage + race + CD3_FoxP3*race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD3_FoxP3:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl4 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b + stage + refage + race + CD11b*race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD11b:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl5 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b_CD15 + stage + refage + race + CD11b_CD15*race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD11b_CD15:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))

tbl12 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))
# tbl13 <- tbl_merge(list(tbl10, tbl11, tbl12), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))



markers_ROIclust_o <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  filter(!str_detect(suid, paste0(remove_id, collapse = "|")), 
         intratumoral_i_vs_peripheral_p_ == "Peripheral") %>% 
  rename(CD3 = CD3_total, CD3_CD8 = CD3_CD8_total,
         CD3_FoxP3 = CD3_FoxP3_total, 
         CD11b = CD11b_total, CD11b_CD15 = CD11b_CD15_total)
  
tbl1 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3 + stage + refage + race + CD3*race, cluster = suid, data =  markers_ROIclust_o)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = !CD3:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl2 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3_CD8 + stage + refage + race + CD3_CD8*race, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD3_CD8:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl3 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + stage + refage + race + CD3_FoxP3*race, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD3_FoxP3:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl4 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b + stage + refage + race + CD11b*race, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD11b:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl5 <- coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b_CD15 + stage + refage + race + CD11b_CD15*race, cluster = suid, data =  markers_ROIclust_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD11b_CD15:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))

tbl13 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))

markers_ROIclust_t <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  filter(!str_detect(suid, paste0(remove_id, collapse = "|")), 
         intratumoral_i_vs_peripheral_p_ == "Peripheral") %>% 
  rename(CD3 = CD3_tumor, CD3_CD8 = CD3_CD8_tumor,
         CD3_FoxP3 = CD3_FoxP3_tumor, 
         CD11b = CD11b_tumor, CD11b_CD15 = CD11b_CD15_tumor)
  
tbl1 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3 + stage + refage + race + CD3*race, cluster = suid, data =  markers_ROIclust_t)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = !CD3:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl2 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3_CD8 + stage + refage + race + CD3_CD8*race, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD3_CD8:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl3 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + stage + refage + race + CD3_FoxP3*race, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD3_FoxP3:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl4 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b + stage + refage + race + CD11b*race, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD11b:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl5 <- coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b_CD15 + stage + refage + race + CD11b_CD15*race, cluster = suid, data =  markers_ROIclust_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD11b_CD15:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))

tbl14 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))

markers_ROIclust_s <- ROI_global %>% 
    # filter(!str_detect(suid, remove_id_bmi)) %>% 
  filter(!str_detect(suid, paste0(remove_id, collapse = "|")), 
         intratumoral_i_vs_peripheral_p_ == "Peripheral") %>% 
  rename(CD3 = CD3_stroma, CD3_CD8 = CD3_CD8_stroma,
         CD3_FoxP3 = CD3_FoxP3_stroma, 
         CD11b = CD11b_stroma, CD11b_CD15 = CD11b_CD15_stroma)

tbl1 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3 + stage + refage + race + CD3*race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD3:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl2 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3_CD8 + stage + refage + race + CD3_CD8*race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD3_CD8:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl3 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + stage + refage + race + CD3_FoxP3*race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD3_FoxP3:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl4 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b + stage + refage + race + CD11b*race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD11b:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))
tbl5 <- coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b_CD15 + stage + refage + race + CD11b_CD15*race, cluster = suid, data =  markers_ROIclust_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = !CD11b_CD15:race, pvalue_fun = purrr::partial(style_pvalue, digits = 2)) %>% 
  bold_p(t = .05) %>% 
  modify_column_hide(c(estimate, ci))

tbl15 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))
# tbl14 <- tbl_merge(list(tbl13, tbl14, tbl15), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))
```

## Overall
```{r}
tbl16 <- tbl_stack(list(tbl10, tbl13), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl16
# gt::gtsave(tbl16, paste0(path, "/Table 4. Adjusted hazard ratios interaction in Overall ROIs cluster option.pdf"))
```

## Tumor
```{r}
tbl17 <- tbl_stack(list(tbl11, tbl14), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl17
# gt::gtsave(tbl17, paste0(path, "/Table 4. Adjusted hazard ratios interaction in Tumor ROIs cluster option.pdf"))
```

## Stroma
```{r}
tbl18 <- tbl_stack(list(tbl12, tbl15), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
tbl18
# gt::gtsave(tbl18, paste0(path, "/Table 4. Adjusted hazard ratios interaction in Stroma ROIs cluster option.pdf"))
```
<br>

# KM Low/High group
## White
```{r, fig.height=8}
clin_surv <- ROI_global %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  filter(race == "White") %>% 
  distinct(suid, .keep_all = TRUE)
mysurv <- Surv(time = clin_surv$timeint_fu, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_total)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
myplot <- ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on White matched population", subtitle = "Grouping based on intratumoral overall CD3+ cells",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "", 
           legend.labs = c("High", "Low"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(0, 8000),
           # Add risk table
           tables.height = 0.25,
           risk.table.title = "Risk table",
           risk.table = TRUE,
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
myplot$plot <- myplot$plot + 
  scale_x_continuous(breaks = c(seq(0, 8000, 2000)))
myplot
# dev.off()

clin_surv <- ROI_global %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  filter(race == "White") %>% 
  distinct(suid, .keep_all = TRUE)
mysurv <- Surv(time = clin_surv$timeint_fu, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_CD8_total)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3CD8 grp matched pop.pdf"), width = 8, height = 7)
myplot <- ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on White matched population", subtitle = "Grouping based on intratumoral overall CD3+CD8+ cells",
           font.main = c(14, "bold", "black"), font.subtitle = c(10, "plain", "black"),
           xlab = "Time (days)", legend.title = "", 
           legend.labs = c("High", "Low"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(0, 8000),
           # Add risk table
           tables.height = 0.25,
           risk.table.title = "Risk table",
           risk.table = TRUE,
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
myplot$plot <- myplot$plot + 
  scale_x_continuous(breaks = c(seq(0, 8000, 2000)))
myplot
# dev.off()
```

## Black
```{r, fig.height=8}
clin_surv <- ROI_global %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  filter(race == "Black") %>% 
  distinct(suid, .keep_all = TRUE)
mysurv <- Surv(time = clin_surv$timeint_fu, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_total)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
myplot <- ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on Black matched population", subtitle = "Grouping based on intratumoral overall CD3+ cells",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "", 
           legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(0, 8000),
           # Add risk table
           tables.height = 0.25,
           risk.table.title = "Risk table",
           risk.table = TRUE,
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
myplot$plot <- myplot$plot + 
  scale_x_continuous(breaks = c(seq(0, 8000, 2000)))
myplot
# dev.off()

clin_surv <- ROI_global %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  filter(race == "Black") %>% 
  distinct(suid, .keep_all = TRUE)
mysurv <- Surv(time = clin_surv$timeint_fu, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_CD8_total)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3CD8 grp matched pop.pdf"), width = 8, height = 7)
myplot <- ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on Black matched population", subtitle = "Grouping based on intratumoral overall CD3+CD8+ cells",
           font.main = c(14, "bold", "black"), font.subtitle = c(10, "plain", "black"),
           xlab = "Time (days)", legend.title = "", 
           legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(0, 8000),
           # Add risk table
           tables.height = 0.25,
           risk.table.title = "Risk table",
           risk.table = TRUE,
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
myplot$plot <- myplot$plot + 
  scale_x_continuous(breaks = c(seq(0, 8000, 2000)))
myplot
# dev.off()
```

<br>

# HR Cluster
`r emo::ji("pad")` Note to remember. The cluster were built on the data with the averaged measurement. I am not using the cluster option in the coxph even though I saw a really slight change in CI values but not in p value.  

<!-- **Removed 4 patients no BMI** -->

## Overall
```{r Table HR cluster}
markers_ROI <- markers_ROI # %>% # filter(!str_detect(suid, remove_id_bmi))


tbl1 <- coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ clusters_all_IandP + stage + refage + race, data =  markers_ROI)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = clusters_all_IandP) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ dbl_pos + stage + refage + race, data =  markers_ROI) %>%
  tbl_regression(exponentiate = TRUE,
                 include = dbl_pos) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ clusters_CD3CD8 + stage + refage + race, data =  markers_ROI) %>%
  tbl_regression(exponentiate = TRUE,
                 include = clusters_CD3CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ clusters_CD3FoxP3 + stage + refage + race, data =  markers_ROI) %>%
  tbl_regression(exponentiate = TRUE,
                 include = clusters_CD3FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ clusters_FoxP3_ + stage + refage + race, data =  markers_ROI) %>%
  tbl_regression(exponentiate = TRUE,
                 include = clusters_FoxP3_) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl6 <- coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ clusters_CD11bCD15 + stage + refage + race, data =  markers_ROI) %>%
  tbl_regression(exponentiate = TRUE,
                 include = clusters_CD11bCD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl10 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5, tbl6))
tbl10
```

## In White (I can bind W/B if you want them side by side)
```{r Table HR white}
markers_ROI_white <- markers_ROI %>%
  filter(race == "White")
  
tbl1 <- coxph(Surv(time = markers_ROI_white$timeint_fu, 
                   event = markers_ROI_white$surv_vital) ~ clusters_all_IandP + stage + refage, data =  markers_ROI_white)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = clusters_all_IandP) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI_white$timeint_fu, 
                   event = markers_ROI_white$surv_vital) ~ dbl_pos + stage + refage, data =  markers_ROI_white) %>%
  tbl_regression(exponentiate = TRUE,
                 include = dbl_pos) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- coxph(Surv(time = markers_ROI_white$timeint_fu, 
                   event = markers_ROI_white$surv_vital) ~ clusters_CD3CD8 + stage + refage, data =  markers_ROI_white) %>%
  tbl_regression(exponentiate = TRUE,
                 include = clusters_CD3CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROI_white$timeint_fu, 
                   event = markers_ROI_white$surv_vital) ~ clusters_CD3FoxP3 + stage + refage, data =  markers_ROI_white) %>%
  tbl_regression(exponentiate = TRUE,
                 include = clusters_CD3FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROI_white$timeint_fu, 
                   event = markers_ROI_white$surv_vital) ~ clusters_FoxP3_ + stage + refage, data =  markers_ROI_white) %>%
  tbl_regression(exponentiate = TRUE,
                 include = clusters_FoxP3_) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl6 <- coxph(Surv(time = markers_ROI_white$timeint_fu, 
                   event = markers_ROI_white$surv_vital) ~ clusters_CD11bCD15 + stage + refage, data =  markers_ROI_white) %>%
  tbl_regression(exponentiate = TRUE,
                 include = clusters_CD11bCD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl10 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5, tbl6))
tbl10
```

## In Black
```{r Table cluster black}
markers_ROI_black <- markers_ROI %>%
  filter(race == "Black")
  
tbl1 <- coxph(Surv(time = markers_ROI_black$timeint_fu, 
                   event = markers_ROI_black$surv_vital) ~ clusters_all_IandP + stage + refage, data =  markers_ROI_black)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = clusters_all_IandP) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI_black$timeint_fu, 
                   event = markers_ROI_black$surv_vital) ~ dbl_pos + stage + refage, data =  markers_ROI_black) %>%
  tbl_regression(exponentiate = TRUE,
                 include = dbl_pos) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl3 <- coxph(Surv(time = markers_ROI_black$timeint_fu, 
                   event = markers_ROI_black$surv_vital) ~ clusters_CD3CD8 + stage + refage, data =  markers_ROI_black) %>%
  tbl_regression(exponentiate = TRUE,
                 include = clusters_CD3CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl4 <- coxph(Surv(time = markers_ROI_black$timeint_fu, 
                   event = markers_ROI_black$surv_vital) ~ clusters_CD3FoxP3 + stage + refage, data =  markers_ROI_black) %>%
  tbl_regression(exponentiate = TRUE,
                 include = clusters_CD3FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl5 <- coxph(Surv(time = markers_ROI_black$timeint_fu, 
                   event = markers_ROI_black$surv_vital) ~ clusters_FoxP3_ + stage + refage, data =  markers_ROI_black) %>%
  tbl_regression(exponentiate = TRUE,
                 include = clusters_FoxP3_) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl6 <- coxph(Surv(time = markers_ROI_black$timeint_fu, 
                   event = markers_ROI_black$surv_vital) ~ clusters_CD11bCD15 + stage + refage, data =  markers_ROI_black) %>%
  tbl_regression(exponentiate = TRUE,
                 include = clusters_CD11bCD15) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl10 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5, tbl6))
tbl10
```
<br>

# KM Cluster group
## White
```{r, fig.height=8}
clin_surv <- markers_ROI_white 
mysurv <- Surv(time = clin_surv$timeint_fu, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$clusters_all_IandP)

myplot <- ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on White matched population", #subtitle = "Grouping based on intratumoral overall CD3+ cells",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "", 
           legend.labs = c("Signature 5", "Signature 1", "Signature 3", "Signature 4", "Signature 2"),
           palette = c("#FDE725FF", "#440154FF", "#21908CFF", "#5DC863FF", "#3B528BFF"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(0, 8000),
           # Add risk table
           tables.height = 0.25,
           risk.table.title = "Risk table",
           risk.table = TRUE,
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
myplot$plot <- myplot$plot + 
  scale_x_continuous(breaks = c(seq(0, 8000, 2000)))
myplot
# dev.off()
```

## Black
```{r, fig.height=8}
clin_surv <- markers_ROI_black
mysurv <- Surv(time = clin_surv$timeint_fu, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$clusters_all_IandP)

myplot <- ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on Black matched population", #subtitle = "Grouping based on intratumoral overall CD3+ cells",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "", 
           legend.labs = c("Signature 5", "Signature 1", "Signature 3", "Signature 4", "Signature 2"),
           palette = c("#FDE725FF", "#440154FF", "#21908CFF", "#5DC863FF", "#3B528BFF"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(0, 8000),
           # Add risk table
           tables.height = 0.25,
           risk.table.title = "Risk table",
           risk.table = TRUE,
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
myplot$plot <- myplot$plot + 
  scale_x_continuous(breaks = c(seq(0, 8000, 2000)))
myplot
# dev.off()
```
<br>


# HR immunoscore
`r emo::ji("pad")` Note to remember. The immunoscore were built on the data with the averaged measurement. I am not using the cluster option in the coxph even though I saw a really slight change in CI and p value.  

## Overall
```{r Table HR Immunoscore}
  
tbl1 <- coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ immunoscore_patients + stage + refage + race, data =  markers_ROI)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = immunoscore_patients) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ immunoscore_2018lancet_patients + stage + refage + race, data =  markers_ROI) %>%
  tbl_regression(exponentiate = TRUE,
                 include = immunoscore_2018lancet_patients) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl10 <- tbl_stack(list(tbl1, tbl2))
tbl10
```

## In White (I can bind W/B if you want them side by side)
```{r Table HR Immunoscore white}
markers_ROI_white <- markers_ROI %>%
  filter(race == "White")
  
tbl1 <- coxph(Surv(time = markers_ROI_white$timeint_fu, 
                   event = markers_ROI_white$surv_vital) ~ immunoscore_patients + stage + refage, data =  markers_ROI_white)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = immunoscore_patients) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI_white$timeint_fu, 
                   event = markers_ROI_white$surv_vital) ~ immunoscore_2018lancet_patients + stage + refage, data =  markers_ROI_white) %>%
  tbl_regression(exponentiate = TRUE,
                 include = immunoscore_2018lancet_patients) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl10 <- tbl_stack(list(tbl1, tbl2))
tbl10
```

## In Black
```{r Table HR Immunoscore black}
markers_ROI_black <- markers_ROI %>%
  filter(race == "Black")
  
tbl1 <- coxph(Surv(time = markers_ROI_black$timeint_fu, 
                   event = markers_ROI_black$surv_vital) ~ immunoscore_patients + stage + refage, data =  markers_ROI_black)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = immunoscore_patients) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI_black$timeint_fu, 
                   event = markers_ROI_black$surv_vital) ~ immunoscore_2018lancet_patients + stage + refage, data =  markers_ROI_black) %>%
  tbl_regression(exponentiate = TRUE,
                 include = immunoscore_2018lancet_patients) %>% bold_p(t = .05) %>% add_nevent(location = "level") %>% add_n(location = "level")

tbl10 <- tbl_stack(list(tbl1, tbl2))
tbl10
```
<br>

# KM Immunoscore group
## White
```{r, fig.height=8}
clin_surv <- markers_ROI_white 
mysurv <- Surv(time = clin_surv$timeint_fu, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$immunoscore_2018lancet_patients)

ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on White matched population", #subtitle = "Grouping based on intratumoral overall CD3+ cells",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "", 
           legend.labs = c("High", "Intermediate", "Low"),
           palette = c("#7D2482FF", "#C83E73FF", "#FCD225FF"),
           pval = TRUE,
           conf.int = FALSE,
           # xlim = c(0, 8000),
           # Add risk table
           tables.height = 0.25,
           risk.table.title = "Risk table",
           risk.table = TRUE,
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
myplot$plot <- myplot$plot + 
  scale_x_continuous(breaks = c(seq(0, 8000, 2000)))
myplot
# dev.off()
```

## Black
```{r, fig.height=8}
clin_surv <- markers_ROI_black
mysurv <- Surv(time = clin_surv$timeint_fu, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$immunoscore_2018lancet_patients)

myplot <- ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on Black matched population", #subtitle = "Grouping based on intratumoral overall CD3+ cells",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "", 
           legend.labs = c("High", "Intermediate", "Low"),
           palette = c("#7D2482FF", "#C83E73FF", "#FCD225FF"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(0, 8000),
           # Add risk table
           tables.height = 0.25,
           risk.table.title = "Risk table",
           risk.table = TRUE,
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
myplot$plot <- myplot$plot + 
  scale_x_continuous(breaks = c(seq(0, 8000, 2000)))
myplot
# dev.off()
```
<br>













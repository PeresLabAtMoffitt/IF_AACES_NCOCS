---
title: "Immune marker time to interview"
author: "Christelle Colin-Leitzinger"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: cerulean #darkly
    highlight: pygments
    df_print: paged
editor_options: 
  chunk_output_type: console
---

<style type="text/css">
h1.title {
  font-size: 25px;
}
.figure {
   margin-top: 25px;
   <!-- margin-bottom: 100px; -->
}

table {
    margin-top: 25px;
    <!-- margin-bottom: 100px !important; -->
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      # fig.width = 7, fig.height = 5, 
                      fig.align='center'#, fig.show='hold'
                      )
options(gtsummary.print_engine = "gt")
options(gtsummary.as_gt.addl_cmds = "gt::tab_options(table.font.size = 14, data_row.padding = gt::px(1))")
```

<style>
div.blue { background-color:#0099CC; border-radius: 5px; padding: 20px; font-size: 38px}
</style>
<div class = "blue">

<span style="color: white;">Investigate BRCA mutation</span>

</div>
<br>

```{r library, include=FALSE}
# library(drake)
library(tidyverse)
library(data.table)
# library(VennDiagram)
library(gtsummary)
library(survival)
library(survminer)
library(psych)
# library(corrplot)
# library(ggcorrplot)
library(mclust)
library(sensemakr)
```

```{r load}

ROI_global <- readRDS("/Users/colinccm/Documents/GitHub/Peres/IF_AACES_NCOCS/ROI_global.rds")
clinical_data <- readRDS("/Users/colinccm/Documents/GitHub/Peres/IF_AACES_NCOCS/clinical_data.rds")

# Rewove patients not matched or lost match
ROI_global <- left_join(ROI_global, clinical_data, by="suid") %>% drop_na(pair_id) %>% 
  filter(!image_tag %in% c("Peres_P1_150163  3D_[44113,18531].tif", 
                           "Peres_P1_43004 A2_[45654,5840].tif",
                           "Peres_P1_43773 D2_[60849,15244].tif", 
                         "Peres_P1_AACES 130033_[37754,17929].tif",
                         "Peres_P1_AACES 130033_[38351,13944].tif"
                           )) %>% 
  group_by(pair_id) %>% 
  mutate(have_a_match = dense_rank(interaction(suid, pair_id))) %>% 
  group_by(pair_id) %>% 
  mutate(is_paired = max(have_a_match)) %>% 
  filter(is_paired == 2) %>% 
  select(pair_id, everything(), -c(is_paired, have_a_match)) %>% 
  ungroup()

# markers_match <- readRDS("/Users/colinccm/Documents/GitHub/Peres/IF_AACES_NCOCS/markers_match.rds")
path <- fs::path("","Volumes","Peres_Research","Christelle Colin-Leitzinger", "IF_AACES_NCOCS", "Disparities manuscript", "Figures")

# Remove these IDs from peripheral ROI because 2 are NAs and 2 are there matched
remove_id <- paste0(c("110318", "43220", "42774", "46619"), collapse = "|")
```
<br>
<br>

***

```{r}
ROI_global %>% 
  distinct(suid, .keep_all = TRUE) %>% 
  select(brca1, brca2, 
         race) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
              # type = list(c(brca2, famhxov) ~ "categorical"),

              digits = list(all_continuous() ~ 1)) %>%
      modify_header(list(label ~ "**Patient characteristics**", all_stat_cols() ~ "**{level}**, N = {n}")) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% as_gt()
```


```{r}
# tbl <- ROI_global %>% 
#   distinct(suid, .keep_all = TRUE) %>% 
#   select(refage, refage_cat, stage, BMI_recent, BMI_recent_grp,
#         smoker, diab,
#          dblkstat_CA125, adj,
#          race) %>% 
#   tbl_summary(by = race,
#               statistic = list(all_continuous() ~ "{mean} ({sd})"),
#               label = list(refage ~ "Age at diagnosis", refage_cat ~ "Age at diagnosis category",
#                            dblkstat_CA125 ~ "Debulking Status", adj ~ "Adjuvant chemotherapy",
#                            smoker ~ "Smoking status"),
#               type = list(diab ~ "categorical"),
#               digits = list(all_continuous() ~ 1)) %>%
#       modify_header(list(label ~ "**Patient characteristics**", all_stat_cols() ~ "**{level}**, N = {n}")) %>% 
#   add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% as_gt()
# tbl
# # gt::gtsave(tbl, paste0(path, "/Table 1 Patient characteristics overall and by race_ethnicity.pdf"))

```
<br>

***


```{r summarize mean brca2}
markers_ROI <- readRDS("/Users/colinccm/Documents/GitHub/Peres/IF_AACES_NCOCS/markers_ROI.rds")
```

# Abundance countinous by brca2
```{r Table tumor cells in ROIs brca2}
# reset_gtsummary_theme()
# theme_gtsummary_journal(journal = "jama")
tbl1 <-
  markers_ROI %>% 
  select(percent_CD3_tumor.i, percent_CD3_CD8_tumor.i, percent_CD3_FoxP3_tumor.i, 
              percent_CD11b_tumor.i, percent_CD11b_CD15_tumor.i,
         brca2) %>% 
  rename(percent_CD3_tumor = percent_CD3_tumor.i, percent_CD3_CD8_tumor = percent_CD3_CD8_tumor.i,
         percent_CD3_FoxP3_tumor = percent_CD3_FoxP3_tumor.i, 
         percent_CD11b_tumor = percent_CD11b_tumor.i, percent_CD11b_CD15_tumor = percent_CD11b_CD15_tumor.i) %>% 
  tbl_summary(by = brca2,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
              label = list(percent_CD3_tumor ~ "percent CD3+", percent_CD3_CD8_tumor ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_tumor ~ "percent CD3+/FoxP3+",
                           percent_CD11b_tumor ~ "percent CD11b+", percent_CD11b_CD15_tumor ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl2 <-
  markers_ROI %>% 
  select(percent_CD3_stroma.i, percent_CD3_CD8_stroma.i, percent_CD3_FoxP3_stroma.i, 
              percent_CD11b_stroma.i, percent_CD11b_CD15_stroma.i,
         brca2) %>% 
  rename(percent_CD3_stroma = percent_CD3_stroma.i, percent_CD3_CD8_stroma = percent_CD3_CD8_stroma.i,
         percent_CD3_FoxP3_stroma = percent_CD3_FoxP3_stroma.i, 
         percent_CD11b_stroma = percent_CD11b_stroma.i, percent_CD11b_CD15_stroma = percent_CD11b_CD15_stroma.i) %>% 
  tbl_summary(by = brca2,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                           label = list(percent_CD3_stroma ~ "percent CD3+", percent_CD3_CD8_stroma ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_stroma ~ "percent CD3+/FoxP3+",
                           percent_CD11b_stroma ~ "percent CD11b+", percent_CD11b_CD15_stroma ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 
tbl3 <-
  markers_ROI %>% 
  select(percent_CD3_total.i, percent_CD3_CD8_total.i, percent_CD3_FoxP3_total.i, 
              percent_CD11b_total.i, percent_CD11b_CD15_total.i,
         brca2) %>% 
  rename(percent_CD3_total = percent_CD3_total.i, percent_CD3_CD8_total = percent_CD3_CD8_total.i,
         percent_CD3_FoxP3_total = percent_CD3_FoxP3_total.i, 
         percent_CD11b_total = percent_CD11b_total.i, percent_CD11b_CD15_total = percent_CD11b_CD15_total.i) %>% 
  tbl_summary(by = brca2,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                           label = list(percent_CD3_total ~ "percent CD3+", percent_CD3_CD8_total ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_total ~ "percent CD3+/FoxP3+",
                           percent_CD11b_total ~ "percent CD11b+", percent_CD11b_CD15_total ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 


tbl5 <-
  markers_ROI %>% 
  select(percent_CD3_tumor.p, percent_CD3_CD8_tumor.p, percent_CD3_FoxP3_tumor.p, 
              percent_CD11b_tumor.p, percent_CD11b_CD15_tumor.p,
         brca2) %>% 
  rename(percent_CD3_tumor = percent_CD3_tumor.p, percent_CD3_CD8_tumor = percent_CD3_CD8_tumor.p,
         percent_CD3_FoxP3_tumor = percent_CD3_FoxP3_tumor.p, 
         percent_CD11b_tumor = percent_CD11b_tumor.p, percent_CD11b_CD15_tumor = percent_CD11b_CD15_tumor.p) %>% 
  tbl_summary(by = brca2,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(percent_CD3_tumor ~ "percent CD3+", percent_CD3_CD8_tumor ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_tumor ~ "percent CD3+/FoxP3+",
                           percent_CD11b_tumor ~ "percent CD11b+", percent_CD11b_CD15_tumor ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl6 <-
  markers_ROI %>% 
  select(percent_CD3_stroma.p, percent_CD3_CD8_stroma.p, percent_CD3_FoxP3_stroma.p, 
              percent_CD11b_stroma.p, percent_CD11b_CD15_stroma.p,
         brca2) %>% 
  rename(percent_CD3_stroma = percent_CD3_stroma.p, percent_CD3_CD8_stroma = percent_CD3_CD8_stroma.p,
         percent_CD3_FoxP3_stroma = percent_CD3_FoxP3_stroma.p, 
         percent_CD11b_stroma = percent_CD11b_stroma.p, percent_CD11b_CD15_stroma = percent_CD11b_CD15_stroma.p) %>% 
  tbl_summary(by = brca2,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(percent_CD3_stroma ~ "percent CD3+", percent_CD3_CD8_stroma ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_stroma ~ "percent CD3+/FoxP3+",
                           percent_CD11b_stroma ~ "percent CD11b+", percent_CD11b_CD15_stroma ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl7 <-
  markers_ROI %>% 
  select(percent_CD3_total.p, percent_CD3_CD8_total.p, percent_CD3_FoxP3_total.p, 
              percent_CD11b_total.p, percent_CD11b_CD15_total.p,
         brca2) %>% 
  rename(percent_CD3_total = percent_CD3_total.p, percent_CD3_CD8_total = percent_CD3_CD8_total.p,
         percent_CD3_FoxP3_total = percent_CD3_FoxP3_total.p, 
         percent_CD11b_total = percent_CD11b_total.p, percent_CD11b_CD15_total = percent_CD11b_CD15_total.p) %>% 
  tbl_summary(by = brca2,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(percent_CD3_total ~ "percent CD3+", percent_CD3_CD8_total ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_total ~ "percent CD3+/FoxP3+",
                           percent_CD11b_total ~ "percent CD11b+", percent_CD11b_CD15_total ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 

tbl4 <- tbl_merge(list(tbl1, tbl5), tab_spanner = c("**Intratumoral**", "**Peripheral**"))
tbl8 <- tbl_merge(list(tbl2, tbl6), tab_spanner = c("**Intratumoral**", "**Peripheral**"))
tbl9 <- tbl_merge(list(tbl3, tbl7), tab_spanner = c("**Intratumoral**", "**Peripheral**"))


tbl10 <- tbl_stack(list(tbl4, tbl8, tbl9), group_header = c("Tumor", "Stroma", "Overall")) %>% as_gt()
tbl10

# gt::gtsave(tbl10, paste0(path, "/Table 2a Distribution of immune cell abundance in ROIs.pdf"))

# tbl8 <- tbl_stack(list(tbl5, tbl6, tbl7), group_header = c("Tumor", "Stroma", "Overall"))
# tbl8
# 
# tbl <- tbl_merge(list(tbl4, tbl8), tab_spanner = c("**Intratumoral**", "**Peripheral**"))# %>%
#   # modify_spanning_header(everything() ~ "Overall (tmor+stroma) ROIs") %>% as_gt()
# tbl
```
<br>




# Abundance category

```{r Table classification cells in ROIs brca2}
tbl1 <-
  markers_ROI %>% 
  select(CD3_tumor.i, CD3_CD8_tumor.i, CD3_FoxP3_tumor.i, 
              CD11b_tumor.i, CD11b_CD15_tumor.i,
         brca2) %>% 
  rename(CD3_tumor = CD3_tumor.i, CD3_CD8_tumor = CD3_CD8_tumor.i,
         CD3_FoxP3_tumor = CD3_FoxP3_tumor.i, 
         CD11b_tumor = CD11b_tumor.i, CD11b_CD15_tumor = CD11b_CD15_tumor.i) %>% 
  tbl_summary(by = brca2,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
              label = list(CD3_tumor ~ "percent CD3+", CD3_CD8_tumor ~ "percent CD3+/CD8+",
                           CD3_FoxP3_tumor ~ "percent CD3+/FoxP3+",
                           CD11b_tumor ~ "percent CD11b+", CD11b_CD15_tumor ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl2 <-
  markers_ROI %>% 
  select(CD3_stroma.i, CD3_CD8_stroma.i, CD3_FoxP3_stroma.i, 
              CD11b_stroma.i, CD11b_CD15_stroma.i,
brca2) %>% 
  rename(CD3_stroma = CD3_stroma.i, CD3_CD8_stroma = CD3_CD8_stroma.i,
         CD3_FoxP3_stroma = CD3_FoxP3_stroma.i, 
CD11b_stroma = CD11b_stroma.i, CD11b_CD15_stroma = CD11b_CD15_stroma.i) %>% 
  tbl_summary(by = brca2,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                           label = list(CD3_stroma ~ "percent CD3+", CD3_CD8_stroma ~ "percent CD3+/CD8+",
                           CD3_FoxP3_stroma ~ "percent CD3+/FoxP3+",
                           CD11b_stroma ~ "percent CD11b+", CD11b_CD15_stroma ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 
tbl3 <-
  markers_ROI %>% 
  select(CD3_total.i, CD3_CD8_total.i, CD3_FoxP3_total.i, 
              CD11b_total.i, CD11b_CD15_total.i,
brca2) %>% 
  rename(CD3_total = CD3_total.i, CD3_CD8_total = CD3_CD8_total.i,
         CD3_FoxP3_total = CD3_FoxP3_total.i, 
CD11b_total = CD11b_total.i, CD11b_CD15_total = CD11b_CD15_total.i) %>% 
  tbl_summary(by = brca2,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                           label = list(CD3_total ~ "percent CD3+", CD3_CD8_total ~ "percent CD3+/CD8+",
                           CD3_FoxP3_total ~ "percent CD3+/FoxP3+",
                           CD11b_total ~ "percent CD11b+", CD11b_CD15_total ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 


tbl5 <-
  markers_ROI %>% 
  select(CD3_tumor.p, CD3_CD8_tumor.p, CD3_FoxP3_tumor.p, 
              CD11b_tumor.p, CD11b_CD15_tumor.p,
brca2) %>% 
  rename(CD3_tumor = CD3_tumor.p, CD3_CD8_tumor = CD3_CD8_tumor.p,
         CD3_FoxP3_tumor = CD3_FoxP3_tumor.p, 
CD11b_tumor = CD11b_tumor.p, CD11b_CD15_tumor = CD11b_CD15_tumor.p) %>% 
  tbl_summary(by = brca2,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(CD3_tumor ~ "percent CD3+", CD3_CD8_tumor ~ "percent CD3+/CD8+",
                           CD3_FoxP3_tumor ~ "percent CD3+/FoxP3+",
                           CD11b_tumor ~ "percent CD11b+", CD11b_CD15_tumor ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl6 <-
  markers_ROI %>% 
  select(CD3_stroma.p, CD3_CD8_stroma.p, CD3_FoxP3_stroma.p, 
              CD11b_stroma.p, CD11b_CD15_stroma.p,
brca2) %>% 
  rename(CD3_stroma = CD3_stroma.p, CD3_CD8_stroma = CD3_CD8_stroma.p,
         CD3_FoxP3_stroma = CD3_FoxP3_stroma.p, 
CD11b_stroma = CD11b_stroma.p, CD11b_CD15_stroma = CD11b_CD15_stroma.p) %>% 
  tbl_summary(by = brca2,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(CD3_stroma ~ "percent CD3+", CD3_CD8_stroma ~ "percent CD3+/CD8+",
                           CD3_FoxP3_stroma ~ "percent CD3+/FoxP3+",
                           CD11b_stroma ~ "percent CD11b+", CD11b_CD15_stroma ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl7 <-
  markers_ROI %>% 
  select(CD3_total.p, CD3_CD8_total.p, CD3_FoxP3_total.p, 
              CD11b_total.p, CD11b_CD15_total.p,
brca2) %>% 
  rename(CD3_total = CD3_total.p, CD3_CD8_total = CD3_CD8_total.p,
         CD3_FoxP3_total = CD3_FoxP3_total.p, 
CD11b_total = CD11b_total.p, CD11b_CD15_total = CD11b_CD15_total.p) %>% 
  tbl_summary(by = brca2,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(CD3_total ~ "percent CD3+", CD3_CD8_total ~ "percent CD3+/CD8+",
                           CD3_FoxP3_total ~ "percent CD3+/FoxP3+",
                           CD11b_total ~ "percent CD11b+", CD11b_CD15_total ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 

tbl4 <- tbl_merge(list(tbl1, tbl5), tab_spanner = c("**Intratumoral**", "**Peripheral**"))
tbl8 <- tbl_merge(list(tbl2, tbl6), tab_spanner = c("**Intratumoral**", "**Peripheral**"))
tbl9 <- tbl_merge(list(tbl3, tbl7), tab_spanner = c("**Intratumoral**", "**Peripheral**"))


tbl10 <- tbl_stack(list(tbl4, tbl8, tbl9), group_header = c("Tumor", "Stroma", "Overall")) %>% as_gt() %>% 
    gt::tab_source_note(gt::md('**"Low" represent categories with less than 1% immune cells detected while "Absent" represent categories with no immune cells detected**'))

tbl10
# gt::gtsave(tbl10, paste0(path, "/Table 2b Distribution of immune cell abundance absent_1percent categories in ROIs.pdf"))
```
<br>

***

# Immunoscore

When we decided for every group I can put cluster and immunoscore together in the same table.
I took the immunoscore calculated on the mean of the 3 value per patient.

```{r Table immunoscore brca2}
tbl <- markers_ROI %>% 
  select(immunoscore_patients, immunoscore_2018lancet_patients,
         brca2) %>% 
  tbl_summary(by = brca2,
              label = list(immunoscore_patients ~ "classic immunoscore", 
                           immunoscore_2018lancet_patients ~ "immunoscore lancet"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() %>% as_gt()
tbl
# gt::gtsave(tbl10, paste0(path, "/Table 2c Immunoscore in ROIs.pdf"))
```
<b>

***
<br>

# Cluster

## Cluster with a non-defined number of cluster **when looking at all intra/periph + tumor/stroma (CD3, CD3/8, CD3/FoxP3, CD11b, CD11b/15)**  
**Each markers are scaled, default method is center**  


```{r Table cluster brca2}
tbl <- markers_ROI %>% 
  select(clusters_all_IandP, dbl_pos, clusters_CD3CD8, clusters_CD3FoxP3, clusters_FoxP3_, clusters_CD11bCD15,
         brca2) %>% 
  tbl_summary(by = brca2,
              label = list(clusters_all_IandP ~ "intra+periph, tumor+stroma", dbl_pos ~ "all double positive",
                           clusters_CD3CD8 ~ "CD3+/CD8+",
                           clusters_CD3FoxP3 ~ "CD3+/FoxP3+", clusters_FoxP3_ ~ "FoxP3+",
                           clusters_CD11bCD15 ~ "CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() %>% as_gt()
tbl
# gt::gtsave(tbl, paste0(path, "/Table 2d Cluster in ROIs.pdf"))
```

# Survival
```{r}
clin_surv <- markers_ROI
mysurv <- Surv(time = clin_surv$timelastfu_new, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$brca2)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "brca2", 
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```

# brca2 = Carrier
## Intratumoral
```{r}
clin_surv <- markers_ROI %>% 
  # filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  filter(brca2 == "Carrier")
mysurv <- Surv(time = clin_surv$timelastfu_new, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_total.i)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "brca2", 
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```

## Peripheral
```{r}
clin_surv <- markers_ROI %>% 
  filter(brca2 == "Carrier")
mysurv <- Surv(time = clin_surv$timelastfu_new, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_total.p)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "brca2", 
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```

# White
## Intratumoral
0 patients
```{r}
# clin_surv <- markers_ROI %>% 
#   filter(brca2 == "Carrier") %>% 
#   filter(race == "White")
# mysurv <- Surv(time = clin_surv$timelastfu_new, event = clin_surv$surv_vital)
# myplot <- survfit(mysurv~clin_surv$CD3_total.i)
# 
# # pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
# ggsurvplot(myplot, data = clin_surv,
#            title = "Survival analysis on matched population",
#            font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
#            xlab = "Time (days)", legend.title = "brca2", 
#            # legend.labs = c("high", "low"),
#            pval = TRUE,
#            conf.int = FALSE,
#            xlim = c(-10, 8000),
#            # Add risk table
#            tables.height = 0.3,
#            risk.table.title = "Risk table (number(%))",
#            risk.table = "abs_pct",
#            risk.table.y.text = FALSE,
#            risk.table.fontsize = 4,
#            tables.theme = theme_survminer(base_size = 5,
#                                           font.main = c(16, "bold", "black"),
#                                           font.x = c(14, "bold", "black"),
#                                           font.y = c(16, "bold", "transparent"),
#                                           font.tickslab = c(14, "bold", "black"))
# )
```

## Peripheral
```{r}
# clin_surv <- markers_ROI %>% 
#   filter(brca2 == "Carrier") %>% 
#   filter(race == "White")
# mysurv <- Surv(time = clin_surv$timelastfu_new, event = clin_surv$surv_vital)
# myplot <- survfit(mysurv~clin_surv$CD3_total.p)
# 
# # pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
# ggsurvplot(myplot, data = clin_surv,
#            title = "Survival analysis on matched population",
#            font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
#            xlab = "Time (days)", legend.title = "brca2", 
#            # legend.labs = c("high", "low"),
#            pval = TRUE,
#            conf.int = FALSE,
#            xlim = c(-10, 8000),
#            # Add risk table
#            tables.height = 0.3,
#            risk.table.title = "Risk table (number(%))",
#            risk.table = "abs_pct",
#            risk.table.y.text = FALSE,
#            risk.table.fontsize = 4,
#            tables.theme = theme_survminer(base_size = 5,
#                                           font.main = c(16, "bold", "black"),
#                                           font.x = c(14, "bold", "black"),
#                                           font.y = c(16, "bold", "transparent"),
#                                           font.tickslab = c(14, "bold", "black"))
# )
```

# Black (Are the same as Overall because no White with brca2)
## Intratumoral
```{r}
clin_surv <- markers_ROI %>% 
  filter(brca2 == "Carrier") %>% 
  filter(race == "Black")
mysurv <- Surv(time = clin_surv$timelastfu_new, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_total.i)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "brca2", 
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```

## Peripheral
```{r}
clin_surv <- markers_ROI %>% 
  filter(brca2 == "Carrier") %>% 
  filter(race == "Black")
mysurv <- Surv(time = clin_surv$timelastfu_new, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_total.p)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "brca2", 
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```
<br>
<br>

***


# Abundance countinous by brca1
```{r Table tumor cells in ROIs brca1}
tbl1 <-
  markers_ROI %>% 
  select(percent_CD3_tumor.i, percent_CD3_CD8_tumor.i, percent_CD3_FoxP3_tumor.i, 
              percent_CD11b_tumor.i, percent_CD11b_CD15_tumor.i,
         brca1) %>% 
  rename(percent_CD3_tumor = percent_CD3_tumor.i, percent_CD3_CD8_tumor = percent_CD3_CD8_tumor.i,
         percent_CD3_FoxP3_tumor = percent_CD3_FoxP3_tumor.i, 
         percent_CD11b_tumor = percent_CD11b_tumor.i, percent_CD11b_CD15_tumor = percent_CD11b_CD15_tumor.i) %>% 
  tbl_summary(by = brca1,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
              label = list(percent_CD3_tumor ~ "percent CD3+", percent_CD3_CD8_tumor ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_tumor ~ "percent CD3+/FoxP3+",
                           percent_CD11b_tumor ~ "percent CD11b+", percent_CD11b_CD15_tumor ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl2 <-
  markers_ROI %>% 
  select(percent_CD3_stroma.i, percent_CD3_CD8_stroma.i, percent_CD3_FoxP3_stroma.i, 
              percent_CD11b_stroma.i, percent_CD11b_CD15_stroma.i,
         brca1) %>% 
  rename(percent_CD3_stroma = percent_CD3_stroma.i, percent_CD3_CD8_stroma = percent_CD3_CD8_stroma.i,
         percent_CD3_FoxP3_stroma = percent_CD3_FoxP3_stroma.i, 
         percent_CD11b_stroma = percent_CD11b_stroma.i, percent_CD11b_CD15_stroma = percent_CD11b_CD15_stroma.i) %>% 
  tbl_summary(by = brca1,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                           label = list(percent_CD3_stroma ~ "percent CD3+", percent_CD3_CD8_stroma ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_stroma ~ "percent CD3+/FoxP3+",
                           percent_CD11b_stroma ~ "percent CD11b+", percent_CD11b_CD15_stroma ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 
tbl3 <-
  markers_ROI %>% 
  select(percent_CD3_total.i, percent_CD3_CD8_total.i, percent_CD3_FoxP3_total.i, 
              percent_CD11b_total.i, percent_CD11b_CD15_total.i,
         brca1) %>% 
  rename(percent_CD3_total = percent_CD3_total.i, percent_CD3_CD8_total = percent_CD3_CD8_total.i,
         percent_CD3_FoxP3_total = percent_CD3_FoxP3_total.i, 
         percent_CD11b_total = percent_CD11b_total.i, percent_CD11b_CD15_total = percent_CD11b_CD15_total.i) %>% 
  tbl_summary(by = brca1,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                           label = list(percent_CD3_total ~ "percent CD3+", percent_CD3_CD8_total ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_total ~ "percent CD3+/FoxP3+",
                           percent_CD11b_total ~ "percent CD11b+", percent_CD11b_CD15_total ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 


tbl5 <-
  markers_ROI %>% 
  select(percent_CD3_tumor.p, percent_CD3_CD8_tumor.p, percent_CD3_FoxP3_tumor.p, 
              percent_CD11b_tumor.p, percent_CD11b_CD15_tumor.p,
         brca1) %>% 
  rename(percent_CD3_tumor = percent_CD3_tumor.p, percent_CD3_CD8_tumor = percent_CD3_CD8_tumor.p,
         percent_CD3_FoxP3_tumor = percent_CD3_FoxP3_tumor.p, 
         percent_CD11b_tumor = percent_CD11b_tumor.p, percent_CD11b_CD15_tumor = percent_CD11b_CD15_tumor.p) %>% 
  tbl_summary(by = brca1,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(percent_CD3_tumor ~ "percent CD3+", percent_CD3_CD8_tumor ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_tumor ~ "percent CD3+/FoxP3+",
                           percent_CD11b_tumor ~ "percent CD11b+", percent_CD11b_CD15_tumor ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl6 <-
  markers_ROI %>% 
  select(percent_CD3_stroma.p, percent_CD3_CD8_stroma.p, percent_CD3_FoxP3_stroma.p, 
              percent_CD11b_stroma.p, percent_CD11b_CD15_stroma.p,
         brca1) %>% 
  rename(percent_CD3_stroma = percent_CD3_stroma.p, percent_CD3_CD8_stroma = percent_CD3_CD8_stroma.p,
         percent_CD3_FoxP3_stroma = percent_CD3_FoxP3_stroma.p, 
         percent_CD11b_stroma = percent_CD11b_stroma.p, percent_CD11b_CD15_stroma = percent_CD11b_CD15_stroma.p) %>% 
  tbl_summary(by = brca1,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(percent_CD3_stroma ~ "percent CD3+", percent_CD3_CD8_stroma ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_stroma ~ "percent CD3+/FoxP3+",
                           percent_CD11b_stroma ~ "percent CD11b+", percent_CD11b_CD15_stroma ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl7 <-
  markers_ROI %>% 
  select(percent_CD3_total.p, percent_CD3_CD8_total.p, percent_CD3_FoxP3_total.p, 
              percent_CD11b_total.p, percent_CD11b_CD15_total.p,
         brca1) %>% 
  rename(percent_CD3_total = percent_CD3_total.p, percent_CD3_CD8_total = percent_CD3_CD8_total.p,
         percent_CD3_FoxP3_total = percent_CD3_FoxP3_total.p, 
         percent_CD11b_total = percent_CD11b_total.p, percent_CD11b_CD15_total = percent_CD11b_CD15_total.p) %>% 
  tbl_summary(by = brca1,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(percent_CD3_total ~ "percent CD3+", percent_CD3_CD8_total ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_total ~ "percent CD3+/FoxP3+",
                           percent_CD11b_total ~ "percent CD11b+", percent_CD11b_CD15_total ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 

tbl4 <- tbl_merge(list(tbl1, tbl5), tab_spanner = c("**Intratumoral**", "**Peripheral**"))
tbl8 <- tbl_merge(list(tbl2, tbl6), tab_spanner = c("**Intratumoral**", "**Peripheral**"))
tbl9 <- tbl_merge(list(tbl3, tbl7), tab_spanner = c("**Intratumoral**", "**Peripheral**"))


tbl10 <- tbl_stack(list(tbl4, tbl8, tbl9), group_header = c("Tumor", "Stroma", "Overall")) %>% as_gt()
tbl10
```
<br>




# Abundance category

```{r Table classification cells in ROIs brca1}
tbl1 <-
  markers_ROI %>% 
  select(CD3_tumor.i, CD3_CD8_tumor.i, CD3_FoxP3_tumor.i, 
              CD11b_tumor.i, CD11b_CD15_tumor.i,
         brca1) %>% 
  rename(CD3_tumor = CD3_tumor.i, CD3_CD8_tumor = CD3_CD8_tumor.i,
         CD3_FoxP3_tumor = CD3_FoxP3_tumor.i, 
         CD11b_tumor = CD11b_tumor.i, CD11b_CD15_tumor = CD11b_CD15_tumor.i) %>% 
  tbl_summary(by = brca1,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
              label = list(CD3_tumor ~ "percent CD3+", CD3_CD8_tumor ~ "percent CD3+/CD8+",
                           CD3_FoxP3_tumor ~ "percent CD3+/FoxP3+",
                           CD11b_tumor ~ "percent CD11b+", CD11b_CD15_tumor ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl2 <-
  markers_ROI %>% 
  select(CD3_stroma.i, CD3_CD8_stroma.i, CD3_FoxP3_stroma.i, 
              CD11b_stroma.i, CD11b_CD15_stroma.i,
brca1) %>% 
  rename(CD3_stroma = CD3_stroma.i, CD3_CD8_stroma = CD3_CD8_stroma.i,
         CD3_FoxP3_stroma = CD3_FoxP3_stroma.i, 
CD11b_stroma = CD11b_stroma.i, CD11b_CD15_stroma = CD11b_CD15_stroma.i) %>% 
  tbl_summary(by = brca1,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                           label = list(CD3_stroma ~ "percent CD3+", CD3_CD8_stroma ~ "percent CD3+/CD8+",
                           CD3_FoxP3_stroma ~ "percent CD3+/FoxP3+",
                           CD11b_stroma ~ "percent CD11b+", CD11b_CD15_stroma ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 
tbl3 <-
  markers_ROI %>% 
  select(CD3_total.i, CD3_CD8_total.i, CD3_FoxP3_total.i, 
              CD11b_total.i, CD11b_CD15_total.i,
brca1) %>% 
  rename(CD3_total = CD3_total.i, CD3_CD8_total = CD3_CD8_total.i,
         CD3_FoxP3_total = CD3_FoxP3_total.i, 
CD11b_total = CD11b_total.i, CD11b_CD15_total = CD11b_CD15_total.i) %>% 
  tbl_summary(by = brca1,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                           label = list(CD3_total ~ "percent CD3+", CD3_CD8_total ~ "percent CD3+/CD8+",
                           CD3_FoxP3_total ~ "percent CD3+/FoxP3+",
                           CD11b_total ~ "percent CD11b+", CD11b_CD15_total ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 


tbl5 <-
  markers_ROI %>% 
  select(CD3_tumor.p, CD3_CD8_tumor.p, CD3_FoxP3_tumor.p, 
              CD11b_tumor.p, CD11b_CD15_tumor.p,
brca1) %>% 
  rename(CD3_tumor = CD3_tumor.p, CD3_CD8_tumor = CD3_CD8_tumor.p,
         CD3_FoxP3_tumor = CD3_FoxP3_tumor.p, 
CD11b_tumor = CD11b_tumor.p, CD11b_CD15_tumor = CD11b_CD15_tumor.p) %>% 
  tbl_summary(by = brca1,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(CD3_tumor ~ "percent CD3+", CD3_CD8_tumor ~ "percent CD3+/CD8+",
                           CD3_FoxP3_tumor ~ "percent CD3+/FoxP3+",
                           CD11b_tumor ~ "percent CD11b+", CD11b_CD15_tumor ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl6 <-
  markers_ROI %>% 
  select(CD3_stroma.p, CD3_CD8_stroma.p, CD3_FoxP3_stroma.p, 
              CD11b_stroma.p, CD11b_CD15_stroma.p,
brca1) %>% 
  rename(CD3_stroma = CD3_stroma.p, CD3_CD8_stroma = CD3_CD8_stroma.p,
         CD3_FoxP3_stroma = CD3_FoxP3_stroma.p, 
CD11b_stroma = CD11b_stroma.p, CD11b_CD15_stroma = CD11b_CD15_stroma.p) %>% 
  tbl_summary(by = brca1,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(CD3_stroma ~ "percent CD3+", CD3_CD8_stroma ~ "percent CD3+/CD8+",
                           CD3_FoxP3_stroma ~ "percent CD3+/FoxP3+",
                           CD11b_stroma ~ "percent CD11b+", CD11b_CD15_stroma ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q()
tbl7 <-
  markers_ROI %>% 
  select(CD3_total.p, CD3_CD8_total.p, CD3_FoxP3_total.p, 
              CD11b_total.p, CD11b_CD15_total.p,
brca1) %>% 
  rename(CD3_total = CD3_total.p, CD3_CD8_total = CD3_CD8_total.p,
         CD3_FoxP3_total = CD3_FoxP3_total.p, 
CD11b_total = CD11b_total.p, CD11b_CD15_total = CD11b_CD15_total.p) %>% 
  tbl_summary(by = brca1,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(CD3_total ~ "percent CD3+", CD3_CD8_total ~ "percent CD3+/CD8+",
                           CD3_FoxP3_total ~ "percent CD3+/FoxP3+",
                           CD11b_total ~ "percent CD11b+", CD11b_CD15_total ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() 

tbl4 <- tbl_merge(list(tbl1, tbl5), tab_spanner = c("**Intratumoral**", "**Peripheral**"))
tbl8 <- tbl_merge(list(tbl2, tbl6), tab_spanner = c("**Intratumoral**", "**Peripheral**"))
tbl9 <- tbl_merge(list(tbl3, tbl7), tab_spanner = c("**Intratumoral**", "**Peripheral**"))


tbl10 <- tbl_stack(list(tbl4, tbl8, tbl9), group_header = c("Tumor", "Stroma", "Overall")) %>% as_gt() %>% 
    gt::tab_source_note(gt::md('**"Low" represent categories with less than 1% immune cells detected while "Absent" represent categories with no immune cells detected**'))

tbl10
```
<br>

***

# Immunoscore

When we decided for every group I can put cluster and immunoscore together in the same table.
I took the immunoscore calculated on the mean of the 3 value per patient.

```{r Table immunoscore brca1}
tbl <- markers_ROI %>% 
  select(immunoscore_patients, immunoscore_2018lancet_patients,
         brca1) %>% 
  tbl_summary(by = brca1,
              label = list(immunoscore_patients ~ "classic immunoscore", 
                           immunoscore_2018lancet_patients ~ "immunoscore lancet"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() %>% as_gt()
tbl
```
<b>

***
<br>

# Cluster

## Cluster with a non-defined number of cluster **when looking at all intra/periph + tumor/stroma (CD3, CD3/8, CD3/FoxP3, CD11b, CD11b/15)**  
**Each markers are scaled, default method is center**  


```{r Table cluster brca1}
tbl <- markers_ROI %>% 
  select(clusters_all_IandP, dbl_pos, clusters_CD3CD8, clusters_CD3FoxP3, clusters_FoxP3_, clusters_CD11bCD15,
         brca1) %>% 
  tbl_summary(by = brca1,
              label = list(clusters_all_IandP ~ "intra+periph, tumor+stroma", dbl_pos ~ "all double positive",
                           clusters_CD3CD8 ~ "CD3+/CD8+",
                           clusters_CD3FoxP3 ~ "CD3+/FoxP3+", clusters_FoxP3_ ~ "FoxP3+",
                           clusters_CD11bCD15 ~ "CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) %>% add_q() %>% as_gt()
tbl
```

# Survival
```{r}
clin_surv <- markers_ROI
mysurv <- Surv(time = clin_surv$timelastfu_new, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$brca1)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "brca1", 
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```

# brca1 = Carrier
## Intratumoral
```{r}
clin_surv <- markers_ROI %>% 
  # filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  filter(brca1 == "Carrier")
mysurv <- Surv(time = clin_surv$timelastfu_new, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_total.i)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "brca1", 
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```

## Peripheral
```{r}
clin_surv <- markers_ROI %>% 
  filter(brca1 == "Carrier")
mysurv <- Surv(time = clin_surv$timelastfu_new, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_total.p)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "brca1", 
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```

# White
## Intratumoral
```{r}
clin_surv <- markers_ROI %>%
  filter(brca1 == "Carrier") %>%
  filter(race == "White")
mysurv <- Surv(time = clin_surv$timelastfu_new, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_total.i)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "brca1",
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```

## Peripheral
```{r}
clin_surv <- markers_ROI %>%
  filter(brca1 == "Carrier") %>%
  filter(race == "White")
mysurv <- Surv(time = clin_surv$timelastfu_new, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_total.p)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "brca1",
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```

# Black (Are the same as Overall because no White with brca1)
## Intratumoral
```{r}
clin_surv <- markers_ROI %>% 
  filter(brca1 == "Carrier") %>% 
  filter(race == "Black")
mysurv <- Surv(time = clin_surv$timelastfu_new, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_total.i)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "brca1", 
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```

## Peripheral
```{r}
clin_surv <- markers_ROI %>% 
  filter(brca1 == "Carrier") %>% 
  filter(race == "Black")
mysurv <- Surv(time = clin_surv$timelastfu_new, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_total.p)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "brca1", 
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```


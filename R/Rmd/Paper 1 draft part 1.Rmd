---
title: "Immune marker data"
author: "Christelle Colin-Leitzinger"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: cerulean #darkly
    highlight: pygments
    df_print: paged
editor_options: 
  chunk_output_type: console
---

<style type="text/css">
h1.title {
  font-size: 25px;
}
.figure {
   margin-top: 25px;
   <!-- margin-bottom: 100px; -->
}

table {
    margin-top: 25px;
    <!-- margin-bottom: 100px !important; -->
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      # fig.width = 7, fig.height = 5, 
                      fig.align='center'#, fig.show='hold'
                      )
options(gtsummary.print_engine = "gt")
options(gtsummary.as_gt.addl_cmds = "gt::tab_options(table.font.size = 14, data_row.padding = gt::px(1))")
```

<style>
div.blue { background-color:#0099CC; border-radius: 5px; padding: 20px; font-size: 38px}
</style>
<div class = "blue">

<span style="color: white;">Manuscript draft</span>

</div>
<br>

```{r library, include=FALSE}
# library(drake)
library(tidyverse)
library(data.table)
# library(VennDiagram)
library(gtsummary)
library(survival)
library(survminer)
library(psych)
# library(corrplot)
# library(ggcorrplot)
library(mclust)
```

```{r load}
# loadd(clinical_data, ROI_tumor ,ROI_stroma ,ROI_total,
#       cases_match)

ROI_global <- readRDS("/Users/colinccm/Documents/GitHub/Peres/IF_AACES_NCOCS/ROI_global.rds")
clinical_data <- readRDS("/Users/colinccm/Documents/GitHub/Peres/IF_AACES_NCOCS/clinical_data.rds")

# Rewove patients not matched or lost match
ROI_global <- left_join(ROI_global, clinical_data, by="suid") %>% drop_na(pair_id) %>% 
  group_by(pair_id) %>% 
  mutate(have_a_match = dense_rank(interaction(suid, pair_id))) %>% 
  group_by(pair_id) %>% 
  mutate(is_paired = max(have_a_match)) %>% 
  filter(is_paired == 2) %>% 
  select(pair_id, everything(), -c(is_paired, have_a_match)) %>% 
  ungroup()

# markers_match <- readRDS("/Users/colinccm/Documents/GitHub/Peres/IF_AACES_NCOCS/markers_match.rds")
path <- fs::path("","Volumes","Peres_Research","Christelle Colin-Leitzinger", "IF_AACES_NCOCS", "Disparities manuscript", "Figures")



```
<br>
<br>

***

# Table 1.   Patient characteristics overall and by race/ethnicity

Please double check the BMI classification  
mutate(BMI_classification = case_when(
    BMI_recent < 18.5	~ "underweight",
    BMI_recent >=18.5 & BMI_recent <25 ~ "normal",
    BMI_recent >=25.0 & BMI_recent <30 ~ "overweight",
    BMI_recent >=30.0 & BMI_recent <35 ~ "obesity I",
    BMI_recent >=35.0 & BMI_recent <40 ~ "obesity II",
    BMI_recent >= 40.0 ~ "obesity III"
  ))  

```{r}
ROI_global %>% 
  distinct(suid, .keep_all = TRUE) %>% 
  select(refage, refage_cat, stage, BMI_YA_grp, BMI_recent, BMI_recent_grp, BMI_classification, 
        smoker,
         dblkstat_CA125, adj,
         race) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
              label = list(refage ~ "Age at diagnosis", refage_cat ~ "Age at diagnosis category",
                           dblkstat_CA125 ~ "Debulking Status", adj ~ "Adjuvant chemotherapy",
                           smoker ~ "Smoking status"),
              digits = list(all_continuous() ~ 1)) %>%
      modify_header(list(label ~ "**Patient characteristics**", all_stat_cols() ~ "{level}")) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05)
ROI_i <- ROI_global %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral")
ROI_p <- ROI_global %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Peripheral")
```
<br>

***


# Figure 1
Here each slide is represented (feed 3 values for intratumoral ROI and 3 values for peripheral ROI per patient)  
The average % tumor in the intratumoral ROIs is `r round(mean(ROI_i$percent_tumor),2)`% and `r round(mean(ROI_i$percent_stroma),2)`% stroma, while for the peripheral ROIs, the average% tumor is `r round(mean(ROI_p$percent_tumor),2)`% and `r round(mean(ROI_p$percent_stroma),2)`% for stroma** 

```{r}
p1 <- ROI_global %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  mutate(Tumor = "Tumor") %>% 
  mutate(Stroma = "Stroma") %>% 
  ggplot()+
  geom_violin(aes(x=Tumor, y=percent_tumor), scale = "count")+
  geom_boxplot(aes(x=Tumor, y=percent_tumor), width=.1) +
  geom_violin(aes(x=Stroma, y=percent_stroma), scale = "count") +
  geom_boxplot(aes(x=Stroma, y=percent_stroma), width=.1) +
  theme_classic2()+
  labs(x="Cell type", y=NULL, title="Intratumoral \nROIs")
p2 <- ROI_global %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Peripheral") %>% 
  mutate(Tumor = "Tumor") %>% 
  mutate(Stroma = "Stroma") %>% 
  ggplot()+
  geom_violin(aes(x=Tumor, y=percent_tumor), scale = "count")+
  geom_boxplot(aes(x=Tumor, y=percent_tumor), width=.1) +
  geom_violin(aes(x=Stroma, y=percent_stroma), scale = "count") +
  geom_boxplot(aes(x=Stroma, y=percent_stroma), width=.1) +
  theme_classic2()+
  labs(x="Cell type", y=NULL, title="Peripheral \nROIs")

# tiff(paste0(path, "/violin plot distribution tumor and stroma cells in ROIs intra-periph.tiff"))
gridExtra::grid.arrange(p1, p2, ncol = 2, 
                        top = "% of Cells Present in", left = "% Cells per samples", 
                        bottom = "Data on Race-Matched Patients")
# dev.off()
```
<br>

***
<br>

# Table 2. Distribution of immune cell abundance, immune signatures, and the immunoscore by race/ethnicity

Here I used the mean per patients

```{r summarize mean}
markers_ROIi <- ROI_global %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  group_by(suid) %>% 
  summarize(
    mean_tumor = mean(percent_tumor),
    mean_stroma = mean(percent_stroma),
    mean_total = mean(percent_total),
    # variance_tumor = var(percent_tumor),
    # variance_stroma = var(percent_stroma),
    percent_CD3_tumor = mean(tumor_percent_cd3_opal_650_positive_cells),
    percent_CD8_tumor = mean(tumor_percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_tumor = mean(tumor_percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_tumor = mean(tumor_percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_tumor = mean(tumor_percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_tumor = mean(tumor_percent_cd11b_opal_620_positive_cells),
    percent_CD15_tumor = mean(tumor_percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_tumor = mean(tumor_percent_cd11bplus_cd15plus_positive_cells),
    percent_CD3_stroma = mean(stroma_percent_cd3_opal_650_positive_cells),
    percent_CD8_stroma = mean(stroma_percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_stroma = mean(stroma_percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_stroma = mean(stroma_percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_stroma = mean(stroma_percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_stroma = mean(stroma_percent_cd11b_opal_620_positive_cells),
    percent_CD15_stroma = mean(stroma_percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_stroma = mean(stroma_percent_cd11bplus_cd15plus_positive_cells),
    
    percent_CD3_total = mean(percent_cd3_opal_650_positive_cells),
    percent_CD8_total = mean(percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_total = mean(percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_total = mean(percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_total = mean(percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_total = mean(percent_cd11b_opal_620_positive_cells),
    percent_CD15_total = mean(percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_total = mean(percent_cd11bplus_cd15plus_positive_cells)
  )
markers_ROIi$tumor_variation <- markers_ROIi$mean_tumor - mean(ROI_global$percent_tumor)
markers_ROIi$stroma_variation <- markers_ROIi$mean_stroma - mean(ROI_global$percent_stroma)
markers_ROIi$total_variation <- markers_ROIi$mean_stroma - mean(ROI_global$percent_stroma)
#
markers_ROIp <- ROI_global %>% 
  filter(intratumoral_i_vs_peripheral_p_ == "Peripheral") %>% 
  group_by(suid) %>% 
  summarize(
    mean_tumor = mean(percent_tumor),
    mean_stroma = mean(percent_stroma),
    mean_total = mean(percent_total),
    # variance_tumor = var(percent_tumor),
    # variance_stroma = var(percent_stroma),
    percent_CD3_tumor = mean(tumor_percent_cd3_opal_650_positive_cells),
    percent_CD8_tumor = mean(tumor_percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_tumor = mean(tumor_percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_tumor = mean(tumor_percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_tumor = mean(tumor_percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_tumor = mean(tumor_percent_cd11b_opal_620_positive_cells),
    percent_CD15_tumor = mean(tumor_percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_tumor = mean(tumor_percent_cd11bplus_cd15plus_positive_cells),
    percent_CD3_stroma = mean(stroma_percent_cd3_opal_650_positive_cells),
    percent_CD8_stroma = mean(stroma_percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_stroma = mean(stroma_percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_stroma = mean(stroma_percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_stroma = mean(stroma_percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_stroma = mean(stroma_percent_cd11b_opal_620_positive_cells),
    percent_CD15_stroma = mean(stroma_percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_stroma = mean(stroma_percent_cd11bplus_cd15plus_positive_cells),
    percent_CD3_total = mean(percent_cd3_opal_650_positive_cells),
    percent_CD8_total = mean(percent_cd8_opal_570_positive_cells),
    percent_CD3_CD8_total = mean(percent_cd3plus_cd8plus_positive_cells),
    percent_FoxP3_total = mean(percent_foxp3_opal_540_positive_cells),
    percent_CD3_FoxP3_total = mean(percent_cd3plus_foxp3plus_positive_cells),
    percent_CD11b_total = mean(percent_cd11b_opal_620_positive_cells),
    percent_CD15_total = mean(percent_cd15_opal_520_positive_cells),
    percent_CD11b_CD15_total = mean(percent_cd11bplus_cd15plus_positive_cells)
  )
markers_ROIp$tumor_variation <- markers_ROIp$mean_tumor - mean(ROI_global$percent_tumor)
markers_ROIp$stroma_variation <- markers_ROIp$mean_stroma - mean(ROI_global$percent_stroma)
markers_ROIp$total_variation <- markers_ROIp$mean_total - mean(ROI_global$percent_total)

# Join Intratumoral and Peropheral ROI
markers_ROI <- full_join(markers_ROIi, markers_ROIp,
                         by= "suid", suffix= c(".i", ".p"))
markers_ROI <- left_join(markers_ROI, clinical_data, by="suid")
# clust_markers <- markers_ROI
```

The count of cells double stained (for example CD3+CD8+) are **NOT** substracted fronm the single stain count (CD3 alone and CD8 alone).  

```{r Table tumor cells in ROIs}
# reset_gtsummary_theme()
# theme_gtsummary_journal(journal = "jama")
tbl1 <-
  markers_ROI %>% 
  select(percent_CD3_tumor.i, percent_CD3_CD8_tumor.i, percent_CD3_FoxP3_tumor.i, 
              percent_CD11b_tumor.i, percent_CD11b_CD15_tumor.i,
         race) %>% 
  rename(percent_CD3_tumor = percent_CD3_tumor.i, percent_CD3_CD8_tumor = percent_CD3_CD8_tumor.i,
         percent_CD3_FoxP3_tumor = percent_CD3_FoxP3_tumor.i, 
         percent_CD11b_tumor = percent_CD11b_tumor.i, percent_CD11b_CD15_tumor = percent_CD11b_CD15_tumor.i) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
              label = list(percent_CD3_tumor ~ "percent CD3+", percent_CD3_CD8_tumor ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_tumor ~ "percent CD3+/FoxP3+",
                           percent_CD11b_tumor ~ "percent CD11b+", percent_CD11b_CD15_tumor ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05)
tbl2 <-
  markers_ROI %>% 
  select(percent_CD3_stroma.i, percent_CD3_CD8_stroma.i, percent_CD3_FoxP3_stroma.i, 
              percent_CD11b_stroma.i, percent_CD11b_CD15_stroma.i,
         race) %>% 
  rename(percent_CD3_stroma = percent_CD3_stroma.i, percent_CD3_CD8_stroma = percent_CD3_CD8_stroma.i,
         percent_CD3_FoxP3_stroma = percent_CD3_FoxP3_stroma.i, 
         percent_CD11b_stroma = percent_CD11b_stroma.i, percent_CD11b_CD15_stroma = percent_CD11b_CD15_stroma.i) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                           label = list(percent_CD3_stroma ~ "percent CD3+", percent_CD3_CD8_stroma ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_stroma ~ "percent CD3+/FoxP3+",
                           percent_CD11b_stroma ~ "percent CD11b+", percent_CD11b_CD15_stroma ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) 
tbl3 <-
  markers_ROI %>% 
  select(percent_CD3_total.i, percent_CD3_CD8_total.i, percent_CD3_FoxP3_total.i, 
              percent_CD11b_total.i, percent_CD11b_CD15_total.i,
         race) %>% 
  rename(percent_CD3_total = percent_CD3_total.i, percent_CD3_CD8_total = percent_CD3_CD8_total.i,
         percent_CD3_FoxP3_total = percent_CD3_FoxP3_total.i, 
         percent_CD11b_total = percent_CD11b_total.i, percent_CD11b_CD15_total = percent_CD11b_CD15_total.i) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                           label = list(percent_CD3_total ~ "percent CD3+", percent_CD3_CD8_total ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_total ~ "percent CD3+/FoxP3+",
                           percent_CD11b_total ~ "percent CD11b+", percent_CD11b_CD15_total ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) 


tbl5 <-
  markers_ROI %>% 
  select(percent_CD3_tumor.p, percent_CD3_CD8_tumor.p, percent_CD3_FoxP3_tumor.p, 
              percent_CD11b_tumor.p, percent_CD11b_CD15_tumor.p,
         race) %>% 
  rename(percent_CD3_tumor = percent_CD3_tumor.p, percent_CD3_CD8_tumor = percent_CD3_CD8_tumor.p,
         percent_CD3_FoxP3_tumor = percent_CD3_FoxP3_tumor.p, 
         percent_CD11b_tumor = percent_CD11b_tumor.p, percent_CD11b_CD15_tumor = percent_CD11b_CD15_tumor.p) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(percent_CD3_tumor ~ "percent CD3+", percent_CD3_CD8_tumor ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_tumor ~ "percent CD3+/FoxP3+",
                           percent_CD11b_tumor ~ "percent CD11b+", percent_CD11b_CD15_tumor ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05)
tbl6 <-
  markers_ROI %>% 
  select(percent_CD3_stroma.p, percent_CD3_CD8_stroma.p, percent_CD3_FoxP3_stroma.p, 
              percent_CD11b_stroma.p, percent_CD11b_CD15_stroma.p,
         race) %>% 
  rename(percent_CD3_stroma = percent_CD3_stroma.p, percent_CD3_CD8_stroma = percent_CD3_CD8_stroma.p,
         percent_CD3_FoxP3_stroma = percent_CD3_FoxP3_stroma.p, 
         percent_CD11b_stroma = percent_CD11b_stroma.p, percent_CD11b_CD15_stroma = percent_CD11b_CD15_stroma.p) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(percent_CD3_stroma ~ "percent CD3+", percent_CD3_CD8_stroma ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_stroma ~ "percent CD3+/FoxP3+",
                           percent_CD11b_stroma ~ "percent CD11b+", percent_CD11b_CD15_stroma ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05)
tbl7 <-
  markers_ROI %>% 
  select(percent_CD3_total.p, percent_CD3_CD8_total.p, percent_CD3_FoxP3_total.p, 
              percent_CD11b_total.p, percent_CD11b_CD15_total.p,
         race) %>% 
  rename(percent_CD3_total = percent_CD3_total.p, percent_CD3_CD8_total = percent_CD3_CD8_total.p,
         percent_CD3_FoxP3_total = percent_CD3_FoxP3_total.p, 
         percent_CD11b_total = percent_CD11b_total.p, percent_CD11b_CD15_total = percent_CD11b_CD15_total.p) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(percent_CD3_total ~ "percent CD3+", percent_CD3_CD8_total ~ "percent CD3+/CD8+",
                           percent_CD3_FoxP3_total ~ "percent CD3+/FoxP3+",
                           percent_CD11b_total ~ "percent CD11b+", percent_CD11b_CD15_total ~ "percent CD11b+/CD15+"),
              missing = "no", digits = list(all_continuous() ~ 2)) %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) 

tbl4 <- tbl_merge(list(tbl1, tbl5), tab_spanner = c("**Intratumoral**", "**Peripheral**"))
tbl8 <- tbl_merge(list(tbl2, tbl6), tab_spanner = c("**Intratumoral**", "**Peripheral**"))
tbl9 <- tbl_merge(list(tbl3, tbl7), tab_spanner = c("**Intratumoral**", "**Peripheral**"))


tbl10 <- tbl_stack(list(tbl4, tbl8, tbl9), group_header = c("Tumor", "Stroma", "Overall"))
tbl10

# tbl8 <- tbl_stack(list(tbl5, tbl6, tbl7), group_header = c("Tumor", "Stroma", "Overall"))
# tbl8
# 
# tbl <- tbl_merge(list(tbl4, tbl8), tab_spanner = c("**Intratumoral**", "**Peripheral**"))# %>%
#   # modify_spanning_header(everything() ~ "Overall (tmor+stroma) ROIs") %>% as_gt()
# tbl
# gt::gtsave(tbl, paste0(path, "/Table overall cells in ROIs.pdf"))
```
<br>




## 2.Category with absent cells
Calculate median without the zeros cells to cat 3grp (0, **<=**median, **>**median) for each cat (CD11b+CD15 are just cat in 2 gpe as 0 or >0)

That is done without removing double stained from single.

```{r new median}
markers_ROI <- markers_ROI %>% 
  
  mutate(CD3_tumor.i = case_when(
    percent_CD3_tumor.i == 0       ~ "zero",
    percent_CD3_tumor.i <= median(percent_CD3_tumor.i[percent_CD3_tumor.i>0])      ~ "low",
    percent_CD3_tumor.i > median(percent_CD3_tumor.i[percent_CD3_tumor.i>0])       ~ "high > 1.11%"
  )) %>% 
  mutate(CD3_CD8_tumor.i = case_when(
    percent_CD3_CD8_tumor.i == 0       ~ "zero",
    percent_CD3_CD8_tumor.i <= median(percent_CD3_CD8_tumor.i[percent_CD3_CD8_tumor.i>0])      ~ "low",
    percent_CD3_CD8_tumor.i > median(percent_CD3_CD8_tumor.i[percent_CD3_CD8_tumor.i>0])       ~ "high > 0.46%"
  )) %>% 
  mutate(CD3_FoxP3_tumor.i = case_when(
    percent_CD3_FoxP3_tumor.i == 0       ~ "zero",
    percent_CD3_FoxP3_tumor.i <= median(percent_CD3_FoxP3_tumor.i[percent_CD3_FoxP3_tumor.i>0])      ~ "low",
    percent_CD3_FoxP3_tumor.i > median(percent_CD3_FoxP3_tumor.i[percent_CD3_FoxP3_tumor.i>0])       ~ "high > 0.19%"
  )) %>% 
  mutate(CD11b_tumor.i = case_when(
    # percent_CD11b_tumor.i == 0       ~ "zero",
    percent_CD11b_tumor.i == 0      ~ "Absence",
    percent_CD11b_tumor.i > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_tumor.i = case_when(
    # percent_CD11b_CD15_tumor.i == 0       ~ "zero",
    percent_CD11b_CD15_tumor.i == 0      ~ "Absence",
    percent_CD11b_CD15_tumor.i > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_tumor.i3 = case_when(
    percent_CD11b_tumor.i == 0       ~ "zero",
    percent_CD11b_tumor.i == 0      ~ "low",
    percent_CD11b_tumor.i > 0       ~ "high"
  )) %>% 
  mutate(CD11b_CD15_tumor.i3 = case_when(
    percent_CD11b_CD15_tumor.i == 0       ~ "zero",
    percent_CD11b_CD15_tumor.i == 0      ~ "low",
    percent_CD11b_CD15_tumor.i > 0       ~ "high"
  )) %>% 
  mutate(CD3_stroma.i = case_when(
    percent_CD3_stroma.i == 0       ~ "zero",
    percent_CD3_stroma.i <= median(percent_CD3_stroma.i[percent_CD3_stroma.i>0])      ~ "low",
    percent_CD3_stroma.i > median(percent_CD3_stroma.i[percent_CD3_stroma.i>0])       ~ "high > 4.17%"
  )) %>% 
  mutate(CD3_CD8_stroma.i = case_when(
    percent_CD3_CD8_stroma.i == 0       ~ "zero",
    percent_CD3_CD8_stroma.i <= median(percent_CD3_CD8_stroma.i[percent_CD3_CD8_stroma.i>0])      ~ "low",
    percent_CD3_CD8_stroma.i > median(percent_CD3_CD8_stroma.i[percent_CD3_CD8_stroma.i>0])       ~ "high > 1.46%"
  )) %>% 
  mutate(CD3_FoxP3_stroma.i = case_when(
    percent_CD3_FoxP3_stroma.i == 0       ~ "zero",
    percent_CD3_FoxP3_stroma.i <= median(percent_CD3_FoxP3_stroma.i[percent_CD3_FoxP3_stroma.i>0])      ~ "low",
    percent_CD3_FoxP3_stroma.i > median(percent_CD3_FoxP3_stroma.i[percent_CD3_FoxP3_stroma.i>0])       ~ "high > 0.78%"
  )) %>% 
  mutate(CD11b_stroma.i = case_when(
    # percent_CD11b_stroma.i == 0       ~ "zero",
    percent_CD11b_stroma.i == 0      ~ "Absence",
    percent_CD11b_stroma.i > 0       ~ "Presence"
  )) %>%
  mutate(CD11b_CD15_stroma.i = case_when(
    # percent_CD11b_CD15_stroma.i == 0       ~ "zero",
    percent_CD11b_CD15_stroma.i == 0      ~ "Absence",
    percent_CD11b_CD15_stroma.i > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_stroma.i3 = case_when(
    percent_CD11b_stroma.i == 0       ~ "zero",
    percent_CD11b_stroma.i == 0      ~ "low",
    percent_CD11b_stroma.i > 0       ~ "high"
  )) %>%
  mutate(CD11b_CD15_stroma.i3 = case_when(
    percent_CD11b_CD15_stroma.i == 0       ~ "zero",
    percent_CD11b_CD15_stroma.i == 0      ~ "low",
    percent_CD11b_CD15_stroma.i > 0       ~ "high"
  )) %>% 
  mutate(CD3_total.i = case_when(
    percent_CD3_total.i == 0       ~ "zero",
    percent_CD3_total.i <= median(percent_CD3_total.i[percent_CD3_total.i>0])      ~ "low",
    percent_CD3_total.i > median(percent_CD3_total.i[percent_CD3_total.i>0])       ~ "high > 1.46%"
  )) %>% 
  mutate(CD3_CD8_total.i = case_when(
    percent_CD3_CD8_total.i == 0       ~ "zero",
    percent_CD3_CD8_total.i <= median(percent_CD3_CD8_total.i[percent_CD3_CD8_total.i>0])      ~ "low",
    percent_CD3_CD8_total.i > median(percent_CD3_CD8_total.i[percent_CD3_CD8_total.i>0])       ~ "high > 0.56%"
  )) %>% 
  mutate(CD3_FoxP3_total.i = case_when(
    percent_CD3_FoxP3_total.i == 0       ~ "zero",
    percent_CD3_FoxP3_total.i <= median(percent_CD3_FoxP3_total.i[percent_CD3_FoxP3_total.i>0])      ~ "low",
    percent_CD3_FoxP3_total.i > median(percent_CD3_FoxP3_total.i[percent_CD3_FoxP3_total.i>0])       ~ "high > 0.23%"
  )) %>% 
  mutate(CD11b_total.i = case_when(
    # percent_CD11b_total.i == 0       ~ "zero",
    percent_CD11b_total.i == 0      ~ "Absence",
    percent_CD11b_total.i > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_total.i = case_when(
    # percent_CD11b_CD15_total.i == 0       ~ "zero",
    percent_CD11b_CD15_total.i == 0      ~ "Absence",
    percent_CD11b_CD15_total.i > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_total.i3 = case_when(
    percent_CD11b_total.i == 0       ~ "zero",
    percent_CD11b_total.i == 0      ~ "low",
    percent_CD11b_total.i > 0       ~ "high"
  )) %>% 
  mutate(CD11b_CD15_total.i3 = case_when(
    percent_CD11b_CD15_total.i == 0       ~ "zero",
    percent_CD11b_CD15_total.i == 0      ~ "low",
    percent_CD11b_CD15_total.i > 0       ~ "high"
  )) %>% 
  
  
  mutate(CD3_tumor.p = case_when(
    percent_CD3_tumor.p == 0       ~ "zero",
    percent_CD3_tumor.p <= median(percent_CD3_tumor.p[percent_CD3_tumor.p>0], na.rm = TRUE)      ~ "low",
    percent_CD3_tumor.p > median(percent_CD3_tumor.p[percent_CD3_tumor.p>0], na.rm = TRUE)       ~ "high > 1.98%"
  )) %>% 
  mutate(CD3_CD8_tumor.p = case_when(
    percent_CD3_CD8_tumor.p == 0       ~ "zero",
    percent_CD3_CD8_tumor.p <= median(percent_CD3_CD8_tumor.p[percent_CD3_CD8_tumor.p>0], na.rm = TRUE)      ~ "low",
    percent_CD3_CD8_tumor.p > median(percent_CD3_CD8_tumor.p[percent_CD3_CD8_tumor.p>0], na.rm = TRUE)       ~ "high > 0.94%"
  )) %>% 
  mutate(CD3_FoxP3_tumor.p = case_when(
    percent_CD3_FoxP3_tumor.p == 0       ~ "zero",
    percent_CD3_FoxP3_tumor.p <= median(percent_CD3_FoxP3_tumor.p[percent_CD3_FoxP3_tumor.p>0], na.rm = TRUE)      ~ "low",
    percent_CD3_FoxP3_tumor.p > median(percent_CD3_FoxP3_tumor.p[percent_CD3_FoxP3_tumor.p>0], na.rm = TRUE)       ~ "high > 0.35%"
  )) %>% 
  mutate(CD11b_tumor.p = case_when(
    # percent_CD11b_tumor.p == 0       ~ "zero",
    percent_CD11b_tumor.p == 0      ~ "Absence",
    percent_CD11b_tumor.p > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_tumor.p = case_when(
    # percent_CD11b_CD15_tumor.p == 0       ~ "zero",
    percent_CD11b_CD15_tumor.p == 0      ~ "Absence",
    percent_CD11b_CD15_tumor.p > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_tumor.p3 = case_when(
    percent_CD11b_tumor.p == 0       ~ "zero",
    percent_CD11b_tumor.p == 0      ~ "low",
    percent_CD11b_tumor.p > 0       ~ "high"
  )) %>% 
  mutate(CD11b_CD15_tumor.p3 = case_when(
    percent_CD11b_CD15_tumor.p == 0       ~ "zero",
    percent_CD11b_CD15_tumor.p == 0      ~ "low",
    percent_CD11b_CD15_tumor.p > 0       ~ "high"
  )) %>% 
  mutate(CD3_stroma.p = case_when(
    percent_CD3_stroma.p == 0       ~ "zero",
    percent_CD3_stroma.p <= median(percent_CD3_stroma.p[percent_CD3_stroma.p>0], na.rm = TRUE)      ~ "low",
    percent_CD3_stroma.p > median(percent_CD3_stroma.p[percent_CD3_stroma.p>0], na.rm = TRUE)       ~ "high > 8.31%"
  )) %>% 
  mutate(CD3_CD8_stroma.p = case_when(
    percent_CD3_CD8_stroma.p == 0       ~ "zero",
    percent_CD3_CD8_stroma.p <= median(percent_CD3_CD8_stroma.p[percent_CD3_CD8_stroma.p>0], na.rm = TRUE)      ~ "low",
    percent_CD3_CD8_stroma.p > median(percent_CD3_CD8_stroma.p[percent_CD3_CD8_stroma.p>0], na.rm = TRUE)       ~ "high > 2.85%"
  )) %>% 
  mutate(CD3_FoxP3_stroma.p = case_when(
    percent_CD3_FoxP3_stroma.p == 0       ~ "zero",
    percent_CD3_FoxP3_stroma.p <= median(percent_CD3_FoxP3_stroma.p[percent_CD3_FoxP3_stroma.p>0], na.rm = TRUE)      ~ "low",
    percent_CD3_FoxP3_stroma.p > median(percent_CD3_FoxP3_stroma.p[percent_CD3_FoxP3_stroma.p>0], na.rm = TRUE)       ~ "high > 0.60%"
  )) %>% 
  mutate(CD11b_stroma.p = case_when(
    # percent_CD11b_stroma.p == 0       ~ "zero",
    percent_CD11b_stroma.p == 0      ~ "Absence",
    percent_CD11b_stroma.p > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_stroma.p = case_when(
    # percent_CD11b_CD15_stroma.p == 0       ~ "zero",
    percent_CD11b_CD15_stroma.p == 0      ~ "Absence",
    percent_CD11b_CD15_stroma.p > 0       ~ "Presence"
  )) %>% 
    mutate(CD11b_stroma.p3 = case_when(
    percent_CD11b_stroma.p == 0       ~ "zero",
    percent_CD11b_stroma.p == 0      ~ "low",
    percent_CD11b_stroma.p > 0       ~ "high"
  )) %>% 
  mutate(CD11b_CD15_stroma.p3 = case_when(
    percent_CD11b_CD15_stroma.p == 0       ~ "zero",
    percent_CD11b_CD15_stroma.p == 0      ~ "low",
    percent_CD11b_CD15_stroma.p > 0       ~ "high"
  )) %>% 
  mutate(CD3_total.p = case_when(
    percent_CD3_total.p == 0       ~ "zero",
    percent_CD3_total.p <= median(percent_CD3_total.p[percent_CD3_total.p>0], na.rm = TRUE)      ~ "low",
    percent_CD3_total.p > median(percent_CD3_total.p[percent_CD3_total.p>0], na.rm = TRUE)       ~ "high > 5.64%"
  )) %>% 
  mutate(CD3_CD8_total.p = case_when(
    percent_CD3_CD8_total.p == 0       ~ "zero",
    percent_CD3_CD8_total.p <= median(percent_CD3_CD8_total.p[percent_CD3_CD8_total.p>0], na.rm = TRUE)      ~ "low",
    percent_CD3_CD8_total.p > median(percent_CD3_CD8_total.p[percent_CD3_CD8_total.p>0], na.rm = TRUE)       ~ "high > 2.03%"
  )) %>% 
  mutate(CD3_FoxP3_total.p = case_when(
    percent_CD3_FoxP3_total.p == 0       ~ "zero",
    percent_CD3_FoxP3_total.p <= median(percent_CD3_FoxP3_total.p[percent_CD3_FoxP3_total.p>0], na.rm = TRUE)      ~ "low",
    percent_CD3_FoxP3_total.p > median(percent_CD3_FoxP3_total.p[percent_CD3_FoxP3_total.p>0], na.rm = TRUE)       ~ "high > 0.47%"
  )) %>% 
  mutate(CD11b_total.p = case_when(
    # percent_CD11b_total.p == 0       ~ "zero",
    percent_CD11b_total.p == 0      ~ "Absence",
    percent_CD11b_total.p > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_total.p = case_when(
    # percent_CD11b_CD15_total.p == 0       ~ "zero",
    percent_CD11b_CD15_total.p == 0      ~ "Absence",
    percent_CD11b_CD15_total.p > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_total.p3 = case_when(
    percent_CD11b_total.p == 0       ~ "zero",
    percent_CD11b_total.p == 0      ~ "low",
    percent_CD11b_total.p > 0       ~ "high"
  )) %>% 
  mutate(CD11b_CD15_total.p3 = case_when(
    percent_CD11b_CD15_total.p == 0       ~ "zero",
    percent_CD11b_CD15_total.p == 0      ~ "low",
    percent_CD11b_CD15_total.p > 0       ~ "high"
  )) 




# for(i in 1:length(colnames(markers_ROI))) {
#   
#   
#   if(str_detect(markers_ROI[,i], "percent_CD|percent_Fox")) {
#     
#     markers_ROI <- markers_ROI %>%
#       mutate(.[,i] = case_when(
#     [,i] <= median([,i][[,i]>0])      ~ "low",
#     [,i] > median([,i][[,i]>0])      ~ "high",
#     [,i] == 0                         ~ "zero"
#   ))
#     
#     
#   }
#   print(markers_ROI[,i])
# }
# 
# for (v in colnames(df[ ,grepl(".x",names(df))])) {
#   print(v)
#   df$v <- ifelse(is.na(df$v), ols$coefficients[1]+ols$coefficients[2]*log(df$gsub(".x",".y",v)), df$v)
# }
```

```{r Table classification cells in ROIs}
tbl1 <-
  markers_ROI %>% 
  select(CD3_tumor.i, CD3_CD8_tumor.i, CD3_FoxP3_tumor.i, 
              CD11b_tumor.i, CD11b_CD15_tumor.i,
         CD11b_tumor.i3, CD11b_CD15_tumor.i3,
         race) %>% 
  rename(CD3_tumor = CD3_tumor.i, CD3_CD8_tumor = CD3_CD8_tumor.i,
         CD3_FoxP3_tumor = CD3_FoxP3_tumor.i, 
         CD11b_tumor3 = CD11b_tumor.i3, CD11b_CD15_tumor3 = CD11b_CD15_tumor.i3,
         CD11b_tumor = CD11b_tumor.i, CD11b_CD15_tumor = CD11b_CD15_tumor.i) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
              label = list(CD3_tumor ~ "percent CD3+", CD3_CD8_tumor ~ "percent CD3+/CD8+",
                           CD3_FoxP3_tumor ~ "percent CD3+/FoxP3+",
                           CD11b_tumor ~ "percent CD11b+", CD11b_CD15_tumor ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05)
tbl2 <-
  markers_ROI %>% 
  select(CD3_stroma.i, CD3_CD8_stroma.i, CD3_FoxP3_stroma.i, 
              CD11b_stroma.i, CD11b_CD15_stroma.i,
                  CD11b_stroma.i3, CD11b_CD15_stroma.i3,
race) %>% 
  rename(CD3_stroma = CD3_stroma.i, CD3_CD8_stroma = CD3_CD8_stroma.i,
         CD3_FoxP3_stroma = CD3_FoxP3_stroma.i, 
                  CD11b_stroma3 = CD11b_stroma.i3, CD11b_CD15_stroma3 = CD11b_CD15_stroma.i3,
CD11b_stroma = CD11b_stroma.i, CD11b_CD15_stroma = CD11b_CD15_stroma.i) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                           label = list(CD3_stroma ~ "percent CD3+", CD3_CD8_stroma ~ "percent CD3+/CD8+",
                           CD3_FoxP3_stroma ~ "percent CD3+/FoxP3+",
                           CD11b_stroma ~ "percent CD11b+", CD11b_CD15_stroma ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) 
tbl3 <-
  markers_ROI %>% 
  select(CD3_total.i, CD3_CD8_total.i, CD3_FoxP3_total.i, 
              CD11b_total.i, CD11b_CD15_total.i,
                  CD11b_total.i3, CD11b_CD15_total.i3,
race) %>% 
  rename(CD3_total = CD3_total.i, CD3_CD8_total = CD3_CD8_total.i,
         CD3_FoxP3_total = CD3_FoxP3_total.i, 
                  CD11b_total3 = CD11b_total.i3, CD11b_CD15_total3 = CD11b_CD15_total.i3,
CD11b_total = CD11b_total.i, CD11b_CD15_total = CD11b_CD15_total.i) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                           label = list(CD3_total ~ "percent CD3+", CD3_CD8_total ~ "percent CD3+/CD8+",
                           CD3_FoxP3_total ~ "percent CD3+/FoxP3+",
                           CD11b_total ~ "percent CD11b+", CD11b_CD15_total ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) 


tbl5 <-
  markers_ROI %>% 
  select(CD3_tumor.p, CD3_CD8_tumor.p, CD3_FoxP3_tumor.p, 
              CD11b_tumor.p, CD11b_CD15_tumor.p,
                  CD11b_tumor.p3, CD11b_CD15_tumor.p3,
race) %>% 
  rename(CD3_tumor = CD3_tumor.p, CD3_CD8_tumor = CD3_CD8_tumor.p,
         CD3_FoxP3_tumor = CD3_FoxP3_tumor.p, 
                  CD11b_tumor3 = CD11b_tumor.p3, CD11b_CD15_tumor3 = CD11b_CD15_tumor.p3,
CD11b_tumor = CD11b_tumor.p, CD11b_CD15_tumor = CD11b_CD15_tumor.p) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(CD3_tumor ~ "percent CD3+", CD3_CD8_tumor ~ "percent CD3+/CD8+",
                           CD3_FoxP3_tumor ~ "percent CD3+/FoxP3+",
                           CD11b_tumor ~ "percent CD11b+", CD11b_CD15_tumor ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05)
tbl6 <-
  markers_ROI %>% 
  select(CD3_stroma.p, CD3_CD8_stroma.p, CD3_FoxP3_stroma.p, 
              CD11b_stroma.p, CD11b_CD15_stroma.p,
                  CD11b_stroma.p3, CD11b_CD15_stroma.p3,
race) %>% 
  rename(CD3_stroma = CD3_stroma.p, CD3_CD8_stroma = CD3_CD8_stroma.p,
         CD3_FoxP3_stroma = CD3_FoxP3_stroma.p, 
                  CD11b_stroma3 = CD11b_stroma.p3, CD11b_CD15_stroma3 = CD11b_CD15_stroma.p3,
CD11b_stroma = CD11b_stroma.p, CD11b_CD15_stroma = CD11b_CD15_stroma.p) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(CD3_stroma ~ "percent CD3+", CD3_CD8_stroma ~ "percent CD3+/CD8+",
                           CD3_FoxP3_stroma ~ "percent CD3+/FoxP3+",
                           CD11b_stroma ~ "percent CD11b+", CD11b_CD15_stroma ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05)
tbl7 <-
  markers_ROI %>% 
  select(CD3_total.p, CD3_CD8_total.p, CD3_FoxP3_total.p, 
              CD11b_total.p, CD11b_CD15_total.p,
                  CD11b_total.p3, CD11b_CD15_total.p3,
race) %>% 
  rename(CD3_total = CD3_total.p, CD3_CD8_total = CD3_CD8_total.p,
         CD3_FoxP3_total = CD3_FoxP3_total.p, 
                  CD11b_total3 = CD11b_total.p3, CD11b_CD15_total3 = CD11b_CD15_total.p3,
CD11b_total = CD11b_total.p, CD11b_CD15_total = CD11b_CD15_total.p) %>% 
  tbl_summary(by = race,
              statistic = list(all_continuous() ~ "{mean} ({sd})"),
                            label = list(CD3_total ~ "percent CD3+", CD3_CD8_total ~ "percent CD3+/CD8+",
                           CD3_FoxP3_total ~ "percent CD3+/FoxP3+",
                           CD11b_total ~ "percent CD11b+", CD11b_CD15_total ~ "percent CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05) 

tbl4 <- tbl_merge(list(tbl1, tbl5), tab_spanner = c("**Intratumoral**", "**Peripheral**"))
tbl8 <- tbl_merge(list(tbl2, tbl6), tab_spanner = c("**Intratumoral**", "**Peripheral**"))
tbl9 <- tbl_merge(list(tbl3, tbl7), tab_spanner = c("**Intratumoral**", "**Peripheral**"))


tbl10 <- tbl_stack(list(tbl4, tbl8, tbl9), group_header = c("Tumor", "Stroma", "Overall"))
tbl10
```

NB: I did the 3 grp for CD11 and CD11/CD15 and I had a significative difference in peripheral for one of the marker-I think it was tumor

<br>

***

# Cluster

The count of cells double stained (for example CD3+CD8+) **ARE** substracted fronm the single stain count (CD3 alone and CD8 alone) to avoid overlapping if we want to use them to cluster.  

The next step are with removing double from single stain.

```{r removing double stain from single stain count}
markers_ROI <- markers_ROI %>% 
  mutate(percent_CD3_total.i = percent_CD3_total.i - percent_CD3_CD8_total.i - percent_CD3_FoxP3_total.i) %>% 
  mutate(percent_CD8_total.i = percent_CD8_total.i - percent_CD3_CD8_total.i) %>% 
  mutate(percent_FoxP3_total.i = percent_FoxP3_total.i - percent_CD3_FoxP3_total.i) %>% 
  mutate(percent_CD11b_total.i = percent_CD11b_total.i - percent_CD11b_CD15_total.i) %>% 
  mutate(percent_CD15_total.i = percent_CD15_total.i - percent_CD11b_CD15_total.i) %>% 
  
  mutate(percent_CD3_tumor.i = percent_CD3_tumor.i - percent_CD3_CD8_tumor.i - percent_CD3_FoxP3_tumor.i) %>% 
  mutate(percent_CD8_tumor.i = percent_CD8_tumor.i - percent_CD3_CD8_tumor.i) %>% 
  mutate(percent_FoxP3_tumor.i = percent_FoxP3_tumor.i - percent_CD3_FoxP3_tumor.i) %>% 
  mutate(percent_CD11b_tumor.i = percent_CD11b_tumor.i - percent_CD11b_CD15_tumor.i) %>% 
  mutate(percent_CD15_tumor.i = percent_CD15_tumor.i - percent_CD11b_CD15_tumor.i) %>% 
  
  mutate(percent_CD3_stroma.i = percent_CD3_stroma.i - percent_CD3_CD8_stroma.i - percent_CD3_FoxP3_stroma.i) %>% 
  mutate(percent_CD8_stroma.i = percent_CD8_stroma.i - percent_CD3_CD8_stroma.i) %>% 
  mutate(percent_FoxP3_stroma.i = percent_FoxP3_stroma.i - percent_CD3_FoxP3_stroma.i) %>% 
  mutate(percent_CD11b_stroma.i = percent_CD11b_stroma.i - percent_CD11b_CD15_stroma.i) %>% 
  mutate(percent_CD15_stroma.i = percent_CD15_stroma.i - percent_CD11b_CD15_stroma.i) %>% 
  
  mutate(percent_CD3_total.p = percent_CD3_total.p - percent_CD3_CD8_total.p - percent_CD3_FoxP3_total.p) %>% 
  mutate(percent_CD8_total.p = percent_CD8_total.p - percent_CD3_CD8_total.p) %>% 
  mutate(percent_FoxP3_total.p = percent_FoxP3_total.p - percent_CD3_FoxP3_total.p) %>% 
  mutate(percent_CD11b_total.p = percent_CD11b_total.p - percent_CD11b_CD15_total.p) %>% 
  mutate(percent_CD15_total.p = percent_CD15_total.p - percent_CD11b_CD15_total.p) %>% 
  
  mutate(percent_CD3_tumor.p = percent_CD3_tumor.p - percent_CD3_CD8_tumor.p - percent_CD3_FoxP3_tumor.p) %>% 
  mutate(percent_CD8_tumor.p = percent_CD8_tumor.p - percent_CD3_CD8_tumor.p) %>% 
  mutate(percent_FoxP3_tumor.p = percent_FoxP3_tumor.p - percent_CD3_FoxP3_tumor.p) %>% 
  mutate(percent_CD11b_tumor.p = percent_CD11b_tumor.p - percent_CD11b_CD15_tumor.p) %>% 
  mutate(percent_CD15_tumor.p = percent_CD15_tumor.p - percent_CD11b_CD15_tumor.p) %>% 
  
  mutate(percent_CD3_stroma.p = percent_CD3_stroma.p - percent_CD3_CD8_stroma.p - percent_CD3_FoxP3_stroma.p) %>% 
  mutate(percent_CD8_stroma.p = percent_CD8_stroma.p - percent_CD3_CD8_stroma.p) %>% 
  mutate(percent_FoxP3_stroma.p = percent_FoxP3_stroma.p - percent_CD3_FoxP3_stroma.p) %>% 
  mutate(percent_CD11b_stroma.p = percent_CD11b_stroma.p - percent_CD11b_CD15_stroma.p) %>% 
  mutate(percent_CD15_stroma.p = percent_CD15_stroma.p - percent_CD11b_CD15_stroma.p)
```
<br>

## 2.Cluster with a non-defined number of cluster **Yes 5 is the best for when looking at all intra/periph + tumor/stroma**

```{r clustering}
set.seed(1234)

### Cluster for stroma/tumor in the intratumoral/peritumoral ROIs (include single and double staining, overall are excluded)
clust_markers <- markers_ROI %>% 
  filter(!is.na(markers_ROI$percent_CD3_CD8_tumor.i) & !is.na(markers_ROI$percent_CD3_CD8_tumor.p)) %>% 
  select(suid, c("percent_CD3_tumor.i" : "percent_CD11b_CD15_stroma.i", "percent_CD3_tumor.p" : "percent_CD11b_CD15_stroma.p"))

clust <- Mclust(clust_markers[,c(2:ncol(clust_markers))])
summary(clust)
clust_markers$clusters_all_IandP <- clust$classification
# clust_markers$clusters_all_IandP <- factor(clust_markers$clusters_all_IandP,
#                                            levels = c(1, 3, 2),
#                                            labels = c("low", "mid", "high"))
# clust_markers$clusters_all_IandP <- factor(clust_markers$clusters_all_IandP, 
#                                            levels = c(6, 5, 1, 4, 3, 2),
#                                            labels = c("sublow", "low", "mid-low", "mid", "mid-high", "high"))
markers_ROI <- full_join(markers_ROI, clust_markers %>% select(suid, clusters_all_IandP), by = "suid")


### Cluster for tumor intratumoral all double positive "percent_CD3_CD8_tumor.i", "percent_CD3_FoxP3_tumor.i", "percent_CD11b_CD15_tumor.i"
clust_markers <- markers_ROI %>% filter(!is.na(markers_ROI$percent_CD3_CD8_tumor.i ))
clust <- 
  Mclust(clust_markers[,c("percent_CD3_CD8_tumor.i", "percent_CD3_FoxP3_tumor.i", "percent_CD11b_CD15_tumor.i")])
summary(clust)
clust_markers$dbl_pos <- clust$classification


### Cluster for tumor intratumoral CD3-CD8
clust <- Mclust(clust_markers$percent_CD3_CD8_tumor.i)
summary(clust)
clust_markers$clusters_CD3CD8 <- clust$classification


### Cluster for tumor intratumoral CD3-FoxP3
clust <- Mclust(clust_markers$percent_CD3_FoxP3_tumor.i)
summary(clust)
clust_markers$clusters_CD3FoxP3 <- clust$classification


### Cluster for tumor intratumoral FoxP3 because it can be expressed by tumor cell
clust <- Mclust(clust_markers$percent_FoxP3_tumor.i)
summary(clust)
clust_markers$clusters_FoxP3_ <- clust$classification


### Cluster for tumor intratumoral CD11b/CD15 
clust <- Mclust(clust_markers$percent_CD11b_CD15_tumor.i)
summary(clust)
clust_markers$clusters_CD11bCD15 <- clust$classification

markers_ROI <- full_join(markers_ROI, clust_markers %>% select(suid, dbl_pos, clusters_CD3CD8, clusters_CD3FoxP3, clusters_FoxP3_, clusters_CD11bCD15), by = "suid")

```
<br>

I didn't recode the low, high, etc it is just to take a look at White vs Black
```{r Table cluster}
markers_ROI %>% 
  select(clusters_all_IandP, dbl_pos, clusters_CD3CD8, clusters_CD3FoxP3, clusters_FoxP3_, clusters_CD11bCD15,
         race) %>% 
  tbl_summary(by = race,
              label = list(clusters_all_IandP ~ "intra+periph, tumor+stroma", dbl_pos ~ "all double positive",
                           clusters_CD3CD8 ~ "CD3+/CD8+",
                           clusters_CD3FoxP3 ~ "CD3+/FoxP3+", clusters_FoxP3_ ~ "FoxP3+",
                           clusters_CD11bCD15 ~ "CD11b+/CD15+"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05)
```

# Immunoscore
When we decided for every group I can put cluster and immunoscore together in the same table.
I took the immunoscore calculated on the mean of the 3 value per patient.
```{r immunoscore per patients mean}
markers_ROI <- markers_ROI %>% 
  mutate(percentile_score_CD3_i = ntile(percent_CD3_total.i, 100) ) %>% 
  mutate(percentile_score_CD3_p = ntile(percent_CD3_total.p, 100) ) %>% 
  mutate(percentile_score_CD8_i = ntile(percent_CD8_total.i, 100) ) %>% 
  mutate(percentile_score_CD8_p = ntile(percent_CD8_total.p, 100) ) 

markers_ROI <- markers_ROI %>%
  mutate(percentile_score_mean = rowMeans( markers_ROI[c("percentile_score_CD3_i", "percentile_score_CD3_p", 
                                                    "percentile_score_CD8_i", "percentile_score_CD8_p")] ))
markers_ROI <- markers_ROI %>%
  mutate(immunoscore_patients = case_when(
    percentile_score_mean <= 10        ~ 0,
    percentile_score_mean <= 25        ~ 1,
    percentile_score_mean <= 70        ~ 2,
    percentile_score_mean <= 95        ~ 3,
    percentile_score_mean > 95         ~ 4 
  )) %>% 
  mutate(immunoscore_patients = factor(immunoscore_patients)) %>% 
  mutate(immunoscore_2018lancet_patients = case_when(
    percentile_score_mean <= 25        ~ "Low",
    percentile_score_mean <= 70        ~ "Intermediate",
    percentile_score_mean > 70         ~ "High"
    )) %>% 
  mutate(immunoscore_2018lancet_patients = factor(immunoscore_2018lancet_patients, levels = c("Low", "Intermediate", "High"))) 
```

```{r Table immunoscore}
markers_ROI %>% 
  select(immunoscore_patients, immunoscore_2018lancet_patients,
         race) %>% 
  tbl_summary(by = race,
              label = list(immunoscore_patients ~ "classic immunoscore", 
                           immunoscore_2018lancet_patients ~ "immunoscore lancet"),
              missing = "no") %>% 
  add_overall() %>% bold_labels() %>% add_p() %>% bold_p(t = .05)
```

# Table 3. Adjusted hazard ratios1 and 95% confidence intervals

```{r}
markers_ROI_o <- markers_ROI %>% 
  rename(CD3 = CD3_total.i, CD3_CD8 = CD3_CD8_total.i,
         CD3_FoxP3 = CD3_FoxP3_total.i, 
         CD11b = CD11b_total.i, CD11b_CD15 = CD11b_CD15_total.i)
  
tbl1 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_o)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl3 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl4 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl5 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl10 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))

markers_ROI_t <- markers_ROI %>% 
  rename(CD3 = CD3_tumor.i, CD3_CD8 = CD3_CD8_tumor.i,
         CD3_FoxP3 = CD3_FoxP3_tumor.i, 
         CD11b = CD11b_tumor.i, CD11b_CD15 = CD11b_CD15_tumor.i)
  
tbl1 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_t)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl3 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl4 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl5 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl11 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))

markers_ROI_s <- markers_ROI %>% 
  rename(CD3 = CD3_stroma.i, CD3_CD8 = CD3_CD8_stroma.i,
         CD3_FoxP3 = CD3_FoxP3_stroma.i, 
         CD11b = CD11b_stroma.i, CD11b_CD15 = CD11b_CD15_stroma.i)

tbl1 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl3 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl4 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl5 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl12 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))
tbl13 <- tbl_merge(list(tbl10, tbl11, tbl12), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))



markers_ROI_o <- markers_ROI %>% 
  rename(CD3 = CD3_total.p, CD3_CD8 = CD3_CD8_total.p,
         CD3_FoxP3 = CD3_FoxP3_total.p, 
         CD11b = CD11b_total.p, CD11b_CD15 = CD11b_CD15_total.p)
  
tbl1 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_o)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl3 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl4 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl5 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_o) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl10 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))

markers_ROI_t <- markers_ROI %>% 
  rename(CD3 = CD3_tumor.p, CD3_CD8 = CD3_CD8_tumor.p,
         CD3_FoxP3 = CD3_FoxP3_tumor.p, 
         CD11b = CD11b_tumor.p, CD11b_CD15 = CD11b_CD15_tumor.p)
  
tbl1 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_t)  %>% 
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl3 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl4 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl5 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_t) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl11 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))

markers_ROI_s <- markers_ROI %>% 
  rename(CD3 = CD3_stroma.p, CD3_CD8 = CD3_CD8_stroma.p,
         CD3_FoxP3 = CD3_FoxP3_stroma.p, 
         CD11b = CD11b_stroma.p, CD11b_CD15 = CD11b_CD15_stroma.p)

tbl1 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl2 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_CD8) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl3 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD3_FoxP3) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl4 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl5 <- coxph(Surv(time = markers_ROI$timelastfu_new, 
                   event = markers_ROI$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_s) %>%
  tbl_regression(exponentiate = TRUE,
                 include = CD11b_CD15) %>% bold_p(t = .05) %>% add_nevent(location = "level")
tbl12 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))
tbl14 <- tbl_merge(list(tbl10, tbl11, tbl12), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))

tbl15 <- tbl_stack(list(tbl13, tbl14), group_header = c("Intratumoral", "Peripheral"))
tbl15

```

















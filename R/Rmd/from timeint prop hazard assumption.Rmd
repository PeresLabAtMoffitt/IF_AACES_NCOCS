---
title: "Immune marker data"
author: "Christelle Colin-Leitzinger"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: false
    theme: cerulean #darkly
    highlight: pygments
    df_print: paged
editor_options: 
  chunk_output_type: console
---

<style type="text/css">
h1.title {
  font-size: 25px;
}
.figure {
   margin-top: 25px;
   <!-- margin-bottom: 100px; -->
}

table {
    margin-top: 25px;
    <!-- margin-bottom: 100px !important; -->
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      cache = FALSE,
                      # fig.width = 7, fig.height = 5, 
                      fig.align='center'#, fig.show='hold'
                      )
options(gtsummary.print_engine = "gt")
options(gtsummary.as_gt.addl_cmds = "gt::tab_options(table.font.size = 14, data_row.padding = gt::px(1))")
```

<style>
div.blue { background-color:#0099CC; border-radius: 5px; padding: 20px; font-size: 38px}
</style>
<div class = "blue">

<span style="color: white;">Manuscript draft</span>

</div>
<br>

```{r library, include=FALSE}
# library(drake)
library(tidyverse)
library(data.table)
# library(VennDiagram)
library(gtsummary)
library(survival)
library(survminer)
library(psych)
# library(corrplot)
# library(ggcorrplot)
library(mclust)
library(sensemakr)
```

```{r load}
# loadd(clinical_data, ROI_tumor ,ROI_stroma ,ROI_total,
#       cases_match)

ROI_global <- readRDS("/Users/colinccm/Documents/GitHub/Peres/IF_AACES_NCOCS/ROI_global.rds")
clinical_data <- readRDS("/Users/colinccm/Documents/GitHub/Peres/IF_AACES_NCOCS/clinical_data.rds")

# Rewove patients not matched or lost match
ROI_global <- left_join(ROI_global, clinical_data, by="suid") %>% drop_na(pair_id) %>% 
  filter(!image_tag %in% c("Peres_P1_150163  3D_[44113,18531].tif", 
                           "Peres_P1_43004 A2_[45654,5840].tif",
                           "Peres_P1_43773 D2_[60849,15244].tif", 
                         "Peres_P1_AACES 130033_[37754,17929].tif",
                         "Peres_P1_AACES 130033_[38351,13944].tif"
                           )) %>% 
  group_by(pair_id) %>% 
  mutate(have_a_match = dense_rank(interaction(suid, pair_id))) %>% 
  group_by(pair_id) %>% 
  mutate(is_paired = max(have_a_match)) %>% 
  filter(is_paired == 2) %>% 
  select(pair_id, everything(), -c(is_paired, have_a_match)) %>% 
  ungroup()

# markers_match <- readRDS("/Users/colinccm/Documents/GitHub/Peres/IF_AACES_NCOCS/markers_match.rds")
path <- fs::path("","Volumes","Peres_Research","Christelle Colin-Leitzinger", "IF_AACES_NCOCS", "Disparities manuscript", "Figures")
```
<br>
<br>

***

```{r summarize mean}
markers_ROI <- readRDS("/Users/colinccm/Documents/GitHub/Peres/IF_AACES_NCOCS/markers_ROI.rds")
```


# Table 3. Adjusted hazard ratios and 95% confidence intervals
The count of cells double stained (for example CD3+CD8+) **ARE** subtracted from the single stain count (CD3 alone and CD8 alone) to avoid overlapping if we want to use them to cluster.  

## 1% group- absence /presence
## Whole population
### Intra
### Overall
```{r}
markers_ROI_o <- markers_ROI %>% 
  rename(CD3 = CD3_total.i, CD3_CD8 = CD3_CD8_total.i,
         CD3_FoxP3 = CD3_FoxP3_total.i, 
         CD11b = CD11b_total.i, CD11b_CD15 = CD11b_CD15_total.i)
  
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_o)  %>% 
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_o) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_o) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_o) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_o) %>%
  cox.zph()
                 
```

### Tumor

```{r}
markers_ROI_t <- markers_ROI %>% 
  rename(CD3 = CD3_tumor.i, CD3_CD8 = CD3_CD8_tumor.i,
         CD3_FoxP3 = CD3_FoxP3_tumor.i, 
         CD11b = CD11b_tumor.i, CD11b_CD15 = CD11b_CD15_tumor.i)
  
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_t)  %>% 
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_t) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_t) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_t) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_t) %>%
  cox.zph()
                 
```

### Stroma

```{r}
markers_ROI_s <- markers_ROI %>% 
  rename(CD3 = CD3_stroma.i, CD3_CD8 = CD3_CD8_stroma.i,
         CD3_FoxP3 = CD3_FoxP3_stroma.i, 
         CD11b = CD11b_stroma.i, CD11b_CD15 = CD11b_CD15_stroma.i)

coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_s) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_s) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_s) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_s) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_s) %>%
  cox.zph()
                 

```

## Periph
### Overall
```{r}
markers_ROI_o <- markers_ROI %>% 
  rename(CD3 = CD3_total.p, CD3_CD8 = CD3_CD8_total.p,
         CD3_FoxP3 = CD3_FoxP3_total.p, 
         CD11b = CD11b_total.p, CD11b_CD15 = CD11b_CD15_total.p)
  
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_o)  %>% 
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_o) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_o) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_o) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_o) %>%
  cox.zph()
                 
```

### Tumor
```{r}
markers_ROI_t <- markers_ROI %>% 
  rename(CD3 = CD3_tumor.p, CD3_CD8 = CD3_CD8_tumor.p,
         CD3_FoxP3 = CD3_FoxP3_tumor.p, 
         CD11b = CD11b_tumor.p, CD11b_CD15 = CD11b_CD15_tumor.p)
  
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_t)  %>% 
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_t) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_t) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_t) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_t) %>%
  cox.zph()
                 
```

### Stroma
```{r}
markers_ROI_s <- markers_ROI %>% 
  rename(CD3 = CD3_stroma.p, CD3_CD8 = CD3_CD8_stroma.p,
         CD3_FoxP3 = CD3_FoxP3_stroma.p, 
         CD11b = CD11b_stroma.p, CD11b_CD15 = CD11b_CD15_stroma.p)

coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3 + stage + refage + race, data =  markers_ROI_s) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3_CD8 + stage + refage + race, data =  markers_ROI_s) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD3_FoxP3 + stage + refage + race, data =  markers_ROI_s) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD11b + stage + refage + race, data =  markers_ROI_s) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ CD11b_CD15 + stage + refage + race, data =  markers_ROI_s) %>%
  cox.zph()
                 


```


# Table 3b. Adjusted hazard ratios and 95% confidence intervals (**include each 3 values and use the cluster option**)
The doubled stained cell count are not removed from the single stained count.

```{r create group per sampleon ROI_global}
ROI_global <- ROI_global %>% 
  
  mutate(CD3_tumor = case_when(
    
    tumor_percent_cd3_opal_650_positive_cells <= 1      ~ "low",
    tumor_percent_cd3_opal_650_positive_cells > 1       ~ "high"
  ), CD3_tumor = factor(CD3_tumor, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_tumor = case_when(
    tumor_percent_cd3plus_cd8plus_positive_cells <= 1      ~ "low",
    tumor_percent_cd3plus_cd8plus_positive_cells > 1       ~ "high"
  ), CD3_CD8_tumor = factor(CD3_CD8_tumor, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_tumor = case_when(
    tumor_percent_cd3plus_foxp3plus_positive_cells <= 1      ~ "low",
    tumor_percent_cd3plus_foxp3plus_positive_cells > 1       ~ "high"
  ), CD3_FoxP3_tumor = factor(CD3_FoxP3_tumor, levels = c("low","high"))) %>% 
  mutate(CD11b_tumor = case_when(
    tumor_percent_cd11b_opal_620_positive_cells == 0      ~ "Absence",
    tumor_percent_cd11b_opal_620_positive_cells > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_tumor = case_when(
    tumor_percent_cd15_opal_520_positive_cells == 0      ~ "Absence",
    tumor_percent_cd15_opal_520_positive_cells > 0       ~ "Presence"
  )) %>% 
  
  mutate(CD3_stroma = case_when(
    stroma_percent_cd3_opal_650_positive_cells <= 1      ~ "low",
    stroma_percent_cd3_opal_650_positive_cells > 1       ~ "high"
  ), CD3_stroma = factor(CD3_stroma, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_stroma = case_when(
    stroma_percent_cd3plus_cd8plus_positive_cells <= 1      ~ "low",
    stroma_percent_cd3plus_cd8plus_positive_cells > 1       ~ "high"
  ), CD3_CD8_stroma = factor(CD3_CD8_stroma, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_stroma = case_when(
    stroma_percent_cd3plus_foxp3plus_positive_cells <= 1      ~ "low",
    stroma_percent_cd3plus_foxp3plus_positive_cells > 1       ~ "high"
  ), CD3_FoxP3_stroma = factor(CD3_FoxP3_stroma, levels = c("low","high"))) %>% 
  mutate(CD11b_stroma = case_when(
    stroma_percent_cd11b_opal_620_positive_cells == 0      ~ "Absence",
    stroma_percent_cd11b_opal_620_positive_cells > 0       ~ "Presence"
  )) %>%
  mutate(CD11b_CD15_stroma = case_when(
    stroma_percent_cd11bplus_cd15plus_positive_cells == 0      ~ "Absence",
    stroma_percent_cd11bplus_cd15plus_positive_cells > 0       ~ "Presence"
  )) %>% 
  
  mutate(CD3_total = case_when(
    percent_cd3_opal_650_positive_cells <= 1      ~ "low",
    percent_cd3_opal_650_positive_cells > 1       ~ "high"
  ), CD3_total = factor(CD3_total, levels = c("low","high"))) %>% 
  mutate(CD3_CD8_total = case_when(
    percent_cd3plus_cd8plus_positive_cells <= 1      ~ "low",
    percent_cd3plus_cd8plus_positive_cells > 1       ~ "high"
  ), CD3_CD8_total = factor(CD3_CD8_total, levels = c("low","high"))) %>% 
  mutate(CD3_FoxP3_total = case_when(
    percent_cd3plus_foxp3plus_positive_cells <= 1      ~ "low",
    percent_cd3plus_foxp3plus_positive_cells > 1       ~ "high"
  ), CD3_FoxP3_total = factor(CD3_FoxP3_total, levels = c("low","high"))) %>% 
  mutate(CD11b_total = case_when(
    percent_cd11b_opal_620_positive_cells == 0      ~ "Absence",
    percent_cd11b_opal_620_positive_cells > 0       ~ "Presence"
  )) %>% 
  mutate(CD11b_CD15_total = case_when(
    percent_cd11bplus_cd15plus_positive_cells == 0      ~ "Absence",
    percent_cd11bplus_cd15plus_positive_cells > 0       ~ "Presence"
  )) 

```

## Intra
### Overall
```{r Table % cluster option}
markers_ROIclust_o <- ROI_global %>%
  filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  rename(CD3 = CD3_total, CD3_CD8 = CD3_CD8_total,
         CD3_FoxP3 = CD3_FoxP3_total, 
         CD11b = CD11b_total, CD11b_CD15 = CD11b_CD15_total)
  
coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_o)  %>% 
  cox.zph()
                 
coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3_CD8 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_o) %>%
  cox.zph()

# coxph(Surv(time = markers_ROIclust_o$timeint_fu,
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + stage + refage + race, cluster = suid, data =  markers_ROIclust_o) %>%
#   cox.zph()
                 
coxph(Surv(time = markers_ROIclust_o$timeint_fu,
                   event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_o) %>%
  cox.zph()
               
# newdata <- survSplit(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + stage + refage + race, id = "suid", data = markers_ROIclust_o, cut=1700, episode='tgroup')   
# 
# coxph(Surv(time = newdata$tstart, newdata$tstop,
#                    event = newdata$event) ~ CD3_FoxP3:strata(tgroup) + strata(stage) + refage + race, cluster = suid, data =  newdata) %>%
#   cox.zph()

coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_o) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b_CD15 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_o) %>%
  cox.zph()
                 
```

```{r}
clin_surv <- markers_ROIclust_o
mysurv <- Surv(time = clin_surv$timeint_fu, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_FoxP3)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "", 
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           # xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```

### Tumor
```{r}
markers_ROIclust_t <- ROI_global %>% 
    filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  rename(CD3 = CD3_tumor, CD3_CD8 = CD3_CD8_tumor,
         CD3_FoxP3 = CD3_FoxP3_tumor, 
         CD11b = CD11b_tumor, CD11b_CD15 = CD11b_CD15_tumor)
  
coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_t)  %>% 
  cox.zph()
                 
coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3_CD8 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_t) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROIclust_t$timeint_fu,
                   event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_t) %>%
  cox.zph()
                
newdata <- survSplit(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + stage + refage + race, id = "suid", data = markers_ROIclust_t, cut=1700, episode='tgroup')   

coxph(Surv(time = newdata$tstart, newdata$tstop,
                   event = newdata$event) ~ CD3_FoxP3:strata(tgroup) + strata(stage) + refage + race, cluster = suid, data =  newdata) %>%
  cox.zph()

coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_t) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b_CD15 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_t) %>%
  cox.zph()

```

```{r}
clin_surv <- markers_ROIclust_t
mysurv <- Surv(time = clin_surv$timeint_fu, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_FoxP3)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "", 
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           # xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```

### Stroma
```{r}
markers_ROIclust_s <- ROI_global %>% 
    filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral") %>% 
  rename(CD3 = CD3_stroma, CD3_CD8 = CD3_CD8_stroma,
         CD3_FoxP3 = CD3_FoxP3_stroma, 
         CD11b = CD11b_stroma, CD11b_CD15 = CD11b_CD15_stroma)

coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_s) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3_CD8 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_s) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROIclust_s$timeint_fu,
                   event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_s) %>%
  cox.zph()
                 
newdata <- survSplit(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + stage + refage + race, id = "suid", data = markers_ROIclust_s, cut=1700, episode='tgroup')   

coxph(Surv(time = newdata$tstart, newdata$tstop,
                   event = newdata$event) ~ CD3_FoxP3:strata(tgroup) + strata(stage) + refage + race, cluster = suid, data =  newdata) %>%
  cox.zph()


coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_s) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b_CD15 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_s) %>%
  cox.zph()
                 
```

```{r}
clin_surv <- markers_ROIclust_s
mysurv <- Surv(time = clin_surv$timeint_fu, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_FoxP3)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "", 
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           # xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```

## Periph
### Overall
```{r}
markers_ROIclust_o <- ROI_global %>% 
    filter(intratumoral_i_vs_peripheral_p_ == "Peripheral") %>% 
  rename(CD3 = CD3_total, CD3_CD8 = CD3_CD8_total,
         CD3_FoxP3 = CD3_FoxP3_total, 
         CD11b = CD11b_total, CD11b_CD15 = CD11b_CD15_total)
  
coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_o)  %>% 
  cox.zph()
                 
coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3_CD8 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_o) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROIclust_o$timeint_fu,
                   event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_o) %>%
  cox.zph()
        
newdata <- survSplit(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + stage + refage + race, id = "suid", data = markers_ROIclust_o, cut=1700, episode='tgroup')   

coxph(Surv(time = newdata$tstart, newdata$tstop,
                   event = newdata$event) ~ CD3_FoxP3:strata(tgroup) + strata(stage) + refage + race, cluster = suid, data =  newdata) %>%
  cox.zph()

coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_o) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
                   event = markers_ROIclust_o$surv_vital) ~ CD11b_CD15 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_o) %>%
  cox.zph()
```

```{r}
clin_surv <- markers_ROIclust_o
mysurv <- Surv(time = clin_surv$timeint_fu, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_FoxP3)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "", 
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           # xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```

### Tumor
```{r}
markers_ROIclust_t <- ROI_global %>% 
      filter(intratumoral_i_vs_peripheral_p_ == "Peripheral") %>% 
  rename(CD3 = CD3_tumor, CD3_CD8 = CD3_CD8_tumor,
         CD3_FoxP3 = CD3_FoxP3_tumor, 
         CD11b = CD11b_tumor, CD11b_CD15 = CD11b_CD15_tumor)
  
coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_t)  %>% 
  cox.zph()
                 
coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3_CD8 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_t) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROIclust_t$timeint_fu,
                   event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_t) %>%
  cox.zph()

newdata <- survSplit(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + stage + refage + race, id = "suid", data = markers_ROIclust_t, cut=1700, episode='tgroup')   

coxph(Surv(time = newdata$tstart, newdata$tstop,
                   event = newdata$event) ~ CD3_FoxP3:strata(tgroup) + strata(stage) + refage + race, cluster = suid, data =  newdata) %>%
  cox.zph()

                 
coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_t) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
                   event = markers_ROIclust_t$surv_vital) ~ CD11b_CD15 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_t) %>%
  cox.zph()
```

```{r}
clin_surv <- markers_ROIclust_t
mysurv <- Surv(time = clin_surv$timeint_fu, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_FoxP3)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "", 
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           # xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```

### Stroma
```{r}
markers_ROIclust_s <- ROI_global %>% 
      filter(intratumoral_i_vs_peripheral_p_ == "Peripheral") %>% 
  rename(CD3 = CD3_stroma, CD3_CD8 = CD3_CD8_stroma,
         CD3_FoxP3 = CD3_FoxP3_stroma, 
         CD11b = CD11b_stroma, CD11b_CD15 = CD11b_CD15_stroma)

coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_s) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3_CD8 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_s) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROIclust_s$timeint_fu,
                   event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_s) %>%
  cox.zph()
               
newdata <- survSplit(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + stage + refage + race, id = "suid", data = markers_ROIclust_s, cut=1700, episode='tgroup')   

coxph(Surv(time = newdata$tstart, newdata$tstop,
                   event = newdata$event) ~ CD3_FoxP3:strata(tgroup) + strata(stage) + refage + race, cluster = suid, data =  newdata) %>%
  cox.zph()

coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_s) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
                   event = markers_ROIclust_s$surv_vital) ~ CD11b_CD15 + refage + race + strata(stage), cluster = suid, data =  markers_ROIclust_s) %>%
  cox.zph()
```

```{r}
clin_surv <- markers_ROIclust_s
mysurv <- Surv(time = clin_surv$timeint_fu, event = clin_surv$surv_vital)
myplot <- survfit(mysurv~clin_surv$CD3_FoxP3)

# pdf(paste0(path, "/Survivals/Immune cell clusters/OS CD3 grp matched pop.pdf"), width = 8, height = 7)
ggsurvplot(myplot, data = clin_surv,
           title = "Survival analysis on matched population",
           font.main = c(14, "bold", "black"), font.subtitle = c(6, "plain", "black"),
           xlab = "Time (days)", legend.title = "", 
           # legend.labs = c("high", "low"),
           pval = TRUE,
           conf.int = FALSE,
           # xlim = c(-10, 8000),
           # Add risk table
           tables.height = 0.3,
           risk.table.title = "Risk table (number(%))",
           risk.table = "abs_pct",
           risk.table.y.text = FALSE,
           risk.table.fontsize = 4,
           tables.theme = theme_survminer(base_size = 5,
                                          font.main = c(16, "bold", "black"),
                                          font.x = c(14, "bold", "black"),
                                          font.y = c(16, "bold", "transparent"),
                                          font.tickslab = c(14, "bold", "black"))
)
```

<!-- ## In White (I can bind W/B later if you want them side by side) -->
```{r Table % cluster option white}
# markers_ROIclust_o <- ROI_global %>%
#   filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral" & race == "White") %>% 
#   rename(CD3 = CD3_total, CD3_CD8 = CD3_CD8_total,
#          CD3_FoxP3 = CD3_FoxP3_total, 
#          CD11b = CD11b_total, CD11b_CD15 = CD11b_CD15_total)
#   
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_o)  %>% 
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   cox.zph()
#                  
# 
# tbl10 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))
# 
# markers_ROIclust_t <- ROI_global %>% 
#     filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral" & race == "White") %>% 
#   rename(CD3 = CD3_tumor, CD3_CD8 = CD3_CD8_tumor,
#          CD3_FoxP3 = CD3_FoxP3_tumor, 
#          CD11b = CD11b_tumor, CD11b_CD15 = CD11b_CD15_tumor)
#   
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_t)  %>% 
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   cox.zph()
#                  
# 
# tbl11 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))
# 
# markers_ROIclust_s <- ROI_global %>% 
#     filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral" & race == "White") %>% 
#   rename(CD3 = CD3_stroma, CD3_CD8 = CD3_CD8_stroma,
#          CD3_FoxP3 = CD3_FoxP3_stroma, 
#          CD11b = CD11b_stroma, CD11b_CD15 = CD11b_CD15_stroma)
# 
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# 
# tbl12 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))
# # tbl13 <- tbl_merge(list(tbl10, tbl11, tbl12), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))
# 
# 
# 
# markers_ROIclust_o <- ROI_global %>% 
#     filter(intratumoral_i_vs_peripheral_p_ == "Peripheral" & race == "White") %>% 
#   rename(CD3 = CD3_total, CD3_CD8 = CD3_CD8_total,
#          CD3_FoxP3 = CD3_FoxP3_total, 
#          CD11b = CD11b_total, CD11b_CD15 = CD11b_CD15_total)
#   
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_o)  %>% 
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   cox.zph()
#                  
# 
# tbl13 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))
# 
# markers_ROIclust_t <- ROI_global %>% 
#       filter(intratumoral_i_vs_peripheral_p_ == "Peripheral" & race == "White") %>% 
#   rename(CD3 = CD3_tumor, CD3_CD8 = CD3_CD8_tumor,
#          CD3_FoxP3 = CD3_FoxP3_tumor, 
#          CD11b = CD11b_tumor, CD11b_CD15 = CD11b_CD15_tumor)
#   
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_t)  %>% 
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   cox.zph()
#                  
# 
# tbl14 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))
# 
# markers_ROIclust_s <- ROI_global %>% 
#       filter(intratumoral_i_vs_peripheral_p_ == "Peripheral" & race == "White") %>% 
#   rename(CD3 = CD3_stroma, CD3_CD8 = CD3_CD8_stroma,
#          CD3_FoxP3 = CD3_FoxP3_stroma, 
#          CD11b = CD11b_stroma, CD11b_CD15 = CD11b_CD15_stroma)
# 
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# 
# tbl15 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))
# # tbl14 <- tbl_merge(list(tbl13, tbl14, tbl15), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))
```

<!-- ## Overall -->
```{r}
# tbl16 <- tbl_stack(list(tbl10, tbl13), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
# tbl16
# # gt::gtsave(tbl16, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Overall ROIs cluster option.pdf"))
```

<!-- ## Tumor -->
```{r}
# tbl17 <- tbl_stack(list(tbl11, tbl14), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
# tbl17
# # gt::gtsave(tbl17, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Tumor ROIs cluster option.pdf"))
```

<!-- ## Stroma -->
```{r}
# tbl18 <- tbl_stack(list(tbl12, tbl15), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
# tbl18
# # gt::gtsave(tbl18, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Stroma ROIs cluster option.pdf"))
```

<!-- ## In Black -->
```{r Table % cluster option black}
# markers_ROIclust_o <- ROI_global %>%
#   filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral" & race == "Black") %>% 
#   rename(CD3 = CD3_total, CD3_CD8 = CD3_CD8_total,
#          CD3_FoxP3 = CD3_FoxP3_total, 
#          CD11b = CD11b_total, CD11b_CD15 = CD11b_CD15_total)
#   
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_o)  %>% 
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   cox.zph()
#                  
# 
# tbl10 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))
# 
# markers_ROIclust_t <- ROI_global %>% 
#     filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral" & race == "Black") %>% 
#   rename(CD3 = CD3_tumor, CD3_CD8 = CD3_CD8_tumor,
#          CD3_FoxP3 = CD3_FoxP3_tumor, 
#          CD11b = CD11b_tumor, CD11b_CD15 = CD11b_CD15_tumor)
#   
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_t)  %>% 
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   cox.zph()
#                  
# 
# tbl11 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))
# 
# markers_ROIclust_s <- ROI_global %>% 
#     filter(intratumoral_i_vs_peripheral_p_ == "Intratumoral" & race == "Black") %>% 
#   rename(CD3 = CD3_stroma, CD3_CD8 = CD3_CD8_stroma,
#          CD3_FoxP3 = CD3_FoxP3_stroma, 
#          CD11b = CD11b_stroma, CD11b_CD15 = CD11b_CD15_stroma)
# 
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# 
# tbl12 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))
# # tbl13 <- tbl_merge(list(tbl10, tbl11, tbl12), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))
# 
# 
# 
# markers_ROIclust_o <- ROI_global %>% 
#     filter(intratumoral_i_vs_peripheral_p_ == "Peripheral" & race == "Black") %>% 
#   rename(CD3 = CD3_total, CD3_CD8 = CD3_CD8_total,
#          CD3_FoxP3 = CD3_FoxP3_total, 
#          CD11b = CD11b_total, CD11b_CD15 = CD11b_CD15_total)
#   
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_o)  %>% 
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_o$timeint_fu, 
#                    event = markers_ROIclust_o$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_o) %>%
#   cox.zph()
#                  
# 
# tbl13 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))
# 
# markers_ROIclust_t <- ROI_global %>% 
#       filter(intratumoral_i_vs_peripheral_p_ == "Peripheral" & race == "Black") %>% 
#   rename(CD3 = CD3_tumor, CD3_CD8 = CD3_CD8_tumor,
#          CD3_FoxP3 = CD3_FoxP3_tumor, 
#          CD11b = CD11b_tumor, CD11b_CD15 = CD11b_CD15_tumor)
#   
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_t)  %>% 
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_t$timeint_fu, 
#                    event = markers_ROIclust_t$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_t) %>%
#   cox.zph()
#                  
# 
# tbl14 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))
# 
# markers_ROIclust_s <- ROI_global %>% 
#       filter(intratumoral_i_vs_peripheral_p_ == "Peripheral" & race == "Black") %>% 
#   rename(CD3 = CD3_stroma, CD3_CD8 = CD3_CD8_stroma,
#          CD3_FoxP3 = CD3_FoxP3_stroma, 
#          CD11b = CD11b_stroma, CD11b_CD15 = CD11b_CD15_stroma)
# 
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3_CD8 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD3_FoxP3 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD11b + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# coxph(Surv(time = markers_ROIclust_s$timeint_fu, 
#                    event = markers_ROIclust_s$surv_vital) ~ CD11b_CD15 + stage + refage, cluster = suid, data =  markers_ROIclust_s) %>%
#   cox.zph()
#                  
# 
# tbl15 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5))
# # tbl14 <- tbl_merge(list(tbl13, tbl14, tbl15), tab_spanner = c("**Overall**", "**Tumor**", "**Stroma**"))
```

<!-- ## Overall -->
```{r}
# tbl16 <- tbl_stack(list(tbl10, tbl13), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
# tbl16
# # gt::gtsave(tbl16, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Overall ROIs cluster option.pdf"))
```

<!-- ## Tumor -->
```{r}
# tbl17 <- tbl_stack(list(tbl11, tbl14), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
# tbl17
# # gt::gtsave(tbl17, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Tumor ROIs cluster option.pdf"))
```

<!-- ## Stroma -->
```{r}
# tbl18 <- tbl_stack(list(tbl12, tbl15), group_header = c("Intratumoral", "Peripheral")) %>% as_gt()
# tbl18
# # gt::gtsave(tbl18, paste0(path, "/Table 3. Adjusted hazard ratios and 95% confidence intervals in Stroma ROIs cluster option.pdf"))
```
<br>

# HR Cluster
`r emo::ji("pad")` Note to remember. The cluster were built on the data with the averaged measurement. I am not using the cluster option in the coxph even though I saw a really slight change in CI values but not in p value.  
The doubled stained cell count are not removed from the single stained count.

## Overall
```{r Table HR cluster}
  
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ clusters_all_IandP + stage + refage + race, data =  markers_ROI)  %>% 
  cox.zph()
            
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ dbl_pos + stage + refage + race, data =  markers_ROI) %>%
  cox.zph()
                 
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ clusters_CD3CD8 + stage + refage + race, data =  markers_ROI) %>%
  cox.zph()
                
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ clusters_CD3FoxP3 + stage + refage + race, data =  markers_ROI) %>%
  cox.zph()
                
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ clusters_FoxP3_ + stage + refage + race, data =  markers_ROI) %>%
  cox.zph()
                
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ clusters_CD11bCD15 + stage + refage + race, data =  markers_ROI) %>%
  cox.zph()
```

<!-- ## In White (I can bind W/B if you want them side by side) -->
```{r Table HR white}
# markers_ROI_white <- markers_ROI %>%
#   filter(race == "White")
#   
# coxph(Surv(time = markers_ROI_white$timeint_fu, 
#                    event = markers_ROI_white$surv_vital) ~ clusters_all_IandP + stage + refage, data =  markers_ROI_white)  %>% 
#   cox.zph()
#                  include = clusters_all_IandP) 
# coxph(Surv(time = markers_ROI_white$timeint_fu, 
#                    event = markers_ROI_white$surv_vital) ~ dbl_pos + stage + refage, data =  markers_ROI_white) %>%
#   cox.zph()
#                  include = dbl_pos) 
# coxph(Surv(time = markers_ROI_white$timeint_fu, 
#                    event = markers_ROI_white$surv_vital) ~ clusters_CD3CD8 + stage + refage, data =  markers_ROI_white) %>%
#   cox.zph()
#                  include = clusters_CD3CD8) 
# coxph(Surv(time = markers_ROI_white$timeint_fu, 
#                    event = markers_ROI_white$surv_vital) ~ clusters_CD3FoxP3 + stage + refage, data =  markers_ROI_white) %>%
#   cox.zph()
#                  include = clusters_CD3FoxP3) 
# coxph(Surv(time = markers_ROI_white$timeint_fu, 
#                    event = markers_ROI_white$surv_vital) ~ clusters_FoxP3_ + stage + refage, data =  markers_ROI_white) %>%
#   cox.zph()
#                  include = clusters_FoxP3_) 
# coxph(Surv(time = markers_ROI_white$timeint_fu, 
#                    event = markers_ROI_white$surv_vital) ~ clusters_CD11bCD15 + stage + refage, data =  markers_ROI_white) %>%
#   cox.zph()
#                  include = clusters_CD11bCD15) 
# 
# tbl10 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5, tbl6))
# tbl10
```

<!-- ## In Black -->
```{r Table cluster black}
# markers_ROI_black <- markers_ROI %>%
#   filter(race == "Black")
#   
# coxph(Surv(time = markers_ROI_black$timeint_fu, 
#                    event = markers_ROI_black$surv_vital) ~ clusters_all_IandP + stage + refage, data =  markers_ROI_black)  %>% 
#   cox.zph()
#                  include = clusters_all_IandP) 
# coxph(Surv(time = markers_ROI_black$timeint_fu, 
#                    event = markers_ROI_black$surv_vital) ~ dbl_pos + stage + refage, data =  markers_ROI_black) %>%
#   cox.zph()
#                  include = dbl_pos) 
# coxph(Surv(time = markers_ROI_black$timeint_fu, 
#                    event = markers_ROI_black$surv_vital) ~ clusters_CD3CD8 + stage + refage, data =  markers_ROI_black) %>%
#   cox.zph()
#                  include = clusters_CD3CD8) 
# coxph(Surv(time = markers_ROI_black$timeint_fu, 
#                    event = markers_ROI_black$surv_vital) ~ clusters_CD3FoxP3 + stage + refage, data =  markers_ROI_black) %>%
#   cox.zph()
#                  include = clusters_CD3FoxP3) 
# coxph(Surv(time = markers_ROI_black$timeint_fu, 
#                    event = markers_ROI_black$surv_vital) ~ clusters_FoxP3_ + stage + refage, data =  markers_ROI_black) %>%
#   cox.zph()
#                  include = clusters_FoxP3_) 
# coxph(Surv(time = markers_ROI_black$timeint_fu, 
#                    event = markers_ROI_black$surv_vital) ~ clusters_CD11bCD15 + stage + refage, data =  markers_ROI_black) %>%
#   cox.zph()
#                  include = clusters_CD11bCD15) 
# 
# tbl10 <- tbl_stack(list(tbl1, tbl2, tbl3, tbl4, tbl5, tbl6))
# tbl10
```
<br>

# HR immunoscore
`r emo::ji("pad")` Note to remember. The immunoscore were built on the data with the averaged measurement. I am not using the cluster option in the coxph even though I saw a really slight change in CI and p value.  
The doubled stained cell count are not removed from the single stained count for Immunoscore.
## Overall
```{r Table HR Immunoscore}
  
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ immunoscore_patients + stage + refage + race, data =  markers_ROI)  %>% 
  cox.zph()
coxph(Surv(time = markers_ROI$timeint_fu, 
                   event = markers_ROI$surv_vital) ~ immunoscore_2018lancet_patients + stage + refage + race, data =  markers_ROI) %>%
  cox.zph()
```

<!-- ## In White (I can bind W/B if you want them side by side) -->
```{r Table HR Immunoscore white}
# markers_ROI_white <- markers_ROI %>%
#   filter(race == "White")
#   
# coxph(Surv(time = markers_ROI_white$timeint_fu, 
#                    event = markers_ROI_white$surv_vital) ~ immunoscore_patients + stage + refage, data =  markers_ROI_white)  %>% 
#   cox.zph()
#                  include = immunoscore_patients) 
# coxph(Surv(time = markers_ROI_white$timeint_fu, 
#                    event = markers_ROI_white$surv_vital) ~ immunoscore_2018lancet_patients + stage + refage, data =  markers_ROI_white) %>%
#   cox.zph()
#                  include = immunoscore_2018lancet_patients) 
# 
# tbl10 <- tbl_stack(list(tbl1, tbl2))
# tbl10
```

<!-- ## In Black -->
```{r Table HR Immunoscore black}
# markers_ROI_black <- markers_ROI %>%
#   filter(race == "Black")
#   
# coxph(Surv(time = markers_ROI_black$timeint_fu, 
#                    event = markers_ROI_black$surv_vital) ~ immunoscore_patients + stage + refage, data =  markers_ROI_black)  %>% 
#   cox.zph()
#                  include = immunoscore_patients) 
# coxph(Surv(time = markers_ROI_black$timeint_fu, 
#                    event = markers_ROI_black$surv_vital) ~ immunoscore_2018lancet_patients + stage + refage, data =  markers_ROI_black) %>%
#   cox.zph()
#                  include = immunoscore_2018lancet_patients) 
# 
# tbl10 <- tbl_stack(list(tbl1, tbl2))
# tbl10
```
<br>




```











